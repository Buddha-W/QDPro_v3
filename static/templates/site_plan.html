<!DOCTYPE html>
<html>
<head>
    <title>QDPro Site Plan</title>
    <link rel="stylesheet" href="https://unpkg.com/leaflet@1.9.4/dist/leaflet.css"/>
    <link rel="stylesheet" href="https://unpkg.com/leaflet-draw@1.0.4/dist/leaflet.draw.css"/>
    <style>
        #map { height: 100vh; }
        .analysis-panel {
            position: absolute;
            top: 10px;
            right: 10px;
            z-index: 1000;
            background: white;
            padding: 10px;
            border-radius: 4px;
            box-shadow: 0 0 10px rgba(0,0,0,0.1);
        }
        .uncertainty-band { opacity: 0.3; }
    </style>
</head>
<body>
    <!-- TOP NAV BAR -->
    <nav class="main-toolbar">
        <div class="menu-item" onclick="toggleMenu(this, 'fileMenu')">File
            <div class="menu-dropdown" id="fileMenu">
                <div class="menu-dropdown-item" onclick="showNewLocationModal()">New Location</div>
                <div class="menu-dropdown-item" onclick="showSwitchLocationModal()">Switch Location</div>
                <div class="menu-dropdown-item" onclick="alert('Save to DB not implemented');">Save</div>
            </div>
        </div>
        <div class="menu-item" onclick="toggleMenu(this, 'editMenu')">Edit
            <div class="menu-dropdown" id="editMenu">
                <div class="menu-dropdown-item">Cut</div>
                <div class="menu-dropdown-item">Copy</div>
                <div class="menu-dropdown-item">Paste</div>
            </div>
        </div>
        <div class="menu-item" onclick="toggleMenu(this, 'viewMenu')">View
            <div class="menu-dropdown" id="viewMenu">
                <div class="menu-dropdown-item">Layers</div>
                <div class="menu-dropdown-item">Base Maps</div>
            </div>
        </div>
        <div class="menu-item" onclick="toggleMenu(this, 'toolsMenu')">Tools
            <div class="menu-dropdown" id="toolsMenu">
                <div class="menu-dropdown-item">QD Calculator</div>
                <div class="menu-dropdown-item">Measure</div>
            </div>
        </div>
        <div class="menu-item" onclick="toggleMenu(this, 'helpMenu')">Help
            <div class="menu-dropdown" id="helpMenu">
                <div class="menu-dropdown-item">Documentation</div>
                <div class="menu-dropdown-item">About</div>
            </div>
        </div>
        <div id="dbStatus">No location selected</div>
    </nav>

    <!-- SECOND TOOLBAR -->
    <div class="toolbar">
        <div class="tool-group">
            <button id="toggleLayersPanel" class="tool-button" title="Toggle Layers Panel">
                <i class="fas fa-bars"></i>
            </button>
            <button id="baseLayerTool" class="tool-button" title="Base Layers">
                <i class="fas fa-layer-group"></i>
            </button>
        </div>
        <div class="tool-group">
            <button id="selectTool" class="tool-button" title="Select Features">
                <i class="fas fa-mouse-pointer"></i>
            </button>
            <button id="panTool" class="tool-button active" title="Pan Map">
                <i class="fas fa-hand-paper"></i>
            </button>
        </div>
        <div class="tool-group">
            <button id="drawMarker" class="tool-button" title="Add Point">
                <i class="fas fa-map-marker-alt"></i>
            </button>
            <button id="drawPolygon" class="tool-button" title="Draw Polygon">
                <i class="fas fa-draw-polygon"></i>
            </button>
            <button id="drawRectangle" class="tool-button" title="Draw Rectangle">
                <i class="fas fa-square"></i>
            </button>
            <button id="drawCircle" class="tool-button" title="Draw Circle">
                <i class="fas fa-circle"></i>
            </button>
            <button id="drawPolyline" class="tool-button" title="Draw Line">
                <i class="fas fa-minus"></i>
            </button>
        </div>
    </div>

    <!-- LEFT PANEL -->
    <div class="left-panel" id="leftPanel">
        <div class="panel-header">Layers Panel</div>
        <div class="panel-content">
            <div class="layer-select-container">
                <label for="drawToLayer"><strong>Draw to Layer:</strong></label>
                <select id="drawToLayer" style="width: 100%; margin-top: 5px; padding: 5px;"></select>
                <button onclick="showAddLayerModal()" style="margin-top: 10px; width: 100%;">
                    Add New Layer
                </button>
            </div>
            <div id="layerControl" style="margin-top:20px;"></div>
        </div>
    </div>

    <!-- BASE LAYER DROPDOWN -->
    <div id="baseLayerDropdown" class="base-layer-dropdown"></div>

    <div id="map"></div>
    <div class="analysis-panel">
        <h3>QD Analysis</h3>
        <input type="number" id="explosive-quantity" placeholder="Explosive Quantity (lbs)"/>
        <button onclick="runMonteCarloAnalysis()">Analyze</button>
        <div id="analysis-results"></div>
    </div>

    <!-- MODALS: New Location, Switch Location, Add Layer -->

    <!-- New Location Modal -->
    <div id="newLocationModal" class="modal-overlay">
        <div class="modal-content">
            <h2>Create New Location</h2>
            <input type="text" id="newLocationName" placeholder="Enter location name"/>
            <div style="text-align:right;">
                <button onclick="closeNewLocationModal()" style="margin-right:10px;">Cancel</button>
                <button onclick="createNewLocation()">Create</button>
            </div>
        </div>
    </div>

    <!-- Switch Location Modal -->
    <div id="switchLocationModal" class="modal-overlay">
        <div class="modal-content">
            <h2>Switch Location</h2>
            <div id="locationList" style="margin:10px 0; max-height:200px; overflow-y:auto;">
                <!-- We'll fill this with JS -->
            </div>
            <div style="text-align:right;">
                <button onclick="closeSwitchLocationModal()">Close</button>
            </div>
        </div>
    </div>

    <!-- Add Layer Modal -->
    <div id="addLayerModal" class="modal-overlay">
        <div class="modal-content">
            <h2>Add New Layer</h2>
            <input type="text" id="newLayerName" placeholder="Layer Name"/>
            <select id="newLayerType">
                <option value="facility">Facility</option>
                <option value="boundary">Boundary</option>
            </select>
            <div style="text-align:right;">
                <button onclick="closeAddLayerModal()" style="margin-right:10px;">Cancel</button>
                <button onclick="createNewLayer()">Create</button>
            </div>
        </div>
    </div>

    <script src="https://unpkg.com/leaflet@1.9.4/dist/leaflet.js"></script>
    <script src="https://unpkg.com/leaflet-draw@1.0.4/dist/leaflet.draw.js"></script>
    <script>
        const map = L.map('map').setView([39.8283, -98.5795], 4);
        L.tileLayer('https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png').addTo(map);

        const drawnItems = new L.FeatureGroup();
        map.addLayer(drawnItems);

        const drawControl = new L.Control.Draw({
            draw: {
                polygon: false,
                circle: {
                    shapeOptions: {
                        color: '#662d91'
                    }
                },
                marker: {
                    icon: L.icon({
                        iconUrl: 'https://raw.githubusercontent.com/pointhi/leaflet-color-markers/master/img/marker-icon-2x-red.png',
                        iconSize: [25, 41],
                        iconAnchor: [12, 41]
                    })
                },
                circlemarker: false,
                rectangle: false,
                polyline: false
            },
            edit: {
                featureGroup: drawnItems
            }
        });
        map.addControl(drawControl);

        map.on('draw:created', async function(e) {
            const layer = e.layer;
            drawnItems.addLayer(layer);

            if (e.layerType === 'marker') {
                const quantity = document.getElementById('explosive-quantity').value;
                if (!quantity) {
                    alert('Please enter explosive quantity');
                    return;
                }

                try {
                    const response = await fetch('/api/analyze_qd', {
                        method: 'POST',
                        headers: {
                            'Content-Type': 'application/json'
                        },
                        body: JSON.stringify({
                            quantity: parseFloat(quantity),
                            location: [layer.getLatLng().lng, layer.getLatLng().lat],
                            site_type: 'DOD',
                            material_props: {
                                sensitivity: 1.0,
                                det_velocity: 6000,
                                tnt_equiv: 1.0
                            },
                            env_conditions: {
                                temperature: 298,
                                pressure: 101.325,
                                humidity: 50,
                                confinement_factor: 0
                            }
                        })
                    });

                    const data = await response.json();

                    // Add buffer zones
                    L.geoJSON(data.geojson, {
                        style: (feature) => ({
                            color: feature.properties.k_factor === 1.0 ? '#ff0000' : '#662d91',
                            weight: 2,
                            opacity: feature.properties.isUncertaintyBand ? 0.3 : 0.8
                        })
                    }).addTo(drawnItems);

                    // Display results
                    document.getElementById('analysis-results').innerHTML = `
                        <p>Mean Safe Distance: ${data.safe_distance.toFixed(2)} ft</p>
                        <p>Standard Deviation: ${data.std_deviation.toFixed(2)} ft</p>
                        <p>95% CI: [${data.confidence_interval[0].toFixed(2)}, 
                                  ${data.confidence_interval[1].toFixed(2)}] ft</p>
                    `;
                } catch (error) {
                    console.error('Analysis failed:', error);
                    alert('Analysis failed: ' + error.message);
                }
            }
        });


        /************************************************************
         * Minimal toggleMenu function for top nav
         ************************************************************/
        window.toggleMenu = function(element, menuId) {
            const dropdown = document.getElementById(menuId);
            if (!dropdown) {
                console.error("Menu dropdown not found:", menuId);
                return;
            }
            // Close other menus
            document.querySelectorAll(".menu-dropdown").forEach(dd => {
                if (dd.id !== menuId) {
                    dd.style.display = "none";
                    dd.parentElement.classList.remove("active");
                }
            });
            // Toggle this menu
            const isVisible = dropdown.style.display === "block";
            dropdown.style.display = isVisible ? "none" : "block";
            element.classList.toggle("active", !isVisible);
            // Position dropdown
            if (!isVisible) {
                const rect = element.getBoundingClientRect();
                dropdown.style.position = "fixed";
                dropdown.style.top = rect.bottom + "px";
                dropdown.style.left = rect.left + "px";
                dropdown.style.zIndex = "3500";
            }
        };

        // Modal management functions
        function showNewLocationModal() {
            document.getElementById("newLocationModal").classList.add("visible");
        }

        function closeNewLocationModal() {
            document.getElementById("newLocationModal").classList.remove("visible");
            document.getElementById("newLocationName").value = "";
        }

        function showSwitchLocationModal() {
            document.getElementById("switchLocationModal").classList.add("visible");
        }

        function closeSwitchLocationModal() {
            document.getElementById("switchLocationModal").classList.remove("visible");
        }

        function showAddLayerModal() {
            document.getElementById("addLayerModal").classList.add("visible");
        }

        function closeAddLayerModal() {
            document.getElementById("addLayerModal").classList.remove("visible");
            document.getElementById("newLayerName").value = "";
        }

        async function createNewLayer() {
            const name = document.getElementById("newLayerName").value.trim();
            const type = document.getElementById("newLayerType").value;

            if (!name) {
                alert("Please enter a layer name");
                return;
            }

            if (QDPro.layers[name]) {
                alert("Layer name already exists");
                return;
            }

            const newLayer = L.featureGroup().addTo(QDPro.map);
            newLayer.properties = { type: type };
            QDPro.layers[name] = newLayer;
            QDPro.activeLayer = newLayer;
            QDPro.updateDrawToLayerSelect();
            closeAddLayerModal();
        }

        document.addEventListener("DOMContentLoaded", () => {
            console.log("DOM Content Loaded – let's init QDPro!");
            QDPro.init();
        });
    </script>
</body>
</html>