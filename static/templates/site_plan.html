<!DOCTYPE html>
<html>
<head>
    <title>QDPro Site Planner</title>
    <link rel="stylesheet" href="https://unpkg.com/leaflet@1.9.4/dist/leaflet.css" crossorigin=""/>
    <link rel="stylesheet" href="https://unpkg.com/leaflet-draw@1.0.4/dist/leaflet.draw.css" crossorigin=""/>
    <script src="https://unpkg.com/leaflet@1.9.4/dist/leaflet.js" crossorigin=""></script>
    <script src="https://unpkg.com/leaflet-draw@1.0.4/dist/leaflet.draw.js" crossorigin=""></script>
    <style>
        body { margin: 0; padding: 0; }
        #toolbar {
            position: fixed;
            top: 0;
            width: 100%;
            background: #333;
            padding: 10px;
            z-index: 1000;
        }
        #toolbar button {
            margin: 0 5px;
            padding: 8px 15px;
            background: #4CAF50;
            color: white;
            border: none;
            border-radius: 4px;
            cursor: pointer;
        }
        #toolbar button:hover {
            background: #45a049;
        }
        #map {
            height: calc(100vh - 50px);
            margin-top: 50px;
        }
        .form-popup {
            display: none;
            position: fixed;
            top: 50%;
            left: 50%;
            transform: translate(-50%, -50%);
            background: white;
            padding: 20px;
            border-radius: 8px;
            box-shadow: 0 0 10px rgba(0,0,0,0.2);
            z-index: 1001;
        }
        .status-panel {
            margin: 1rem;
            padding: 1rem;
            background: #f5f5f5;
            border-radius: 4px;
        }
        #status {
            padding: 0.5rem;
            margin-top: 0.5rem;
            border-radius: 4px;
            display: none;
        }

    </style>
</head>
<body>
    <div id="toolbar">
        <select id="orgSelector" onchange="switchOrganization()">
            <option value="dod">Department of Defense</option>
            <option value="doe">Department of Energy</option>
        </select>
        <select id="areaSelector" onchange="switchArea()">
            <option value="">Select Area...</option>
        </select>
        <button onclick="showAddFacility()">Add Facility</button>
        <button onclick="showAddExplosiveSite()">Add Explosive Site</button>
        <button onclick="generateReport()">Generate Report</button>
        <button onclick="toggleESQD()">Toggle ESQD</button>
        <button onclick="showAnalysis()">Analysis</button>
        <button onclick="showCompliance()">Compliance</button>
        <button onclick="toggleDrawing()">Draw Area</button>
        <button onclick="finishDrawing()" id="finishBtn" style="display:none">Finish Drawing</button>
    </div>

    <div id="map"></div>

    <div id="facilityForm" class="form-popup">
        <h3>Add New Facility</h3>
        <form id="newFacilityForm">
            <input type="text" id="facilityNumber" placeholder="Facility Number" required><br>
            <input type="text" id="description" placeholder="Description" required><br>
            <input type="text" id="categoryCode" placeholder="Category Code" required><br>
            <input type="number" id="latitude" placeholder="Latitude" step="any" required><br>
            <input type="number" id="longitude" placeholder="Longitude" step="any" required><br>
            <button type="submit">Submit</button>
            <button type="button" onclick="hideAddFacility()">Cancel</button>
        </form>
    </div>

    <div class="status-panel">
        <h3>System Status</h3>
        <div id="status"></div>
        <div id="facilityCount">Loading facilities...</div>
    </div>


    <script>
        let map;
        let markers = [];
        let drawingMode = false;
        let drawnPoints = [];
        let drawnLayer = null;
        let areaPolygon = null;

        const areasByOrg = {
            dod: ['Army', 'Navy', 'Air Force', 'Marines', 'Space Force'],
            doe: ['NNSA', 'Science', 'Environmental Management', 'Nuclear Energy']
        };

        function switchOrganization() {
            const org = document.getElementById('orgSelector').value;
            const areaSelect = document.getElementById('areaSelector');
            areaSelect.innerHTML = '<option value="">Select Area...</option>';
            areasByOrg[org].forEach(area => {
                areaSelect.innerHTML += `<option value="${area}">${area}</option>`;
            });
        }

        function toggleDrawing() {
            drawingMode = !drawingMode;
            if (drawingMode) {
                map.on('click', addDrawPoint);
                document.getElementById('finishBtn').style.display = 'inline';
            } else {
                map.off('click', addDrawPoint);
                document.getElementById('finishBtn').style.display = 'none';
            }
        }

        function addDrawPoint(e) {
            const point = [e.latlng.lat, e.latlng.lng];
            drawnPoints.push(point);
            
            if (drawnLayer) {
                map.removeLayer(drawnLayer);
            }
            
            if (drawnPoints.length > 2) {
                drawnLayer = L.polygon(drawnPoints, {color: 'red'}).addTo(map);
            } else if (drawnPoints.length > 1) {
                drawnLayer = L.polyline(drawnPoints, {color: 'red'}).addTo(map);
            }
            
            L.marker(point).addTo(map)
                .bindPopup(`Point ${drawnPoints.length}: [${point[0].toFixed(6)}, ${point[1].toFixed(6)}]`);
        }

        function finishDrawing() {
            if (drawnPoints.length < 3) {
                alert('Please select at least 3 points to create an area');
                return;
            }
            
            drawingMode = false;
            map.off('click', addDrawPoint);
            document.getElementById('finishBtn').style.display = 'none';
            
            // Store polygon for analysis
            areaPolygon = drawnPoints;
            
            // Display coordinates
            const coordsList = drawnPoints.map((p, i) => 
                `Point ${i + 1}: [${p[0].toFixed(6)}, ${p[1].toFixed(6)}]`
            ).join('\n');
            
            alert('Area created with coordinates:\n' + coordsList);
        }

        function initMap() {
            try {
                if (!map) {
                    map = L.map('map', {
                        center: [38.889484, -77.035278],
                        zoom: 13,
                        minZoom: 3,
                        maxZoom: 18,
                        layers: []
                    });

                    // Base layers
                    const osm = L.tileLayer('https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png', {
                        attribution: '© OpenStreetMap contributors'
                    });

                    const googleSat = L.tileLayer('http://{s}.google.com/vt/lyrs=s&x={x}&y={y}&z={z}', {
                        maxZoom: 20,
                        subdomains: ['mt0', 'mt1', 'mt2', 'mt3'],
                        attribution: '© Google'
                    });

                    const googleStreets = L.tileLayer('http://{s}.google.com/vt/lyrs=m&x={x}&y={y}&z={z}', {
                        maxZoom: 20,
                        subdomains: ['mt0', 'mt1', 'mt2', 'mt3'],
                        attribution: '© Google'
                    });

                    // Overlay layers
                    const drawnItems = new L.FeatureGroup();
                    const facilitiesLayer = new L.FeatureGroup();
                    const esqdLayer = new L.FeatureGroup();

                    // Add base layers to map
                    const baseLayers = {
                        "OpenStreetMap": osm,
                        "Google Satellite": googleSat,
                        "Google Streets": googleStreets
                    };

                    // Add overlay layers
                    const overlays = {
                        "Drawn Shapes": drawnItems,
                        "Facilities": facilitiesLayer,
                        "ESQD Arcs": esqdLayer
                    };

                    // Add layer control
                    L.control.layers(baseLayers, overlays).addTo(map);
                    
                    // Add draw control
                    const drawControl = new L.Control.Draw({
                        draw: {
                            polygon: true,
                            polyline: true,
                            rectangle: true,
                            circle: true,
                            marker: true
                        },
                        edit: {
                            featureGroup: drawnItems
                        }
                    });
                    map.addControl(drawControl);

                    // Add default layer
                    osm.addTo(map);
                    drawnItems.addTo(map);
                    facilitiesLayer.addTo(map);
                    esqdLayer.addTo(map);

                    // Handle drawing events
                    map.on('draw:created', function(e) {
                        const layer = e.layer;
                        drawnItems.addLayer(layer);
                        const coords = layer.getLatLngs();
                        console.log('Shape coordinates:', coords);
                    });

                    console.log("Map initialized successfully");
                    showStatus('Map loaded successfully', 'success');
                }
            } catch (error) {
                console.error("Map initialization error:", error);
                showStatus('Error initializing map: ' + error.message, 'error');
            }
        }

        async function loadFacilityReports() {
            try {
                showStatus('Loading facilities...', 'info');
                const response = await fetch('/reports/facilities');
                const data = await response.json();

                clearMarkers();

                if (data.data && data.data.facilities) {
                    data.data.facilities.forEach(facility => {
                        const location = JSON.parse(facility.location);
                        const marker = L.marker([location.coordinates[1], location.coordinates[0]])
                            .bindPopup(`
                                <strong>Facility ${facility.facility_number}</strong><br>
                                ${facility.description}<br>
                                Category: ${facility.category_code}
                            `);
                        markers.push(marker);
                        marker.addTo(map);
                    });
                    document.getElementById('facilityCount').textContent =
                        `${data.data.facilities.length} facilities found`;
                    showStatus('Facilities loaded successfully', 'success');
                }
            } catch (error) {
                showStatus('Error loading facilities: ' + error.message, 'error');
            }
        }

        function clearMarkers() {
            markers.forEach(marker => map.removeLayer(marker));
            markers = [];
        }

        function showStatus(message, type) {
            const status = document.getElementById('status');
            status.style.display = 'block';
            status.style.backgroundColor = type === 'success' ? '#d4edda' :
                                             type === 'error' ? '#f8d7da' : '#e3f2fd';
            status.style.color = type === 'success' ? '#155724' :
                                   type === 'error' ? '#721c24' : '#004085';
            status.textContent = message;
            setTimeout(() => status.style.display = 'none', 3000);
        }

        // Initialize map and load facilities when page loads
        document.addEventListener('DOMContentLoaded', () => {
            initMap();
            loadFacilityReports();
        });

        async function loadSafetyAnalysis() {
            showStatus('Loading safety analysis...', 'info');
            try {
                const response = await fetch('/reports/safety');
                const data = await response.json();
                // Implement safety visualization here
                showStatus('Safety analysis loaded', 'success');
            } catch (error) {
                showStatus('Error loading safety analysis', 'error');
            }
        }

        async function calculateESQD() {
            showStatus('Calculating ESQD...', 'info');
            try {
                const response = await fetch('/calculate-esqd/1'); // Example site ID
                const data = await response.json();
                // Implement ESQD visualization here
                showStatus('ESQD calculation complete', 'success');
            } catch (error) {
                showStatus('Error calculating ESQD', 'error');
            }
        }

        async function runComplianceCheck() {
            showStatus('Running compliance check...', 'info');
            try {
                const response = await fetch('/compliance-check/1'); // Example site ID
                const data = await response.json();
                showStatus('Compliance check complete', 'success');
            } catch (error) {
                showStatus('Error running compliance check', 'error');
            }
        }

        function showAddFacility() {
            document.getElementById('facilityForm').style.display = 'block';
        }

        function hideAddFacility() {
            document.getElementById('facilityForm').style.display = 'none';
        }

        document.getElementById('newFacilityForm').onsubmit = async (e) => {
            e.preventDefault();
            const formData = {
                facility_number: document.getElementById('facilityNumber').value,
                description: document.getElementById('description').value,
                category_code: document.getElementById('categoryCode').value,
                latitude: parseFloat(document.getElementById('latitude').value),
                longitude: parseFloat(document.getElementById('longitude').value)
            };

            try {
                const response = await fetch('/facilities/', {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json',
                    },
                    body: JSON.stringify(formData)
                });

                if (response.ok) {
                    const result = await response.json();
                    L.marker([formData.latitude, formData.longitude])
                        .addTo(map)
                        .bindPopup(`Facility: ${formData.facility_number}`);
                    hideAddFacility();
                    alert('Facility added successfully!');
                } else {
                    alert('Failed to add facility');
                }
            } catch (error) {
                console.error('Error:', error);
                alert('Error adding facility');
            }
        };

        function showAnalysis() {
            // Implement analysis view
            alert('Analysis feature coming soon');
        }

        function showCompliance() {
            // Implement compliance view
            alert('Compliance feature coming soon');
        }

        function generateReport() {
            // Implement report generation
            alert('Report generation coming soon');
        }

        function toggleESQD() {
            // Implement ESQD toggle
            alert('ESQD toggle coming soon');
        }

        function showAddExplosiveSite() {
            // Implement explosive site form
            alert('Add explosive site feature coming soon');
        }

        // Get user's location
        if (navigator.geolocation) {
            navigator.geolocation.getCurrentPosition((position) => {
                map.setView([position.coords.latitude, position.coords.longitude], 13);
            });
        }
    </script>
</body>
</html>