<!DOCTYPE html>
<html>
<head>
  <title>QDPro â€“ Full Modal Example</title>
  <!-- Leaflet CSS -->
  <link rel="stylesheet" href="https://unpkg.com/leaflet@1.9.4/dist/leaflet.css" crossorigin="anonymous"/>
  <!-- Leaflet.draw CSS -->
  <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/leaflet.draw/1.0.4/leaflet.draw.css" crossorigin="anonymous"/>
  <!-- Font Awesome -->
  <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/5.15.4/css/all.min.css" crossorigin="anonymous"/>
  <!-- Leaflet and Leaflet.draw JS -->
  <script src="https://unpkg.com/leaflet@1.9.4/dist/leaflet.js" crossorigin="anonymous"></script>
  <script src="https://cdnjs.cloudflare.com/ajax/libs/leaflet.draw/1.0.4/leaflet.draw.js" crossorigin="anonymous"></script>
  <style>
    /* BASIC RESET & BODY */
    * { margin: 0; padding: 0; box-sizing: border-box; }
    body { font-family: Arial, sans-serif; height: 100vh; overflow: hidden; }
    /* TOP NAV BAR */
    nav.main-toolbar {
      position: fixed; top: 0; left: 0; right: 0;
      height: 40px; background: #f1f1f1; border-bottom: 1px solid #ccc;
      display: flex; align-items: center; z-index: 3000; padding: 0 10px;
      white-space: nowrap;
    }
    .menu-item {
      padding: 0 15px; font-size: 14px; display: flex; align-items: center;
      cursor: pointer; position: relative;
    }
    .menu-item:hover { background: #e9ecef; }
    .menu-dropdown {
      display: none; position: fixed; background: white; min-width: 150px;
      border: 1px solid #ccc; border-radius: 4px; z-index: 3500;
    }
    .menu-dropdown-item { padding: 8px 12px; font-size: 14px; cursor: pointer; }
    .menu-dropdown-item:hover { background: #f0f0f0; }
    #dbStatus { margin-left: auto; }
    /* SECOND TOOLBAR (Drawing) */
    .toolbar {
      position: fixed; top: 40px; left: 0; right: 0;
      height: 40px; background: #fff; border-bottom: 1px solid #ccc;
      display: flex; align-items: center; z-index: 2900; padding: 0 10px;
    }
    .tool-group { display: flex; align-items: center; margin-right: 10px; }
    .tool-button {
      padding: 6px; margin: 0 2px; border: 1px solid transparent;
      border-radius: 3px; background: #fff; color: #666; cursor: pointer;
      display: flex; align-items: center; justify-content: center;
      min-width: 32px; height: 32px;
    }
    .tool-button:hover { background: #f0f0f0; border-color: #ccc; }
    .tool-button.active { background: #e6f2ff; border-color: #99ccff; color: #0066cc; }
    /* MAP (Below 2 Toolbars => top: 80px) */
    #map {
      position: fixed; top: 80px; left: 0; right: 0; bottom: 0;
      z-index: 1000; background: #eee;
    }
    /* LEFT PANEL */
    .left-panel {
      position: fixed; top: 80px; left: 0; width: 300px;
      height: calc(100vh - 80px); background: white; border-right: 1px solid #ccc;
      transform: translateX(-300px); transition: transform 0.3s ease; z-index: 1500;
      display: flex; flex-direction: column;
    }
    .left-panel.visible { transform: translateX(0); }
    .panel-header {
      padding: 15px; background: #f8f9fa; border-bottom: 1px solid #ccc; font-weight: bold;
    }
    .panel-content { padding: 15px; flex-grow: 1; overflow-y: auto; }
    /* BASE LAYER DROPDOWN */
    .base-layer-dropdown {
      position: fixed; background: white; padding: 10px; border: 1px solid #ccc;
      border-radius: 4px; box-shadow: 0 2px 4px rgba(0,0,0,0.1);
      z-index: 2800; display: none;
    }
    /* MODALS */
    .modal-overlay {
      display: none; position: fixed; z-index: 4000; left: 0; top: 0;
      width: 100%; height: 100%; background: rgba(0,0,0,0.4);
      align-items: center; justify-content: center;
    }
    .modal-overlay.visible { display: flex; }
    .modal-content {
      background: #fff; padding: 20px; border: 1px solid #888;
      width: 80%; max-width: 500px;
    }
    .modal-content h2 { margin-bottom: 15px; }
    .modal-content input, .modal-content select, .modal-content textarea {
      width: 100%; padding: 5px; margin-top: 5px; margin-bottom: 10px;
    }
    .modal-content button { margin: 5px; }
  </style>
</head>
<body>
  <!-- TOP NAV BAR -->
  <nav class="main-toolbar">
    <div class="menu-item" onclick="toggleMenu(this, 'fileMenu')">File
      <div class="menu-dropdown" id="fileMenu">
        <div class="menu-dropdown-item" onclick="showNewLocationModal()">New Location</div>
        <div class="menu-dropdown-item" onclick="showSwitchLocationModal()">Switch Location</div>
        <div class="menu-dropdown-item" onclick="saveProject()">Save Project</div>
        <div class="menu-dropdown-item" onclick="loadProject()">Load Project</div>
      </div>
    </div>
    <div class="menu-item" onclick="toggleMenu(this, 'editMenu')">Edit
      <div class="menu-dropdown" id="editMenu">
        <div class="menu-dropdown-item">Cut</div>
        <div class="menu-dropdown-item">Copy</div>
        <div class="menu-dropdown-item">Paste</div>
      </div>
    </div>
    <div class="menu-item" onclick="toggleMenu(this, 'viewMenu')">View
      <div class="menu-dropdown" id="viewMenu">
        <div class="menu-dropdown-item">Layers</div>
        <div class="menu-dropdown-item">Base Maps</div>
      </div>
    </div>
    <div class="menu-item" onclick="toggleMenu(this, 'toolsMenu')">Tools
      <div class="menu-dropdown" id="toolsMenu">
        <div class="menu-dropdown-item">QD Calculator</div>
        <div class="menu-dropdown-item">Measure</div>
      </div>
    </div>
    <div class="menu-item" onclick="toggleMenu(this, 'helpMenu')">Help
      <div class="menu-dropdown" id="helpMenu">
        <div class="menu-dropdown-item">Documentation</div>
        <div class="menu-dropdown-item">About</div>
      </div>
    </div>
    <div id="dbStatus">No location selected</div>
  </nav>

  <!-- SECOND TOOLBAR -->
  <div class="toolbar">
    <div class="tool-group">
      <button id="toggleLayersPanel" class="tool-button" title="Toggle Layers Panel">
        <i class="fas fa-bars"></i>
      </button>
      <button id="baseLayerTool" class="tool-button" title="Base Layers">
        <i class="fas fa-layer-group"></i>
      </button>
    </div>
    <!-- Zoom Buttons Group -->
    <div class="tool-group">
      <button id="zoomInBtn" class="tool-button" title="Zoom In">
        <i class="fas fa-search-plus"></i>
      </button>
      <button id="zoomOutBtn" class="tool-button" title="Zoom Out">
        <i class="fas fa-search-minus"></i>
      </button>
    </div>
    <div class="tool-group">
      <button id="selectTool" class="tool-button" title="Select Features">
        <i class="fas fa-mouse-pointer"></i>
      </button>
      <button id="panTool" class="tool-button active" title="Pan Map">
        <i class="fas fa-hand-paper"></i>
      </button>
    </div>
    <div class="tool-group">
      <button id="drawMarker" class="tool-button" title="Add Point">
        <i class="fas fa-map-marker-alt"></i>
      </button>
      <button id="drawPolygon" class="tool-button" title="Draw Polygon">
        <i class="fas fa-draw-polygon"></i>
      </button>
      <button id="drawRectangle" class="tool-button" title="Draw Rectangle">
        <i class="fas fa-square"></i>
      </button>
      <button id="drawCircle" class="tool-button" title="Draw Circle">
        <i class="fas fa-circle"></i>
      </button>
      <button id="drawPolyline" class="tool-button" title="Draw Line">
        <i class="fas fa-minus"></i>
      </button>
    </div>
  </div>

  <!-- LEFT PANEL -->
  <div class="left-panel" id="leftPanel">
    <div class="panel-header">Layers Panel</div>
    <div class="panel-content">
      <div class="layer-select-container">
        <label for="drawToLayer"><strong>Draw to Layer:</strong></label>
        <select id="drawToLayer" style="width: 100%; margin-top: 5px; padding: 5px;"></select>
        <button onclick="showAddLayerModal()" style="margin-top: 10px; width: 100%;">Add New Layer</button>
      </div>
      <div id="layerControl" style="margin-top:20px;"></div>
    </div>
  </div>

  <!-- BASE LAYER DROPDOWN -->
  <div id="baseLayerDropdown" class="base-layer-dropdown"></div>

  <!-- MAP -->
  <div id="map"></div>

  <!-- MODALS: New Location, Switch Location, Add Layer -->
  <!-- New Location Modal -->
  <div id="newLocationModal" class="modal-overlay">
    <div class="modal-content">
      <h2>Create New Location</h2>
      <input type="text" id="newLocationName" placeholder="Enter location name"/>
      <div style="text-align:right;">
        <button onclick="closeNewLocationModal()" style="margin-right:10px;">Cancel</button>
        <button onclick="createNewLocation()">Create</button>
      </div>
    </div>
  </div>
  <!-- Switch Location Modal -->
  <div id="switchLocationModal" class="modal-overlay">
    <div class="modal-content">
      <h2>Switch Location</h2>
      <div id="locationList" style="margin:10px 0; max-height:200px; overflow-y:auto;"></div>
      <div style="text-align:right;">
        <button onclick="closeSwitchLocationModal()">Close</button>
      </div>
    </div>
  </div>
  <!-- Add Layer Modal -->
  <div id="addLayerModal" class="modal-overlay">
    <div class="modal-content">
      <h2>Add New Layer</h2>
      <input type="text" id="newLayerName" placeholder="Layer Name"/>
      <select id="newLayerType">
        <option value="facility">Facility</option>
        <option value="boundary">Boundary</option>
      </select>
      <div style="text-align:right;">
        <button onclick="closeAddLayerModal()" style="margin-right:10px;">Cancel</button>
        <button onclick="createNewLayer()">Create</button>
      </div>
    </div>
  </div>

  <script>
    /************************************************************
     * Minimal toggleMenu function for top nav
     ************************************************************/
    window.toggleMenu = function(element, menuId) {
      const dropdown = document.getElementById(menuId);
      if (!dropdown) {
        console.error("Menu dropdown not found:", menuId);
        return;
      }
      document.querySelectorAll(".menu-dropdown").forEach(dd => {
        if (dd.id !== menuId) {
          dd.style.display = "none";
          dd.parentElement.classList.remove("active");
        }
      });
      const isVisible = dropdown.style.display === "block";
      dropdown.style.display = isVisible ? "none" : "block";
      element.classList.toggle("active", !isVisible);
      if (!isVisible) {
        const rect = element.getBoundingClientRect();
        dropdown.style.position = "fixed";
        dropdown.style.top = rect.bottom + "px";
        dropdown.style.left = rect.left + "px";
        dropdown.style.zIndex = "3500";
      }
    };

    /************************************************************
     * QDPro Object: Handles map, layers, drawing, modals, and persistence.
     * Auto-saves project state on drawing, layer creation, and location change.
     ************************************************************/
    const QDPro = {
      map: null,
      layers: {},
      activeLayer: null,
      drawTools: {},
      baseLayers: {},
      currentBaseLayer: null,
      // For demonstration, a fake location array; new locations get pushed here.
      mockLocations: [
        { id: 1, name: "Location A", created_at: "2023-01-01" },
        { id: 2, name: "Location B", created_at: "2023-02-15" }
      ],
      init: function() {
        console.log("Initializing QDPro...");

        // Initialize the map with zoomControl disabled
        this.map = L.map("map", {
          center: [39.8283, -98.5795],
          zoom: 4,
          zoomControl: false
        });

        // Set up base layers
        this.baseLayers = {
          "OSM": L.tileLayer("https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png", { attribution: "Â© OpenStreetMap contributors" }),
          "Satellite": L.tileLayer("https://server.arcgisonline.com/ArcGIS/rest/services/World_Imagery/MapServer/tile/{z}/{y}/{x}", { attribution: "Tiles Â© Esri" }),
          "Topographic": L.tileLayer("https://{s}.tile.opentopomap.org/{z}/{x}/{y}.png", { attribution: "Map data: Â© OpenStreetMap contributors" })
        };
        this.currentBaseLayer = this.baseLayers.OSM;
        this.currentBaseLayer.addTo(this.map);

        // Create default layer group for drawing and persistence
        this.activeLayer = L.featureGroup().addTo(this.map);
        this.layers["Default"] = this.activeLayer;

        // Set up draw tools
        this.setupDrawTools();

        // Set up left panel toggle
        const leftPanel = document.getElementById("leftPanel");
        const mapElement = document.getElementById("map");
        document.getElementById("toggleLayersPanel").addEventListener("click", () => {
          leftPanel.classList.toggle("visible");
          if (leftPanel.classList.contains("visible")) {
            mapElement.style.left = "300px";
            mapElement.style.width = "calc(100% - 300px)";
          } else {
            mapElement.style.left = "0";
            mapElement.style.width = "100%";
          }
          this.map.invalidateSize();
        });

        // Set up base layer tool button
        document.getElementById("baseLayerTool").addEventListener("click", () => this.toggleBaseLayerDropdown());

        // Set up zoom buttons
        document.getElementById("zoomInBtn").addEventListener("click", () => { this.map.zoomIn(); });
        document.getElementById("zoomOutBtn").addEventListener("click", () => { this.map.zoomOut(); });

        // Update "Draw to Layer" dropdown
        this.updateDrawToLayerSelect();

        // Auto-load project on init
        this.loadProject();

        console.log("QDPro init complete. Map should be visible now.");
      },

      setupDrawTools: function() {
        const drawOptions = { shapeOptions: { color: "#3388ff" } };
        // Store draw tool instances for reuse
        this.drawTools = {
          polygon: new L.Draw.Polygon(this.map, {
            allowIntersection: false, showArea: true,
            drawError: { color: "#e1e100", timeout: 1000 },
            shapeOptions: { color: "#3388ff" }
          }),
          polyline: new L.Draw.Polyline(this.map, drawOptions),
          rectangle: new L.Draw.Rectangle(this.map, drawOptions),
          circle: new L.Draw.Circle(this.map, drawOptions),
          marker: new L.Draw.Marker(this.map)
        };

        // Listen for shape creation
        this.map.on("draw:created", (e) => {
          console.log("draw:created event fired", e);
          const layer = e.layer;
          if (e.layerType === "polygon") {
            const coords = layer.getLatLngs()[0];
            if (coords.length > 0 && !coords[0].equals(coords[coords.length - 1])) {
              coords.push(coords[0]);
              layer.setLatLngs(coords);
            }
            const polyType = prompt("Enter polygon type (PES or ES):", "PES");
            if (polyType) {
              layer.feature = layer.toGeoJSON();
              layer.feature.properties.type = polyType;
            }
          }
          this.activeLayer.addLayer(layer);
          console.log("Shape added to active layer:", layer);
          this.deactivateAllTools();
          this.saveProject(); // Auto-save after drawing
        });
      },

      activateTool: function(toolName, buttonId) {
        this.deactivateAllTools();
        if (this.drawTools[toolName]) {
          this.drawTools[toolName].enable();
          document.getElementById(buttonId).classList.add("active");
        }
      },

      deactivateAllTools: function() {
        for (const tool in this.drawTools) {
          this.drawTools[tool].disable();
        }
        document.querySelectorAll(".tool-button").forEach(btn => btn.classList.remove("active"));
        document.getElementById("panTool").classList.add("active");
      },

      updateDrawToLayerSelect: function() {
        const select = document.getElementById("drawToLayer");
        select.innerHTML = "";
        Object.keys(this.layers).forEach(layerName => {
          const opt = document.createElement("option");
          opt.value = layerName;
          opt.textContent = layerName;
          select.appendChild(opt);
        });
        select.addEventListener("change", (e) => {
          const selected = e.target.value;
          this.activeLayer = this.layers[selected];
          console.log("Active layer changed to:", selected);
          this.saveProject(); // Auto-save on layer change
        });
      },

      toggleBaseLayerDropdown: function() {
        const dropdown = document.getElementById("baseLayerDropdown");
        if (dropdown.style.display === "block") {
          dropdown.style.display = "none";
        } else {
          dropdown.innerHTML = "";
          for (const name in this.baseLayers) {
            const div = document.createElement("div");
            div.textContent = name;
            div.style.cursor = "pointer";
            div.style.padding = "5px";
            div.addEventListener("click", () => {
              this.switchBaseLayer(name);
              dropdown.style.display = "none";
              this.saveProject(); // Auto-save on base layer change
            });
            dropdown.appendChild(div);
          }
          const btn = document.getElementById("baseLayerTool");
          const rect = btn.getBoundingClientRect();
          dropdown.style.display = "block";
          dropdown.style.top = rect.bottom + "px";
          dropdown.style.left = rect.left + "px";
          dropdown.style.zIndex = "2800";
        }
      },

      switchBaseLayer: function(name) {
        if (this.currentBaseLayer) this.map.removeLayer(this.currentBaseLayer);
        this.currentBaseLayer = this.baseLayers[name];
        this.currentBaseLayer.addTo(this.map);
      },

      showAddLayerModal: function() {
        document.getElementById("addLayerModal").classList.add("visible");
      },
      closeAddLayerModal: function() {
        document.getElementById("addLayerModal").classList.remove("visible");
        document.getElementById("newLayerName").value = "";
      },
      createNewLayer: function() {
        const layerName = document.getElementById("newLayerName").value.trim();
        const layerType = document.getElementById("newLayerType").value;
        if (!layerName) {
          alert("Please enter a layer name");
          return;
        }
        if (this.layers[layerName]) {
          alert(`Layer "${layerName}" already exists`);
          return;
        }
        const newLayer = L.featureGroup().addTo(this.map);
        newLayer.properties = { type: layerType };
        this.layers[layerName] = newLayer;
        this.activeLayer = newLayer;
        this.updateDrawToLayerSelect();
        this.closeAddLayerModal();
        console.log(`Created new layer: ${layerName}, type: ${layerType}`);
        this.saveProject(); // Auto-save on new layer creation
      },

      showNewLocationModal: function() {
        document.getElementById("newLocationModal").classList.add("visible");
      },
      closeNewLocationModal: function() {
        document.getElementById("newLocationModal").classList.remove("visible");
      },
      createNewLocation: function() {
        const locName = document.getElementById("newLocationName").value.trim();
        if (!locName) {
          alert("Please enter a location name");
          return;
        }
        this.currentLocation = locName;
        document.getElementById("dbStatus").textContent = `Location: ${locName}`;
        // Add new location to mockLocations so it appears when switching
        const newLoc = { id: Date.now(), name: locName, created_at: new Date().toISOString() };
        this.mockLocations.push(newLoc);
        // Reset layers for new location
        Object.values(this.layers).forEach(layer => { this.map.removeLayer(layer); });
        this.layers = {};
        this.activeLayer = L.featureGroup().addTo(this.map);
        this.layers["Default"] = this.activeLayer;
        this.updateDrawToLayerSelect();
        this.closeNewLocationModal();
        console.log("Created new location:", locName);
        this.saveProject(); // Auto-save new location state
      },

      showSwitchLocationModal: function() {
        document.getElementById("switchLocationModal").classList.add("visible");
        const locationList = document.getElementById("locationList");
        locationList.innerHTML = "";
        this.mockLocations.forEach(loc => {
          const div = document.createElement("div");
          div.style.padding = "10px";
          div.style.borderBottom = "1px solid #eee";
          div.style.cursor = "pointer";
          div.textContent = `${loc.name} (Created: ${new Date(loc.created_at).toLocaleString()})`;
          div.addEventListener("click", () => { this.switchToLocation(loc); });
          locationList.appendChild(div);
        });
      },
      closeSwitchLocationModal: function() {
        document.getElementById("switchLocationModal").classList.remove("visible");
      },
      switchToLocation: function(locObj) {
        console.log("Switching to location:", locObj);
        // Clear current layers
        Object.values(this.layers).forEach(layer => this.map.removeLayer(layer));
        this.layers = {};
        // Create new default layer
        this.activeLayer = L.featureGroup().addTo(this.map);
        this.layers["Default"] = this.activeLayer;
        this.updateDrawToLayerSelect();
        this.currentLocation = locObj.name;
        document.getElementById("dbStatus").textContent = `Location: ${locObj.name}`;
        this.closeSwitchLocationModal();
        this.saveProject(); // Auto-save after switching location
      },

      saveProject: function() {
        let features = [];
        // Iterate over all layers and gather GeoJSON features
        Object.values(this.layers).forEach(layerGroup => {
          layerGroup.eachLayer(layer => {
            if (layer.toGeoJSON) {
              features.push(layer.toGeoJSON());
            }
          });
        });
        const projectData = { features: features };
        fetch('/api/save', {
          method: 'POST',
          headers: { 'Content-Type': 'application/json' },
          body: JSON.stringify(projectData)
        })
        .then(res => res.json())
        .then(data => { console.log("Project saved successfully:", data); })
        .catch(err => { console.error("Auto-save failed:", err); });
      },

      loadProject: function() {
        fetch('/api/load')
        .then(res => res.json())
        .then(data => {
          // Clear all layers
          Object.values(this.layers).forEach(layerGroup => layerGroup.clearLayers());
          if (data.features && data.features.length > 0) {
            const geojsonLayer = L.geoJSON(data, {
              onEachFeature: (feature, layer) => {
                if (feature.properties && feature.properties.type) {
                  layer.bindPopup("Type: " + feature.properties.type);
                }
                this.activeLayer.addLayer(layer);
              }
            });
            if (geojsonLayer.getLayers().length > 0) {
              this.map.fitBounds(geojsonLayer.getBounds());
            }
            console.log("Project loaded successfully.");
          } else {
            console.log("No project data found.");
          }
        })
        .catch(err => { console.error("Load failed:", err); });
      }
    };

    /************************************************************
     * Global functions to expose modal methods and persistence
     ************************************************************/
    function showNewLocationModal() { QDPro.showNewLocationModal(); }
    function closeNewLocationModal() { QDPro.closeNewLocationModal(); }
    function createNewLocation() { QDPro.createNewLocation(); }
    function showSwitchLocationModal() { QDPro.showSwitchLocationModal(); }
    function closeSwitchLocationModal() { QDPro.closeSwitchLocationModal(); }
    function showAddLayerModal() { QDPro.showAddLayerModal(); }
    function closeAddLayerModal() { QDPro.closeAddLayerModal(); }
    function createNewLayer() { QDPro.createNewLayer(); }
    function saveProject() { QDPro.saveProject(); }
    function loadProject() { QDPro.loadProject(); }

    document.addEventListener("DOMContentLoaded", () => { QDPro.init(); });
  </script>
</body>
</html>
