<!DOCTYPE html>
<html>
<head>
  <title>QDPro Site Plan</title>
  <link rel="stylesheet" href="https://unpkg.com/leaflet@1.9.4/dist/leaflet.css" integrity="sha256-p4NxAoJBhIIN+hmNHrzRCf9tD/miZyoHS5obTRR9BMY=" crossorigin="anonymous"/>
  <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/leaflet.draw/1.0.4/leaflet.draw.css" integrity="sha512-gc3xjCmIy673V6MyOAZhIW93xhM9ei1I+gLbmFjUHIjocENRsLX/QUE1htk5q1XV2D/iie/VQ8DXI6Vu8bexvQ==" crossorigin="anonymous"/>
  <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/5.15.4/css/all.min.css" integrity="sha512-1ycn6IcaQQ40/MKBW2W4Rhis/DbILU74C1vSrLJxCq57o941Ym01SwNsOMqvEBFlcgUa6xLiPY/NS5R+E6ztJQ==" crossorigin="anonymous"/>
  <script src="https://unpkg.com/leaflet@1.9.4/dist/leaflet.js" integrity="sha256-20nQCchB9co0qIjJZRGuk2/Z9VM+kNiyxNV1lvTlZBo=" crossorigin="anonymous"></script>
  <script src="https://cdnjs.cloudflare.com/ajax/libs/leaflet.draw/1.0.4/leaflet.draw.js" integrity="sha512-ozq8xQKq6urvuU6jNgkfqAmT7jKN2XumbrX1JiB3TnF7tI48DPI4Gy1GXKD/V3EExgAs1V+pRO7vwtS1LHg0Gw==" crossorigin="anonymous"></script>
  <script src="https://cdn.plot.ly/plotly-2.24.1.min.js"></script>
  <style>
    * {
      margin: 0;
      padding: 0;
      box-sizing: border-box;
    }

    body {
      display: flex;
      flex-direction: column;
      height: 100vh;
      overflow: hidden;
    }

    nav.main-toolbar {
      position: fixed;
      top: 0;
      left: 0;
      right: 0;
      height: 40px;
      background-color: #f1f1f1;
      border-bottom: 1px solid #ccc;
      padding: 0 1rem;
      z-index: 2000;
      display: flex;
      align-items: center;
    }

    .menu-item {
      padding: 0 15px;
      height: 100%;
      display: flex;
      align-items: center;
      cursor: pointer;
      position: relative;
      font-size: 14px;
    }

    .menu-item:hover {
      background: #e9ecef;
    }

    #dbStatus {
      margin-left: auto;
      padding: 0 15px;
      font-size: 14px;
      color: #333;
    }

    .toolbar {
      position: fixed;
      top: 40px;
      left: 0;
      right: 0;
      height: 40px;
      background-color: white;
      border: 1px solid #ccc;
      border-radius: 4px;
      display: flex;
      align-items: center;
      padding: 0 10px;
      z-index: 1800;
      box-shadow: 0 2px 6px rgba(0,0,0,0.1);
      margin-top: 0;
    }

    .tool-group {
      display: flex;
      align-items: center;
      padding: 0 10px;
      border-right: 1px solid #eee;
    }

    .tool-group:last-child {
      border-right: none;
    }

    .tool-button {
      padding: 6px;
      margin: 0 2px;
      border: 1px solid transparent;
      border-radius: 3px;
      background: white;
      color: #666;
      cursor: pointer;
      display: flex;
      align-items: center;
      justify-content: center;
      min-width: 32px;
      height: 32px;
    }

    .tool-button:hover {
      background: #f0f0f0;
      border-color: #ccc;
    }

    .tool-button.active {
      background: #e6f2ff;
      border-color: #99ccff;
      color: #0066cc;
    }

    .tool-button i {
      font-size: 16px;
    }

    #map {
      position: fixed;
      top: 80px;
      left: 0;
      right: 0;
      bottom: 0;
      z-index: 1;
    }
    .leaflet-draw-toolbar {
      margin-top: 0 !important;
    }
    .modal {
      display: none;
      position: fixed;
      z-index: 2000;
      left: 0;
      top: 0;
      width: 100%;
      height: 100%;
      background-color: rgba(0,0,0,0.5);
    }
    .modal-content {
      background-color: #fefefe;
      margin: 15% auto;
      padding: 20px;
      border: 1px solid #888;
      width: 80%;
      max-width: 500px;
      border-radius: 5px;
    }
    .modal-close { color: #aaa; float: right; font-size: 28px; font-weight: bold; cursor: pointer; }
    .modal-close:hover { color: black; }
    .form-group { margin-bottom: 15px; }
    .form-group label { display: block; margin-bottom: 5px; }
    .form-group input,
    .form-group textarea {
      width: 100%;
      padding: 8px;
      border: 1px solid #ddd;
      border-radius: 4px;
    }
    .menu-bar {
      position: fixed;
      top: 0;
      left: 0;
      right: 0;
      height: 40px;
      background: #f8f9fa;
      color: #333;
      display: flex;
      align-items: center;
      z-index: 1500;
      padding: 0;
      border-bottom: 1px solid #dee2e6;
      font-family: "Segoe UI", Arial, sans-serif;
    }
    .menu-item {
      padding: 0 15px;
      height: 100%;
      display: flex;
      align-items: center;
      cursor: pointer;
      position: relative;
      font-size: 14px;
    }
    .menu-item:hover { background: #e9ecef; }
    .menu-item.active .menu-dropdown { display: block; animation: fadeIn 0.15s ease-in; }
    @keyframes fadeIn {
      from { opacity: 0; transform: translateY(-10px); }
      to { opacity: 1; transform: translateY(0); }
    }
    .menu-dropdown {
      display: none;
      position: absolute;
      top: 40px;
      left: 0;
      background: white;
      min-width: 200px;
      box-shadow: 0 2px 8px rgba(0,0,0,0.15);
      z-index: 3000;
      border: 1px solid #dee2e6;
      border-radius: 4px;
      padding: 4px 0;
      margin-top: 1px;
      transform: translateY(0);
    }
    .menu-dropdown-item {
      padding: 8px 20px;
      color: #333;
      display: flex;
      align-items: center;
      text-decoration: none;
      font-size: 14px;
    }
    .menu-dropdown-item:hover { background: #f0f0f0; color: #000; }
    .menu-dropdown-item i { margin-right: 8px; width: 16px; color: #666; }
    .left-panel {
      position: fixed;
      top: 80px;
      left: 0;
      width: 300px;
      height: calc(100vh - 80px);
      background: white;
      border-right: 1px solid #dee2e6;
      transform: translateX(-300px);
      transition: transform 0.3s ease;
      z-index: 1500;
      display: flex;
      flex-direction: column;
    }
    .left-panel.visible { transform: translateX(0); }
    .panel-header {
      padding: 15px;
      background: #f8f9fa;
      border-bottom: 1px solid #dee2e6;
      font-weight: bold;
    }
    .panel-content { padding: 15px; flex-grow: 1; overflow-y: auto; }
    .layer-select-container {
      margin-bottom: 20px;
      padding: 10px;
      background: #f8f9fa;
      border-radius: 4px;
    }
    .base-layer-dropdown {
      position: absolute;
      background: white;
      padding: 10px;
      border: 1px solid #dee2e6;
      border-radius: 4px;
      box-shadow: 0 2px 4px rgba(0,0,0,0.1);
      z-index: 1002;
      display: none;
    }
    .base-layer-option {
      padding: 8px;
      display: flex;
      align-items: center;
      gap: 8px;
      cursor: pointer;
    }
    .base-layer-option:hover { background: #f8f9fa; }
    .layer-control-item {
      padding: 8px 0;
      display: flex;
      align-items: center;
      gap: 8px;
    }
    .location-item {
      padding: 10px;
      cursor: pointer;
      border-bottom: 1px solid #ddd;
    }
  </style>
</head>
<body>
  <nav class="main-toolbar">
    <div class="menu-item" onclick="toggleMenu(this, 'fileMenu')">
      File
      <div class="menu-dropdown" id="fileMenu">
        <div class="menu-dropdown-item" onclick="showNewLocationModal()">
          <i class="fas fa-plus"></i>New Location
        </div>
        <div class="menu-dropdown-item" onclick="showSwitchLocationModal()">
          <i class="fas fa-exchange-alt"></i>Switch Location
        </div>
        <div class="menu-dropdown-item" onclick="saveToDatabase()">
          <i class="fas fa-save"></i>Save
        </div>
      </div>
    </div>
    <div class="menu-item" onclick="toggleMenu(this, 'editMenu')">
      Edit
      <div class="menu-dropdown" id="editMenu">
        <div class="menu-dropdown-item"><i class="fas fa-cut"></i>Cut</div>
        <div class="menu-dropdown-item"><i class="fas fa-copy"></i>Copy</div>
        <div class="menu-dropdown-item"><i class="fas fa-paste"></i>Paste</div>
      </div>
    </div>
    <div class="menu-item" onclick="toggleMenu(this, 'viewMenu')">
      View
      <div class="menu-dropdown" id="viewMenu">
        <div class="menu-dropdown-item"><i class="fas fa-layer-group"></i>Layers</div>
        <div class="menu-dropdown-item"><i class="fas fa-map"></i>Base Maps</div>
      </div>
    </div>
    <div class="menu-item" onclick="toggleMenu(this, 'toolsMenu')">
      Tools
      <div class="menu-dropdown" id="toolsMenu">
        <div class="menu-dropdown-item"><i class="fas fa-calculator"></i>QD Calculator</div>
        <div class="menu-dropdown-item"><i class="fas fa-ruler"></i>Measure</div>
      </div>
    </div>
    <div class="menu-item" onclick="toggleMenu(this, 'helpMenu')">
      Help
      <div class="menu-dropdown" id="helpMenu">
        <div class="menu-dropdown-item"><i class="fas fa-book"></i>Documentation</div>
        <div class="menu-dropdown-item"><i class="fas fa-info-circle"></i>About</div>
      </div>
    </div>
    <div id="dbStatus">
      No location selected
    </div>
  </nav>

  <div class="toolbar">
    <div class="tool-group">
      <button id="toggleLayersPanel" class="tool-button" title="Toggle Layers Panel">
        <i class="fas fa-bars"></i>
      </button>
      <button id="baseLayerTool" class="tool-button" title="Base Layers">
        <i class="fas fa-layer-group"></i>
      </button>
    </div>
    <div class="tool-group">
      <button id="selectTool" class="tool-button" title="Select Features">
        <i class="fas fa-mouse-pointer"></i>
      </button>
      <button id="panTool" class="tool-button active" title="Pan Map">
        <i class="fas fa-hand-paper"></i>
      </button>
    </div>
    <div class="tool-group">
      <button id="drawMarker" class="tool-button" title="Add Point (PES/ES)">
        <i class="fas fa-map-marker-alt"></i>
      </button>
      <button id="drawPolygon" class="tool-button" title="Draw Polygon">
        <i class="fas fa-draw-polygon"></i>
      </button>
      <button id="drawRectangle" class="tool-button" title="Draw Rectangle">
        <i class="fas fa-square"></i>
      </button>
      <button id="drawCircle" class="tool-button" title="Draw Circle">
        <i class="fas fa-circle"></i>
      </button>
      <button id="drawPolyline" class="tool-button" title="Draw Line">
        <i class="fas fa-minus"></i>
      </button>
    </div>
  </div>

  <!-- Add Layer Modal -->
  <div id="addLayerModal" class="modal">
    <div class="modal-content">
      <span class="modal-close" onclick="closeModal('addLayerModal')">&times;</span>
      <h2>Add New Layer</h2>
      <div class="form-group">
        <label for="layerName">Layer Name:</label>
        <input type="text" id="layerName" required>
      </div>
      <div class="form-group">
        <label>
          <input type="checkbox" id="isQDAnalyzed">
          QD Analyzed
        </label>
      </div>
      <button onclick="addNewLayer()">Add Layer</button>
    </div>
  </div>

  <div id="leftPanel" class="left-panel">
    <div class="panel-header">Layers Panel</div>
    <div class="panel-content">
      <div class="layer-select-container">
        <label for="drawToLayer"><strong>Draw to Layer:</strong></label>
        <select id="drawToLayer" style="width: 100%; margin-top: 5px; padding: 5px;"></select>
        <button onclick="showAddLayerModal()" style="margin-top: 10px; width: 100%;">Add New Layer</button>
      </div>
      <div id="layerControl"></div>
    </div>
  </div>

  <div id="baseLayerDropdown" class="base-layer-dropdown"></div>
  <div id="map"></div>

  <!-- Type Code Modal -->
  <div id="typeCodeModal" class="modal">
    <div class="modal-content">
      <span class="modal-close" onclick="closeModal('typeCodeModal')">&times;</span>
      <h2>Enter Shape Type Code</h2>
      <div class="form-group">
        <label for="typeCode">Type Code:</label>
        <input type="text" id="typeCode" required>
      </div>
      <button onclick="saveTypeCode()">Save</button>
    </div>
  </div>

  <!-- Facility Details Modal -->
  <div id="facilityModal" class="modal">
    <div class="modal-content">
      <span class="modal-close" onclick="closeModal('facilityModal')">&times;</span>
      <h2>Facility Details</h2>
      <div class="form-group">
        <label for="facilityTypeCode">Type Code:</label>
        <input type="text" id="facilityTypeCode">
      </div>
      <div class="form-group">
        <label for="facilityDescription">Description:</label>
        <textarea id="facilityDescription" rows="3"></textarea>
      </div>
      <button onclick="saveFacilityDetails()">Save Changes</button>
    </div>
  </div>

  <!-- New Location Modal -->
  <div id="newLocationModal" class="modal">
    <div class="modal-content">
      <span class="modal-close" onclick="closeModal('newLocationModal')">&times;</span>
      <h2>Create New Location</h2>
      <div class="form-group">
        <label for="newLocationName">Location Name:</label>
        <input type="text" id="newLocationName" required>
      </div>
      <div style="text-align: right; margin-top: 20px;">
        <button onclick="closeModal('newLocationModal')" class="tool-button">Cancel</button>
        <button onclick="createLocation()" class="tool-button">Create</button>
      </div>
    </div>
  </div>

  <!-- New Location Confirmation Modal -->
  <div id="newLocationConfirmModal" class="modal">
    <div class="modal-content">
      <span class="modal-close" onclick="closeModal('newLocationConfirmModal')">&times;</span>
      <h2>Location Created</h2>
      <p>Location "<span id="newLocationName_confirm"></span>" has been created.</p>
      <p>Would you like to switch to the new location?</p>
      <div style="text-align: right; margin-top: 20px;">
        <button onclick="handleLocationSwitch(false)" class="tool-button">Stay in Current Location</button>
        <button onclick="handleLocationSwitch(true)" class="tool-button">Switch to New Location</button>
      </div>
    </div>
  </div>

  <!-- Switch Location Modal -->
  <div id="switchLocationModal" class="modal">
    <div class="modal-content">
      <span class="modal-close" onclick="closeModal('switchLocationModal')">&times;</span>
      <h2>Switch Location</h2>
      <div id="locationsList" style="margin: 20px 0;">Loading locations...</div>
    </div>
  </div>

  <script>
    // Global Variables
    let currentDrawnLayer = null;
    let selectedQDPoint = null;
    let qdBufferLayer = null;
    let activeMenu = null;
    window.layers = {};  // Global layers object
    window.activeLayer = null; // Global active layer

    // Global helper: getStyleForFeatureType must be defined before loadFromDatabase is used
    function getStyleForFeatureType(type) {
      const defaultStyle = {
        weight: 2,
        opacity: 1,
        fillOpacity: 0.3,
        color: '#3388ff',
        fillColor: '#3388ff'
      };
      if (!type) return defaultStyle;
      const upperType = type.toUpperCase();
      if (upperType.includes('PES')) {
        return {
          weight: 2,
          opacity: 1,
          fillOpacity: 0.3,
          color: '#ff0000',
          fillColor: '#ff0000'
        };
      } else if (upperType.includes('ES')) {
        return {
          weight: 2,
          opacity: 1,
          fillOpacity: 0.3,
          color: '#006400',
          fillColor: '#006400'
        };
      }
      return defaultStyle;
    }

    // Define loadFromDatabase globally
    window.loadFromDatabase = async function() {
      try {
        const response = await fetch('/api/load-layers');
        const data = await response.json();
        console.log('Loaded layer data:', JSON.stringify(data, null, 2));
        const layerData = data.layers || {};
        Object.values(window.layers).forEach(layer => window.map.removeLayer(layer));
        window.layers = {};
        Object.keys(layerData).forEach(layerName => {
          const layerGroup = new L.FeatureGroup();
          layerGroup.properties = layerData[layerName].properties;
          window.layers[layerName] = layerGroup;
          window.map.addLayer(layerGroup);
          if (layerData[layerName].features) {
            layerData[layerName].features.forEach(feature => {
              L.geoJSON(feature, {
                onEachFeature: function(feature, layer) {
                  if (feature.properties && feature.properties.typeCode) {
                    layer.setStyle(getStyleForFeatureType(feature.properties.typeCode));
                    layer.bindTooltip(`Type: ${feature.properties.typeCode}`);
                  }
                },
                style: function(feature) {
                  return getStyleForFeatureType(feature.properties.typeCode);
                }
              }).eachLayer(l => {
                l.feature = feature;
                layerGroup.addLayer(l);
              });
            });
          }
        });
        Object.values(window.layers).forEach(layer => { attachEditHandlers(layer); });
        updateLayerControl();
        updateDrawToLayerSelect();
      } catch (error) {
        console.error('Error loading layers:', error);
      }
    };

    // QD Calculator functions
    function showQDCalculator() {
      document.getElementById('qdCalculatorModal').style.display = 'block';
      window.map.on('click', function(e) {
        if (document.getElementById('qdCalculatorModal').style.display === 'block') {
          selectedQDPoint = e.latlng;
          if (qdBufferLayer) { window.map.removeLayer(qdBufferLayer); }
          L.marker(selectedQDPoint).addTo(window.map);
        }
      });
    }

    async function calculateQD() {
      if (!selectedQDPoint) {
        alert('Please select a location on the map');
        return;
      }
      if (window.qdBufferLayer) { window.map.removeLayer(window.qdBufferLayer); }
      const quantity = document.getElementById('quantity').value;
      const materialType = document.getElementById('materialType').value;
      const siteType = document.getElementById('siteType').value || 'DOD';
      try {
        const response = await fetch('/api/calculate-qd', {
          method: 'POST',
          headers: { 'Content-Type': 'application/json' },
          body: JSON.stringify({
            quantity: parseFloat(quantity),
            lat: selectedQDPoint.lat,
            lng: selectedQDPoint.lng,
            site_type: siteType,
            material_type: materialType,
            sensitivity: 0.5,
            det_velocity: 6000,
            tnt_equiv: 1.0,
            temperature: 298,
            pressure: 101.325,
            humidity: 50,
            confinement_factor: 0.0
          })
        });
        const data = await response.json();
        window.qdBufferLayer = L.geoJSON(data.buffer_zones, {
          style: function(feature) {
            return {
              color: '#ff0000',
              weight: 2,
              opacity: 0.8,
              fillColor: '#ff0000',
              fillOpacity: 0.2 * (feature.properties.ring_number / 4)
            };
          },
          onEachFeature: function(feature, layer) {
            layer.bindTooltip(
              `Distance: ${feature.properties.distance.toFixed(2)} ft<br>` +
              `K-factor: ${feature.properties.k_factor.toFixed(1)}`
            );
          }
        }).addTo(window.map);
        alert(`Safe Distance: ${data.safe_distance.toFixed(2)} ${data.units}`);
      } catch (error) {
        console.error('QD calculation error:', error);
        alert('Error calculating safe distance');
      }
    }

    // Modal and Location Functions
    function toggleMenu(menuItem, menuId) {
      const dropdown = document.getElementById(menuId);
      const allDropdowns = document.querySelectorAll('.menu-dropdown');
      allDropdowns.forEach(d => {
        if (d.id !== menuId) {
          d.style.display = 'none';
          d.parentElement.classList.remove('active');
        }
      });

      if (dropdown.style.display === 'block') {
        dropdown.style.display = 'none';
        menuItem.classList.remove('active');
      } else {
        dropdown.style.display = 'block';
        menuItem.classList.add('active');
      }
    }

    // Close menu when clicking outside
    document.addEventListener('click', (e) => {
      if (!e.target.closest('.menu-item')) {
        const allDropdowns = document.querySelectorAll('.menu-dropdown');
        allDropdowns.forEach(d => {
          d.style.display = 'none';
          if (d.parentElement) {
            d.parentElement.classList.remove('active');
          }
        });
      }
    });

    function closeModal(modalId) {
      document.getElementById(modalId).style.display = 'none';
    }

    let newLocationData = null;
    async function createLocation() {
      const locationName = document.getElementById('newLocationName').value;
      if (!locationName) { alert('Please enter a location name'); return; }
      try {
        const response = await fetch('/api/create_location', {
          method: 'POST',
          headers: { 'Content-Type': 'application/json' },
          body: JSON.stringify({ location_name: locationName })
        });
        const data = await response.json();
        if (response.ok) {
          newLocationData = data;
          document.getElementById('newLocationName_confirm').textContent = locationName;
          closeModal('newLocationModal');
          document.getElementById('newLocationName').value = '';
          document.getElementById('newLocationConfirmModal').style.display = 'block';
          updateCurrentLocation(locationName);
          clearAllFeatures();
          await fetchLocations();
        } else {
          alert('Failed to create location: ' + data.detail);
        }
      } catch (error) {
        console.error('Error creating location:', error);
        alert('Failed to create location');
      }
    }

    function handleLocationSwitch(shouldSwitch) {
      if (shouldSwitch && newLocationData) {
        updateCurrentLocation(newLocationData.name);
        clearAllFeatures();
      }
      closeModal('newLocationConfirmModal');
      newLocationData = null;
    }

    function updateCurrentLocation(locationName) {
      document.getElementById('dbStatus').innerHTML = `Location: ${locationName}`;
    }

    async function fetchLocations() {
      try {
        const response = await fetch('/api/locations');
        const data = await response.json();
        const locationsList = document.getElementById('locationsList');
        locationsList.innerHTML = data.locations.map(loc => `
          <div class="location-item" style="padding: 10px; cursor: pointer; border-bottom: 1px solid #ddd;"
            onclick="switchLocation('${loc.name}')">
            ${loc.name}<br>
            <small style="color: #666;">Created: ${new Date(loc.created_at).toLocaleString()}</small>
          </div>
        `).join('');
      } catch (error) {
        console.error('Error fetching locations:', error);
        document.getElementById('locationsList').innerHTML = 'Failed to load locations';
      }
    }

    async function switchLocation(locationName) {
      updateCurrentLocation(locationName);
      closeModal('switchLocationModal');
      clearAllFeatures();
      await window.loadFromDatabase();
      console.log(`Switched to location: ${locationName}`);
    }

    function clearAllFeatures() {
      if (window.layers) {
        Object.values(window.layers).forEach(layer => {
          if (layer instanceof L.FeatureGroup) { layer.clearLayers(); }
        });
      }
    }

    function showNewLocationModal() {
      document.getElementById('newLocationModal').style.display = 'block';
    }

    function showSwitchLocationModal() {
      document.getElementById('switchLocationModal').style.display = 'block';
      fetchLocations();
    }

    async function saveToDatabase() {
      const layerData = { layers: {} };
      Object.keys(window.layers).forEach(layerName => {
        const layer = window.layers[layerName];
        layerData.layers[layerName] = { properties: layer.properties || {}, features: [] };
        layer.eachLayer(l => {
          if (l.toGeoJSON) {
            const geoJSON = l.toGeoJSON();
            if (l.feature && l.feature.properties) {
              geoJSON.properties = { ...l.feature.properties };
            }
            layerData.layers[layerName].features.push(geoJSON);
          }
        });
      });
      console.log('Saving layer data:', JSON.stringify(layerData, null, 2));
      try {
        await fetch('/api/save-layers', {
          method: 'POST',
          headers: { 'Content-Type': 'application/json' },
          body: JSON.stringify(layerData)
        });
      } catch (error) {
        console.error('Error saving layers:', error);
      }
    }

    function attachEditHandlers(layer) {
      if (layer instanceof L.FeatureGroup) {
        layer.eachLayer(l => {
          l.feature = l.feature || {};
          l.feature.properties = l.feature.properties || {};
          l.off('click');
          l.on('click', function() { openEditPopup(l); });
        });
      }
    }

    // Base Layers
    let baseLayers = {
      'None': L.tileLayer(''),
      'OpenStreetMap': L.tileLayer('https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png', {
        attribution: 'Â© OpenStreetMap contributors'
      }),
      'Google Satellite': L.tileLayer('https://mt1.google.com/vt/lyrs=s&x={x}&y={y}&z={z}'),
      'Google Streets': L.tileLayer('https://mt1.google.com/vt/lyrs=m&x={x}&y={y}&z={z}'),
      'Google Hybrid': L.tileLayer('https://mt1.google.com/vt/lyrs=y&x={x}&y={y}&z={z}')
    };

    async function initializeBaseLayerDropdown() {
      const baseLayerTool = document.getElementById('baseLayerTool');
      const baseLayerDropdown = document.getElementById('baseLayerDropdown');

      if (!baseLayerTool || !baseLayerDropdown) {
        console.error('Base layer elements not found');
        return;
      }

      baseLayerTool.addEventListener('click', (e) => {
        const buttonRect = baseLayerTool.getBoundingClientRect();
        baseLayerDropdown.style.top = (buttonRect.bottom + 5) + 'px';
        baseLayerDropdown.style.left = buttonRect.left + 'px';
        baseLayerDropdown.style.display = (baseLayerDropdown.style.display === 'none' || baseLayerDropdown.style.display === '') ? 'block' : 'none';
      });

      baseLayerDropdown.innerHTML = '';
      Object.entries(baseLayers).forEach(([name, layer]) => {        const option = document.createElement('div');
        option.className = 'base-layer-option';
        const isActive = window.map.hasLayer(layer);
                option.innerHTML = `
          <input type="radio" name="baseLayer" id="base-${name}" ${isActive ? 'checked' : ''}>
          <label for="base-${name}">${name}</label>
        `;
        option.onclick = () => {
          Object.values(baseLayers).forEach(l => window.map.removeLayer(l));
          if (name !== 'None') { window.map.addLayer(layer); }
          baseLayerDropdown.style.display = 'none';
        };
        baseLayerDropdown.appendChild(option);
      });
      document.addEventListener('click', (e) => {
        if (activeMenu && !activeMenu.contains(e.target) && !baseLayerTool.contains(e.target) && !baseLayerDropdown.contains(e.target)) {
          activeMenu.classList.remove('active');
          activeMenu = null;
          baseLayerDropdown.style.display = 'none';
        }
      });
    }

    // Drawing Tools Setup
    let drawingTools = {};

    // Initialize drawing tools after map is ready
    function initializeDrawingTools() {
      const drawOptions = {
        shapeOptions: {
          color: '#3388ff',
          fillOpacity: 0.3,
          weight: 2
        }
      };

      drawingTools = {
        polygon: new L.Draw.Polygon(window.map, {
          showLength: true,
          showArea: true,
          allowIntersection: false,
          drawError: { color: '#e1e100', timeout: 1000 },
          shapeOptions: { color: '#3388ff' },
          metric: false,
          vertices: {
            first: { icon: new L.DivIcon({ iconSize: new L.Point(0, 0), className: 'leaflet-div-icon leaflet-hidden' }) },
            mid: { icon: new L.DivIcon({ iconSize: new L.Point(0, 0), className: 'leaflet-div-icon leaflet-hidden' }) },
            last: { icon: new L.DivIcon({ iconSize: new L.Point(0, 0), className: 'leaflet-div-icon leaflet-hidden' }) }
          }
        }),
        polyline: new L.Draw.Polyline(window.map, {
          shapeOptions: { color: '#3388ff', weight: 2 },
          metric: false
        }),
        rectangle: new L.Draw.Rectangle(window.map, {
          shapeOptions: { color: '#3388ff' },
          metric: false
        }),
        circle: new L.Draw.Circle(window.map, {
          shapeOptions: { color: '#3388ff' },
          metric: false
        }),
        marker: new L.Draw.Marker(window.map)
      };
    }

    // Call initialization after map is loaded
    document.addEventListener('DOMContentLoaded', async function() {
      console.log('DOM Content Loaded');

      // Initialize file menu
      initializeFileMenu();

      // Initialize map first
      window.map = L.map('map', {
        center: [39.8283, -98.5795],
        zoom: 4
      });

      // Add default base layer immediately
      baseLayers['OpenStreetMap'].addTo(window.map);

      // Initialize menu functionality
      const menuItems = document.querySelectorAll('.menu-item');
      menuItems.forEach(item => {
        item.addEventListener('click', (e) => {
          e.stopPropagation();
          if (activeMenu) {
            activeMenu.classList.remove('active');
          }
          item.classList.add('active');
          activeMenu = item;
        });
      });

      // Close menus when clicking outside
      document.addEventListener('click', (e) => {
        if (activeMenu && !activeMenu.contains(e.target)) {
          activeMenu.classList.remove('active');
          activeMenu = null;
        }
      });

      // Initialize tool buttons
      const toolButtons = document.querySelectorAll('.tool-button');
      toolButtons.forEach(button => {
        button.addEventListener('click', (e) => {
          e.stopPropagation();
          if (!button.id.startsWith('toggle')) {
            toolButtons.forEach(b => b.classList.remove('active'));
            button.classList.add('active');
          }
        });
      });

      // Initialize drawing tools and buttons
      initializeDrawingTools();
      initializeDrawingButtons();

      // Initialize base layer dropdown and load data
      await initializeBaseLayerDropdown();
      await loadFromDatabase();

      // Force a map resize to ensure proper rendering
      setTimeout(() => {
        window.map.invalidateSize();
      }, 100);

    });

    function updateLayerControl() {
      const layerControl = document.getElementById('layerControl');
      if (!layerControl) return;

      layerControl.innerHTML = '';
      Object.entries(window.layers).forEach(([name, layer]) => {
        const item = document.createElement('div');
        item.className = 'layer-control-item';
        item.innerHTML = `
          <input type="checkbox" id="layer-${name}" ${window.map.hasLayer(layer) ? 'checked' : ''}>
          <label for="layer-${name}">
            ${name}
            <span style="color: ${layer.properties?.isQDAnalyzed ? 'green' : 'red'}">
              (${layer.properties?.isQDAnalyzed ? 'QD' : 'Non-QD'})
            </span>
          </label>
          <button class="edit-layer-button" onclick="editLayer('${name}')">
            <i class="fas fa-edit"></i>
          </button>
        `;
        item.querySelector('input').onchange = (e) => {
          if (e.target.checked) {
            window.map.addLayer(layer);
          } else {
            window.map.removeLayer(layer);
          }
        };
        layerControl.appendChild(item);
      });
    }

    function deactivateAllDrawingTools() {
      Object.values(drawingTools).forEach(tool => {
        if (tool && typeof tool.disable === 'function') { tool.disable(); }
      });
      document.querySelectorAll('.tool-button').forEach(button => { button.classList.remove('active'); });
      window.map.off('mousemove');
      window.map.off('click');
    }

    // File menu handlers
    function initializeFileMenu() {
      const fileActions = {
        'newFile': () => {
          console.log('New file action triggered');
          Object.values(window.layers).forEach(layer => {
            layer.clearLayers();
          });
          updateLayerControl();
        },
        'switchLocation': () => {
          console.log('Switch location triggered');
          // Add location switching logic
        },
        'saveFile': async () => {
          console.log('Save triggered');
          try {
            const layerData = {};
            Object.entries(window.layers).forEach(([name, layer]) => {
              layerData[name] = {
                properties: layer.properties || {},
                features: []
              };
              layer.eachLayer(l => {
                if (l.toGeoJSON) {
                  layerData[name].features.push(l.toGeoJSON());
                }
              });
            });

            const response = await fetch('/api/save-layers', {
              method: 'POST',
              headers: { 'Content-Type': 'application/json' },
              body: JSON.stringify(layerData)
            });

            if (!response.ok) throw new Error('Save failed');
            console.log('Save successful');
          } catch (error) {
            console.error('Save error:', error);
          }
        },
        'exportFile': () => {
          console.log('Export triggered');
          // Add export logic
        }
      };

      // Bind click handlers to menu buttons
      Object.keys(fileActions).forEach(actionId => {
        const button = document.getElementById(actionId);
        if (button) {
          button.addEventListener('click', (e) => {
            e.preventDefault();
            e.stopPropagation();
            fileActions[actionId]();
          });
        }
      });
    }

    function setupDrawingButton(buttonId, tool) {
      const button = document.getElementById(buttonId);
      if (!button) return;

      button.addEventListener('click', function(e) {
        e.preventDefault();
        e.stopPropagation();

        // Disable all other drawing tools first
        deactivateAllDrawingTools();

        // Enable this tool and activate the button
        if (tool && typeof tool.enable === 'function') {
          tool.enable();
          button.classList.add('active');
        }
      });
    }

    // Initialize drawing tools immediately after map creation
    function initializeDrawingButtons() {
      setupDrawingButton('drawPolygon', drawingTools.polygon);
      setupDrawingButton('drawPolyline', drawingTools.polyline);
      setupDrawingButton('drawRectangle', drawingTools.rectangle);
      setupDrawingButton('drawCircle', drawingTools.circle);
      setupDrawingButton('drawMarker', drawingTools.marker);
    }

    window.map.on('click', function() { deactivateAllDrawingTools(); });
    window.map.on('draw:created', function(e) {
      console.log('Draw created event fired', e);
      const layer = e.layer;

      // Ensure proper feature structure
      layer.feature = layer.feature || {};
      layer.feature.properties = layer.feature.properties || {};

      // For polygons, ensure they're closed
      if (e.layerType === 'polygon' && layer.getLatLngs) {
        let coords = layer.getLatLngs()[0];
        if (coords.length > 0 && !coords[0].equals(coords[coords.length - 1])) {
          coords.push(coords[0]); // Force close the polygon
          layer.setLatLngs(coords);
        }
      }

      // Add the layer to the active layer group
      if (window.activeLayer) {
        try {
          window.activeLayer.addLayer(layer);
          console.log('Layer added successfully');
          attachEditHandlers(layer);
          saveToDatabase();
        } catch (error) {
          console.error('Error adding layer:', error);
        }
      } else {
        console.warn('No active layer to add the drawn shape to');
      }

      deactivateAllDrawingTools();
    });

    function openEditPopup(layer) {
      layer.feature = layer.feature || {};
      layer.feature.properties = layer.feature.properties || {};
      const formHtml = `
        <div style="min-width: 200px;">
          <div class="form-group" style="margin-bottom: 10px;">
            <label for="facilityName">Facility Name:</label>
            <input id="facilityName" type="text" value="${layer.feature.properties.name || ''}" style="width: 100%;" />
          </div>
          <div class="form-group" style="margin-bottom: 10px;">
            <label for="facilityTypeCode">Type Code Designator (PES/ES):</label>
            <input id="facilityTypeCode" type="text" value="${layer.feature.properties.typeCode || ''}" style="width: 100%;" placeholder="Enter PES or ES designator" />
          </div>
          <div class="form-group" style="margin-bottom: 10px;">
            <label for="facilityDescription">Description:</label>
            <textarea id="facilityDescription" style="width: 100%; height: 60px;">${layer.feature.properties.description || ''}</textarea>
          </div>
          <button id="facilitySaveButton" style="width: 100%; padding: 5px;">Save</button>
        </div>
      `;
      layer.bindPopup(formHtml).openPopup();
      setTimeout(() => {
        const saveBtn = document.getElementById('facilitySaveButton');
        if (saveBtn) {
          saveBtn.addEventListener('click', () => {
            const newName = document.getElementById('facilityName').value;
            const newTypeCode = document.getElementById('facilityTypeCode').value;
            const newDescription = document.getElementById('facilityDescription').value;
            layer.feature.properties = {
              ...layer.feature.properties,
              name: newName,
              typeCode: newTypeCode,
              description: newDescription
            };
            layer.setStyle(getStyleForFeatureType(newTypeCode));
            layer.bindTooltip(`${newName}<br>${newTypeCode}`, { permanent: false });
            saveToDatabase();
            layer.closePopup();
          });
        }
      }, 100);
    }

    // Base Layer Dropdown
    async function initializeBaseLayerDropdown() {
      const baseLayerTool = document.getElementById('baseLayerTool');
      const baseLayerDropdown = document.getElementById('baseLayerDropdown');

      if (!baseLayerTool || !baseLayerDropdown) {
        console.error('Base layer elements not found');
        return;
      }

      baseLayerTool.addEventListener('click', (e) => {
        const buttonRect = baseLayerTool.getBoundingClientRect();
        baseLayerDropdown.style.top = (buttonRect.bottom + 5) + 'px';
        baseLayerDropdown.style.left = buttonRect.left + 'px';
        baseLayerDropdown.style.display = (baseLayerDropdown.style.display === 'none' || baseLayerDropdown.style.display === '') ? 'block' : 'none';
      });

      baseLayerDropdown.innerHTML = '';
      Object.entries(baseLayers).forEach(([name, layer]) => {
        const option = document.createElement('div');
        option.className = 'base-layer-option';
        const isActive = window.map.hasLayer(layer);
        option.innerHTML = `
          <input type="radio" name="baseLayer" id="base-${name}" ${isActive ? 'checked' : ''}>
          <label for="base-${name}">${name}</label>
        `;
        option.onclick = () => {
          Object.values(baseLayers).forEach(l => window.map.removeLayer(l));
          if (name !== 'None') { window.map.addLayer(layer); }
          baseLayerDropdown.style.display = 'none';
        };
        baseLayerDropdown.appendChild(option);
      });
      document.addEventListener('click', (e) => {
        if (activeMenu && !activeMenu.contains(e.target) && !baseLayerTool.contains(e.target) && !baseLayerDropdown.contains(e.target)) {
          activeMenu.classList.remove('active');
          activeMenu = null;
          baseLayerDropdown.style.display = 'none';
        }
      });
    }

    function editLayer(layerName) {
      const layer = window.layers[layerName];
      if (!layer) return;

      const isQDAnalyzed = layer.properties?.isQDAnalyzed || false;
      const formHtml = `
        <div style="min-width: 200px;">
          <div class="form-group" style="margin-bottom: 10px;">
            <label>Layer Name: ${layerName}</label>
          </div>
          <div class="form-group" style="margin-bottom: 10px;">
            <label>
              <input type="checkbox" id="layerQDAnalyzed" ${isQDAnalyzed ? 'checked' : ''}>
              QD Analyzed
            </label>
          </div>
          <button id="layerSaveButton" style="width: 100%; padding: 5px;">Save Changes</button>
        </div>
      `;

      const popup = L.popup()
        .setLatLng(window.map.getCenter())
        .setContent(formHtml)
        .openOn(window.map);

      setTimeout(() => {
        const saveBtn = document.getElementById('layerSaveButton');
        if (saveBtn) {
          saveBtn.addEventListener('click', () => {
            const newIsQDAnalyzed = document.getElementById('layerQDAnalyzed').checked;
            layer.properties = {
              ...layer.properties,
              isQDAnalyzed: newIsQDAnalyzed
            };
            updateLayerControl();
            saveToDatabase();
            window.map.closePopup(popup);
          });
        }
      }, 100);
    }

    function updateDrawToLayerSelect() {
      const select = document.getElementById('drawToLayer');
      if (!select) return;

      select.innerHTML = '';
      Object.entries(window.layers).forEach(([name, layer]) => {
        const option = document.createElement('option');
        option.value = name;
        option.textContent = name;
        select.appendChild(option);
      });

      select.onchange = (e) => {
        window.activeLayer = window.layers[e.target.value];
      };

      // Set initial active layer
      if (select.options.length > 0) {
        select.selectedIndex = 0;
        window.activeLayer = window.layers[select.options[0].value];
      }
    }

    // Left Panel Toggle
    const toggleLayersPanel = document.getElementById('toggleLayersPanel');
    const leftPanel = document.getElementById('leftPanel');
    const mapElement = document.getElementById('map');
    toggleLayersPanel.addEventListener('click', () => {
      leftPanel.classList.toggle('visible');
      mapElement.style.marginLeft = leftPanel.classList.contains('visible') ? '300px' : '0';
      window.map.invalidateSize();
    });
    updateLayerControl();
    updateDrawToLayerSelect();
  </script>

</body>
</html>