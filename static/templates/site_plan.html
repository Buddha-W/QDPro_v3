<!DOCTYPE html>
<html>
<head>
  <title>QDPro Site Plan</title>
  <!-- Leaflet CSS -->
  <link rel="stylesheet" href="https://unpkg.com/leaflet@1.9.4/dist/leaflet.css" crossorigin="anonymous"/>
  <!-- Leaflet.draw CSS -->
  <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/leaflet.draw/1.0.4/leaflet.draw.css" crossorigin="anonymous"/>
  <!-- Font Awesome -->
  <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/5.15.4/css/all.min.css" crossorigin="anonymous"/>
  <!-- Leaflet and Leaflet.draw JS -->
  <script src="https://unpkg.com/leaflet@1.9.4/dist/leaflet.js" crossorigin="anonymous"></script>
  <script src="https://cdnjs.cloudflare.com/ajax/libs/leaflet.draw/1.0.4/leaflet.draw.js" crossorigin="anonymous"></script>
  <style>
    /* Reset and basic styling */
    * { margin: 0; padding: 0; box-sizing: border-box; }
    body { height: 100vh; overflow: hidden; font-family: Arial, sans-serif; }

    /* Top Navigation Bar */
    nav.main-toolbar {
      position: fixed; top: 0; left: 0; right: 0;
      height: 40px; background: #f1f1f1; border-bottom: 1px solid #ccc;
      display: flex; align-items: center; z-index: 2000; padding: 0 10px;
    }
    nav.main-toolbar .menu-item {
      padding: 0 15px; font-size: 14px; display: flex; align-items: center;
      cursor: pointer; position: relative;
    }
    nav.main-toolbar .menu-item:hover { background: #e9ecef; }
    nav.main-toolbar .menu-dropdown {
      display: none; position: absolute; top: 40px; left: 0;
      background: white; min-width: 200px; border: 1px solid #ccc;
      border-radius: 4px; z-index: 2100;
    }
    nav.main-toolbar .menu-dropdown .menu-dropdown-item {
      padding: 8px 20px; font-size: 14px; cursor: pointer; white-space: nowrap;
    }
    nav.main-toolbar .menu-dropdown .menu-dropdown-item:hover { background: #f0f0f0; }
    #dbStatus { margin-left: auto; font-size: 14px; color: #333; }

    /* Drawing Toolbar */
    .toolbar {
      position: fixed; top: 40px; left: 0; right: 0; height: 40px;
      background: #fff; border-bottom: 1px solid #ccc;
      display: flex; align-items: center; z-index: 1900; padding: 0 10px;
    }
    .toolbar .tool-group { display: flex; align-items: center; margin-right: 10px; }
    .toolbar .tool-button {
      padding: 6px; margin: 0 2px; border: 1px solid transparent;
      border-radius: 3px; background: #fff; color: #666; cursor: pointer;
      display: flex; align-items: center; justify-content: center;
      min-width: 32px; height: 32px;
    }
    .toolbar .tool-button:hover { background: #f0f0f0; border-color: #ccc; }
    .toolbar .tool-button.active { background: #e6f2ff; border-color: #99ccff; color: #0066cc; }
    .toolbar .tool-button i { font-size: 16px; }

    /* Map */
    #map {
      position: fixed; top: 80px; left: 0; right: 0; bottom: 0;
      z-index: 1000; width: 100%; height: calc(100vh - 80px);
    }

    /* Left Panel (for layers) */
    .left-panel {
      position: fixed; top: 80px; left: 0; width: 300px;
      height: calc(100vh - 80px); background: white; border-right: 1px solid #ccc;
      transform: translateX(-300px); transition: transform 0.3s ease;
      z-index: 1500; display: flex; flex-direction: column;
    }
    .left-panel.visible { transform: translateX(0); }
    .panel-header { padding: 15px; background: #f8f9fa; border-bottom: 1px solid #ccc; font-weight: bold; }
    .panel-content { padding: 15px; flex-grow: 1; overflow-y: auto; }

    /* Base Layer Dropdown */
    .base-layer-dropdown {
      position: absolute; background: white; padding: 10px;
      border: 1px solid #ccc; border-radius: 4px; box-shadow: 0 2px 4px rgba(0,0,0,0.1);
      z-index: 1800; display: none;
    }
  </style>
</head>
<body>
  <!-- Top Navigation Bar -->
  <nav class="main-toolbar">
    <div class="menu-item" onclick="toggleMenu(this, 'fileMenu')">File
      <div class="menu-dropdown" id="fileMenu">
        <div class="menu-dropdown-item" onclick="showNewLocationModal()">New Location</div>
        <div class="menu-dropdown-item" onclick="showSwitchLocationModal()">Switch Location</div>
        <div class="menu-dropdown-item" onclick="saveToDatabase()">Save</div>
      </div>
    </div>
    <div class="menu-item" onclick="toggleMenu(this, 'editMenu')">Edit
      <div class="menu-dropdown" id="editMenu">
        <div class="menu-dropdown-item">Cut</div>
        <div class="menu-dropdown-item">Copy</div>
        <div class="menu-dropdown-item">Paste</div>
      </div>
    </div>
    <div class="menu-item" onclick="toggleMenu(this, 'viewMenu')">View
      <div class="menu-dropdown" id="viewMenu">
        <div class="menu-dropdown-item">Layers</div>
        <div class="menu-dropdown-item">Base Maps</div>
      </div>
    </div>
    <div class="menu-item" onclick="toggleMenu(this, 'toolsMenu')">Tools
      <div class="menu-dropdown" id="toolsMenu">
        <div class="menu-dropdown-item">QD Calculator</div>
        <div class="menu-dropdown-item">Measure</div>
      </div>
    </div>
    <div class="menu-item" onclick="toggleMenu(this, 'helpMenu')">Help
      <div class="menu-dropdown" id="helpMenu">
        <div class="menu-dropdown-item">Documentation</div>
        <div class="menu-dropdown-item">About</div>
      </div>
    </div>
    <div id="dbStatus">No location selected</div>
  </nav>

  <!-- Drawing Toolbar -->
  <div class="toolbar">
    <div class="tool-group">
      <button id="toggleLayersPanel" class="tool-button" title="Toggle Layers Panel">
        <i class="fas fa-bars"></i>
      </button>
      <button id="baseLayerTool" class="tool-button" title="Base Layers">
        <i class="fas fa-layer-group"></i>
      </button>
    </div>
    <div class="tool-group">
      <button id="selectTool" class="tool-button" title="Select Features">
        <i class="fas fa-mouse-pointer"></i>
      </button>
      <button id="panTool" class="tool-button active" title="Pan Map">
        <i class="fas fa-hand-paper"></i>
      </button>
    </div>
    <div class="tool-group">
      <button id="drawMarker" class="tool-button" title="Add Point">
        <i class="fas fa-map-marker-alt"></i>
      </button>
      <button id="drawPolygon" class="tool-button" title="Draw Polygon">
        <i class="fas fa-draw-polygon"></i>
      </button>
      <button id="drawRectangle" class="tool-button" title="Draw Rectangle">
        <i class="fas fa-square"></i>
      </button>
      <button id="drawCircle" class="tool-button" title="Draw Circle">
        <i class="fas fa-circle"></i>
      </button>
      <button id="drawPolyline" class="tool-button" title="Draw Line">
        <i class="fas fa-minus"></i>
      </button>
    </div>
  </div>

  <!-- Left Panel for Layers -->
  <div class="left-panel" id="leftPanel">
    <div class="panel-header">Layers Panel</div>
    <div class="panel-content">
      <div class="layer-select-container">
        <label for="drawToLayer"><strong>Draw to Layer:</strong></label>
        <select id="drawToLayer" style="width: 100%; margin-top: 5px; padding: 5px;"></select>
        <button onclick="showAddLayerModal()" style="margin-top: 10px; width: 100%;">Add New Layer</button>
      </div>
      <div id="layerControl"></div>
    </div>
  </div>

  <!-- Base Layer Dropdown -->
  <div id="baseLayerDropdown" class="base-layer-dropdown"></div>

  <!-- Add Layer Modal -->
  <div id="addLayerModal" style="display: none; position: fixed; z-index: 2000; left: 0; top: 0; width: 100%; height: 100%; background-color: rgba(0,0,0,0.4);">
    <div style="background-color: #fefefe; margin: 15% auto; padding: 20px; border: 1px solid #888; width: 80%; max-width: 500px;">
      <h2>Add New Layer</h2>
      <div style="margin: 10px 0;">
        <label for="newLayerName">Layer Name:</label>
        <input type="text" id="newLayerName" style="width: 100%; padding: 5px;" />
      </div>
      <div style="margin: 10px 0;">
        <label for="newLayerType">Layer Type:</label>
        <select id="newLayerType" style="width: 100%; padding: 5px;">
          <option value="facility">Facility</option>
          <option value="boundary">Boundary</option>
          <option value="arc">Arc</option>
        </select>
      </div>
      <div style="text-align: right; margin-top: 20px;">
        <button onclick="closeAddLayerModal()" style="margin-right: 10px; padding: 5px 10px;">Cancel</button>
        <button onclick="createNewLayer()" style="padding: 5px 10px;">Create</button>
      </div>
    </div>
  </div>

  <!-- Map Container -->
  <div id="map"></div>

  <script>
    // Layer management functions
    function showAddLayerModal() {
      document.getElementById('addLayerModal').style.display = 'block';
    }

    function closeAddLayerModal() {
      document.getElementById('addLayerModal').style.display = 'none';
    }

    function createNewLayer() {
      const layerName = document.getElementById('newLayerName').value;
      const layerType = document.getElementById('newLayerType').value;
      
      if (!layerName) {
        alert('Please enter a layer name');
        return;
      }

      // Create new layer
      window.layers = window.layers || {};
      window.layers[layerName] = L.featureGroup().addTo(window.map);
      window.layers[layerName].layerType = layerType;
      
      // Update layer select
      updateDrawToLayerSelect();
      
      // Close modal
      closeAddLayerModal();
    }
    // Utility: Toggle menu dropdowns
    function toggleMenu(element, menuId) {
      const dropdown = document.getElementById(menuId);
      document.querySelectorAll(".menu-dropdown").forEach(dd => {
        if (dd.id !== menuId) {
          dd.style.display = "none";
          dd.parentElement.classList.remove("active");
        }
      });
      if (dropdown.style.display === "block") {
        dropdown.style.display = "none";
        element.classList.remove("active");
      } else {
        dropdown.style.display = "block";
        element.classList.add("active");
      }
    }
    document.addEventListener("click", function(e) {
      if (!e.target.closest(".menu-item")) {
        document.querySelectorAll(".menu-dropdown").forEach(dd => { dd.style.display = "none"; });
        document.querySelectorAll(".menu-item").forEach(mi => { mi.classList.remove("active"); });
      }
    });

    // Wait for DOM to be ready
    document.addEventListener("DOMContentLoaded", async function() {
      console.log("DOM Content Loaded");
      // Initialize the map and assign to window.map
      window.map = L.map("map", {
        center: [39.8283, -98.5795],
        zoom: 4,
        zoomControl: true
      });
      L.tileLayer("https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png", { maxZoom: 19 }).addTo(window.map);
      console.log("Map initialized:", window.map);

      // Add default base layer (if using baseLayers later)
      baseLayers['OpenStreetMap'].addTo(window.map);

      // Create global active layer for facility drawings
      window.activeLayer = L.featureGroup().addTo(window.map);

      // Ensure "Draw to Layer" select updates activeLayer
      document.getElementById("drawToLayer").onchange = function(e) {
        const selected = e.target.value;
        if (window.layers && window.layers[selected]) {
          window.activeLayer = window.layers[selected];
          console.log("Active layer set to:", selected);
        }
      };

      // Initialize drawing tools
      initializeDrawingTools();
      initializeDrawingButtons();

      // Initialize base layer dropdown and load existing layers (if any)
      await initializeBaseLayerDropdown();
      await loadFromDatabase();

      // Force map resize
      setTimeout(function() {
        window.map.invalidateSize();
        initializeMapHandlers();
      }, 100);

      // Set up menu event listeners
      const menuItems = document.querySelectorAll(".menu-item");
      menuItems.forEach(item => {
        item.addEventListener("click", (e) => {
          e.stopPropagation();
          item.classList.add("active");
        });
      });
    });

    // Initialize drawing tools
    function initializeDrawingTools() {
      window.drawingTools = {
        polygon: new L.Draw.Polygon(window.map, {
          allowIntersection: false,
          showArea: true,
          drawError: { color: "#e1e100", timeout: 1000 },
          shapeOptions: { color: "#3388ff" }
        }),
        polyline: new L.Draw.Polyline(window.map, { shapeOptions: { color: "#3388ff", weight: 2 } }),
        rectangle: new L.Draw.Rectangle(window.map, { shapeOptions: { color: "#3388ff" } }),
        circle: new L.Draw.Circle(window.map, { shapeOptions: { color: "#3388ff" } }),
        marker: new L.Draw.Marker(window.map)
      };
    }
    function setupDrawingButton(buttonId, tool) {
      const button = document.getElementById(buttonId);
      if (!button) return;
      button.addEventListener("click", function(e) {
        e.preventDefault(); e.stopPropagation();
        deactivateAllDrawingTools();
        if (tool && typeof tool.enable === "function") {
          tool.enable();
          button.classList.add("active");
        }
      });
    }
    function initializeDrawingButtons() {
      setupDrawingButton("drawPolygon", window.drawingTools.polygon);
      setupDrawingButton("drawPolyline", window.drawingTools.polyline);
      setupDrawingButton("drawRectangle", window.drawingTools.rectangle);
      setupDrawingButton("drawCircle", window.drawingTools.circle);
      setupDrawingButton("drawMarker", window.drawingTools.marker);
    }
    function deactivateAllDrawingTools() {
      if (window.drawingTools) {
        for (let tool in window.drawingTools) {
          if (window.drawingTools[tool] && typeof window.drawingTools[tool].disable === "function") {
            window.drawingTools[tool].disable();
          }
        }
      }
      document.querySelectorAll(".tool-button").forEach(button => button.classList.remove("active"));
      window.map.off("mousemove");
      window.map.off("click");
    }
    // Initialize map event handlers
    function initializeMapHandlers() {
      window.map.on("click", function(e) {
        console.log("Map clicked at:", e.latlng);
        deactivateAllDrawingTools();
      });
      window.map.on("draw:created", function(e) {
        console.log("Draw created event fired:", e);
        const layer = e.layer;
        // For polygons, force close if needed
        if (e.layerType === "polygon" && layer.getLatLngs) {
          const coords = layer.getLatLngs()[0];
          if (coords.length > 0 && !coords[0].equals(coords[coords.length - 1])) {
            coords.push(coords[0]);
            layer.setLatLngs(coords);
            console.log("Polygon closed");
          }
        }
        if (window.activeLayer) {
          try {
            window.activeLayer.addLayer(layer);
            console.log("Added drawing:", layer.toGeoJSON());
            openEditPopup(layer);
            saveToDatabase();
          } catch (error) {
            console.error("Error adding drawing:", error);
          }
        } else {
          console.warn("No active layer set for drawing");
        }
        deactivateAllDrawingTools();
      });
    }
    // Open popup to edit facility details
    function openEditPopup(layer) {
      const formHtml = `
        <div style="min-width: 200px;">
          <div class="form-group" style="margin-bottom: 10px;">
            <label for="facilityName">Facility Name:</label>
            <input id="facilityName" type="text" value="${layer.feature?.properties?.name || ''}" style="width: 100%;" />
          </div>
          <div class="form-group" style="margin-bottom: 10px;">
            <label for="facilityTypeCode">Type Code (PES/ES):</label>
            <input id="facilityTypeCode" type="text" value="${layer.feature?.properties?.typeCode || ''}" style="width: 100%;" placeholder="Enter PES or ES designator" />
          </div>
          <div class="form-group" style="margin-bottom: 10px;">
            <label for="facilityDescription">Description:</label>
            <textarea id="facilityDescription" style="width: 100%; height: 60px;">${layer.feature?.properties?.description || ''}</textarea>
          </div>
          <button id="facilitySaveButton" style="width: 100%; padding: 5px;">Save</button>
        </div>
      `;
      layer.bindPopup(formHtml).openPopup();
      setTimeout(() => {
        const saveBtn = document.getElementById("facilitySaveButton");
        if (saveBtn) {
          saveBtn.addEventListener("click", function() {
            const newName = document.getElementById("facilityName").value;
            const newTypeCode = document.getElementById("facilityTypeCode").value;
            const newDescription = document.getElementById("facilityDescription").value;
            layer.feature = layer.feature || {};
            layer.feature.properties = { name: newName, typeCode: newTypeCode, description: newDescription };
            layer.bindTooltip(newName + "<br>" + newTypeCode, { permanent: false });
            saveToDatabase();
            layer.closePopup();
          });
        }
      }, 100);
    }
    // Save active layer data to backend
    async function saveToDatabase() {
      const layerData = { layers: {} };
      Object.keys(window.activeLayer._layers).forEach(function(layerId) {
        const layer = window.activeLayer._layers[layerId];
        if (layer.toGeoJSON) {
          layerData.layers[layerId] = layer.toGeoJSON();
        }
      });
      console.log("Saving layer data:", JSON.stringify(layerData, null, 2));
      try {
        const response = await fetch("/api/save-layers", {
          method: "POST",
          headers: { "Content-Type": "application/json" },
          body: JSON.stringify(layerData)
        });
        if (!response.ok) throw new Error("Save failed");
        console.log("Save successful");
      } catch (error) {
        console.error("Error saving layers:", error);
      }
    }
    // Base layer dropdown
    let baseLayers = {
      "None": L.tileLayer(""),
      "OpenStreetMap": L.tileLayer("https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png", { attribution: "Â© OpenStreetMap contributors" }),
      "Google Satellite": L.tileLayer("https://mt1.google.com/vt/lyrs=s&x={x}&y={y}&z={z}"),
      "Google Streets": L.tileLayer("https://mt1.google.com/vt/lyrs=m&x={x}&y={y}&z={z}"),
      "Google Hybrid": L.tileLayer("https://mt1.google.com/vt/lyrs=y&x={x}&y={y}&z={z}")
    };
    async function initializeBaseLayerDropdown() {
      const baseLayerTool = document.getElementById("baseLayerTool");
      const baseLayerDropdown = document.getElementById("baseLayerDropdown");
      if (!baseLayerTool || !baseLayerDropdown) {
        console.error("Base layer elements not found");
        return;
      }
      baseLayerTool.addEventListener("click", (e) => {
        const rect = baseLayerTool.getBoundingClientRect();
        baseLayerDropdown.style.top = rect.bottom + 5 + "px";
        baseLayerDropdown.style.left = rect.left + "px";
        baseLayerDropdown.style.display = (baseLayerDropdown.style.display === "none" || baseLayerDropdown.style.display === "") ? "block" : "none";
      });
      baseLayerDropdown.innerHTML = "";
      Object.entries(baseLayers).forEach(([name, layer]) => {
        const option = document.createElement("div");
        option.className = "base-layer-option";
        const isActive = window.map.hasLayer(layer);
        option.innerHTML = `
          <input type="radio" name="baseLayer" id="base-${name}" ${isActive ? "checked" : ""}>
          <label for="base-${name}">${name}</label>
        `;
        option.onclick = () => {
          Object.values(baseLayers).forEach(l => window.map.removeLayer(l));
          if (name !== "None") { window.map.addLayer(layer); }
          baseLayerDropdown.style.display = "none";
        };
        baseLayerDropdown.appendChild(option);
      });
      document.addEventListener("click", (e) => {
        if (!e.target.closest(".menu-item") && !e.target.closest("#baseLayerTool") && !e.target.closest("#baseLayerDropdown")) {
          baseLayerDropdown.style.display = "none";
        }
      });
    }
    // Dummy implementations for layer loading/editing (adjust as needed)
    async function loadFromDatabase() {
      // This function should load layers from your backend and populate window.layers.
      // For now, we simulate with an empty object.
      window.layers = {};
      // After loading, update the draw-to-layer select.
      updateDrawToLayerSelect();
    }
    function updateDrawToLayerSelect() {
      const select = document.getElementById("drawToLayer");
      if (!select) return;
      select.innerHTML = "";
      Object.entries(window.layers).forEach(([name, layer]) => {
        const option = document.createElement("option");
        option.value = name;
        option.textContent = name;
        select.appendChild(option);
      });
      if (select.options.length > 0) {
        select.selectedIndex = 0;
        window.activeLayer = window.layers[select.options[0].value];
      }
    }
    // Left Panel Toggle
    const toggleLayersPanel = document.getElementById("toggleLayersPanel");
    const leftPanel = document.getElementById("leftPanel");
    const mapElement = document.getElementById("map");
    toggleLayersPanel.addEventListener("click", () => {
      leftPanel.classList.toggle("visible");
      mapElement.style.marginLeft = leftPanel.classList.contains("visible") ? "300px" : "0";
      window.map.invalidateSize();
    });
    function editLayer(layerName) {
      const layer = window.layers[layerName];
      if (!layer) return;
      const formHtml = `
        <div style="min-width: 200px;">
          <div class="form-group" style="margin-bottom: 10px;">
            <label>Layer Name: ${layerName}</label>
          </div>
          <div class="form-group" style="margin-bottom: 10px;">
            <label>
              <input type="checkbox" id="layerQDAnalyzed">
              QD Analyzed
            </label>
          </div>
          <button id="layerSaveButton" style="width: 100%; padding: 5px;">Save Changes</button>
        </div>
      `;
      const popup = L.popup().setLatLng(window.map.getCenter()).setContent(formHtml).openOn(window.map);
      setTimeout(() => {
        const saveBtn = document.getElementById("layerSaveButton");
        if (saveBtn) {
          saveBtn.addEventListener("click", () => {
            layer.properties = { ...layer.properties, isQDAnalyzed: document.getElementById("layerQDAnalyzed").checked };
            updateLayerControl();
            saveToDatabase();
            window.map.closePopup(popup);
          });
        }
      }, 100);
    }
    function updateLayerControl() {
      const layerControl = document.getElementById("layerControl");
      if (!layerControl) return;
      layerControl.innerHTML = "";
      Object.entries(window.layers).forEach(([name, layer]) => {
        const item = document.createElement("div");
        item.className = "layer-control-item";
        item.innerHTML = `
          <input type="checkbox" id="layer-${name}" ${window.map.hasLayer(layer) ? "checked" : ""}>
          <label for="layer-${name}">${name}</label>
          <button class="edit-layer-button" onclick="editLayer('${name}')"><i class="fas fa-edit"></i></button>
        `;
        item.querySelector("input").onchange = (e) => {
          if (e.target.checked) { window.map.addLayer(layer); } else { window.map.removeLayer(layer); }
        };
        layerControl.appendChild(item);
      });
    }
  </script>
</body>
</html>
