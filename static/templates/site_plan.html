<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <title>Explosive Safety Siting</title>
  <link rel="stylesheet" href="https://unpkg.com/leaflet@1.9.3/dist/leaflet.css" />
  <link rel="stylesheet" href="https://unpkg.com/leaflet-draw@1.0.4/dist/leaflet.draw.css" />
  <style>
    body {
      margin: 0;
      padding: 0;
      display: flex;
      flex-direction: column;
      height: 100vh;
    }
    .toolbars-container {
      flex-shrink: 0;
    }
    .file-toolbar {
      background-color: #f1f1f1;
      border-bottom: 1px solid #ccc;
      padding: 8px 16px;
    }
    .file-toolbar ul {
      list-style: none;
      margin: 0;
      padding: 0;
      display: flex;
      gap: 20px;
    }
    .file-toolbar li {
      cursor: pointer;
      white-space: nowrap;
    }
    .tool-toolbar {
      background-color: #fafafa;
      border-bottom: 1px solid #ccc;
      padding: 8px 16px;
      display: flex;
      align-items: center;
    }
    .location-select {
      margin-left: auto;
      display: flex;
      align-items: center;
      gap: 8px;
    }
    #map {
      flex-grow: 1;
      width: 100%;
      min-height: 0;
    }
    .leaflet-control-layers {
      background: white;
      padding: 6px;
      border-radius: 4px;
      box-shadow: 0 1px 5px rgba(0,0,0,0.4);
    }
  </style>
</head>
<body>
  <div class="toolbars-container">
    <nav class="file-toolbar">
      <ul>
        <li>File</li>
        <li>Edit</li>
        <li>View</li>
        <li>Tools</li>
        <li>Help</li>
      </ul>
    </nav>
    <nav class="tool-toolbar">
      <strong>Drawing Tools:</strong>
      <div class="location-select">
        <label for="locationSelect">Database Location:</label>
        <select id="locationSelect">
          <option value="baseA">Base A</option>
          <option value="baseB">Base B</option>
        </select>
      </div>
    </nav>
  </div>

  <div id="map"></div>

  <script src="https://unpkg.com/leaflet@1.9.3/dist/leaflet.js"></script>
  <script src="https://unpkg.com/leaflet-draw@1.0.4/dist/leaflet.draw.js"></script>

  <script>
    const map = L.map('map').setView([39.8283, -98.5795], 4);

    const baseLayers = {
      'OpenStreetMap': L.tileLayer('https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png', { maxZoom: 19 }),
      'Carto Light': L.tileLayer('https://cartodb-basemaps-{s}.global.ssl.fastly.net/light_all/{z}/{x}/{y}.png', { maxZoom: 19 })
    };

    baseLayers['OpenStreetMap'].addTo(map);

    const drawnItems = new L.FeatureGroup().addTo(map);

    L.control.layers(baseLayers, { 'Drawn Items': drawnItems }, {
      position: 'topright',
      collapsed: true
    }).addTo(map);

    const drawControl = new L.Control.Draw({
      position: 'topleft',
      edit: { featureGroup: drawnItems },
      draw: {
        polygon: {
          allowIntersection: false,
          showArea: true,
          drawError: { color: '#e1e100', message: '<strong>Error:</strong> Shape cannot intersect!' },
          shapeOptions: { color: '#2c3e50' }
        },
        marker: false,
        circlemarker: false,
        circle: false,
        rectangle: false,
        polyline: false
      }
    }).addTo(map);

    map.on(L.Draw.Event.CREATED, async function(e) {
      const layer = e.layer;
      drawnItems.addLayer(layer);

      try {
        const response = await fetch('/api/save_polygon', {
          method: 'POST',
          headers: { 'Content-Type': 'application/json' },
          body: JSON.stringify({
            location: document.getElementById('locationSelect').value,
            geometry: layer.toGeoJSON().geometry,
            properties: {}
          })
        });

        if (!response.ok) throw new Error('Failed to save polygon');
        const result = await response.json();
        console.log('Polygon saved:', result);
      } catch (error) {
        console.error('Error saving polygon:', error);
        drawnItems.removeLayer(layer);
        alert('Failed to save polygon. Please try again.');
      }
    });
  </script>
</body>
</html>