
<!DOCTYPE html>
<html>
<head>
    <title>QDPro Site Plan</title>
    <link rel="stylesheet" href="https://unpkg.com/leaflet@1.9.4/dist/leaflet.css" integrity="sha256-p4NxAoJBhIIN+hmNHrzRCf9tD/miZyoHS5obTRR9BMY=" crossorigin="anonymous"/>
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/leaflet.draw/1.0.4/leaflet.draw.css"/>
    <script src="https://unpkg.com/leaflet@1.9.4/dist/leaflet.js" integrity="sha256-20nQCchB9co0qIjJZRGuk2/Z9VM+kNiyxNV1lvTlZBo=" crossorigin="anonymous"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/leaflet.draw/1.0.4/leaflet.draw.js"></script>
    <style>
        #map {
            height: calc(100vh - 30px);
            width: calc(100% - 250px);
            margin-left: 250px;
            margin-top: 30px;
        }
        body {
            margin: 0;
            padding: 0;
            font-family: Arial, sans-serif;
            overflow: hidden;
        }
        .menu-bar {
            position: fixed;
            top: 0;
            left: 0;
            right: 0;
            height: 30px;
            background: #2b2d42;
            color: white;
            display: flex;
            z-index: 1001;
        }
        .menu-item {
            padding: 0 15px;
            line-height: 30px;
            cursor: pointer;
            position: relative;
        }
        .menu-item:hover {
            background: #4a4e69;
        }
        .dropdown {
            display: none;
            position: absolute;
            top: 100%;
            left: 0;
            background: #2b2d42;
            min-width: 200px;
            box-shadow: 0 2px 4px rgba(0,0,0,0.2);
            z-index: 1002;
        }
        .menu-item:hover .dropdown {
            display: block;
        }
        .dropdown-item {
            padding: 8px 15px;
            color: white;
            cursor: pointer;
        }
        .dropdown-item:hover {
            background: #4a4e69;
        }
        .dropdown-item {
            padding: 8px 15px;
            white-space: nowrap;
        }
        .dropdown-item:hover {
            background: #4a4e69;
        }
        .left-panel {
            position: fixed;
            left: 0;
            top: 30px;
            width: 250px;
            height: calc(100vh - 30px);
            background: #f8f9fa;
            border-right: 1px solid #dee2e6;
            z-index: 1000;
            overflow-y: auto;
            resize: horizontal;
        }
        .resize-handle {
            position: absolute;
            right: 0;
            top: 0;
            bottom: 0;
            width: 4px;
            cursor: ew-resize;
            background: #dee2e6;
        }
        .panel-section {
            padding: 10px;
            border-bottom: 1px solid #dee2e6;
        }
        .panel-title {
            font-weight: bold;
            margin-bottom: 10px;
        }
        .toolbar {
            position: fixed;
            top: 0;
            left: 0;
            right: 0;
            height: 60px;
            background: #2b2d42;
            color: white;
            display: flex;
            align-items: center;
            padding: 0 20px;
            box-shadow: 0 2px 4px rgba(0,0,0,0.2);
            z-index: 1000;
        }
        .tool-group {
            display: flex;
            align-items: center;
            margin-right: 20px;
        }
        .tool-group select, .tool-group button {
            margin: 0 5px;
            padding: 8px 12px;
            border: none;
            border-radius: 4px;
            background: #4a4e69;
            color: white;
            cursor: pointer;
        }
        .tool-group select:hover, .tool-group button:hover {
            background: #6b7299;
        }
        .tool-divider {
            width: 1px;
            height: 30px;
            background: #4a4e69;
            margin: 0 15px;
        }
    </style>
</head>
<body>
    <div class="menu-bar">
        <div class="menu-item">File
            <div class="dropdown">
                <div class="dropdown-item">New Analysis</div>
                <div class="dropdown-item">Open Project</div>
                <div class="dropdown-item">Save Project</div>
                <div class="dropdown-item">Export Data</div>
            </div>
        </div>
        <div class="menu-item">Tools
            <div class="dropdown">
                <div class="dropdown-item" id="measureDistance">Distance Measurement</div>
                <div class="dropdown-item" id="drawArc">Draw Arc</div>
                <div class="dropdown-item" id="analyzeQD">QD Analysis</div>
                <div class="dropdown-item">Area Calculator</div>
            </div>
        </div>
        <div class="menu-item">Analysis
            <div class="dropdown">
                <div class="dropdown-item">Spatial Analysis</div>
                <div class="dropdown-item">QD Analysis</div>
                <div class="dropdown-item">Risk Assessment</div>
                <div class="dropdown-item">Arc Analysis</div>
            </div>
        </div>
    </div>
    <div class="left-panel" id="leftPanel">
        <div class="resize-handle" id="resizeHandle"></div>
        <div class="panel-section">
            <div class="panel-title">Layers</div>
            <div id="layerControl"></div>
        </div>
    </div>
    <div id="map"></div>
    <style>
        .left-panel {
            min-width: 200px;
            max-width: 500px;
            width: 250px;
        }
        .resize-handle:hover {
            background: #999;
        }
    </style>
    <script>
        // Initialize map with OpenStreetMap as default
        const map = L.map('map', {
            center: [40.7128, -74.0060],
            zoom: 13,
            layers: [
                L.tileLayer('https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png', {
                    maxZoom: 19,
                    attribution: '© OpenStreetMap contributors'
                })
            ]
        });

        // Initialize drawing layer
        // Initialize feature groups for different layer types
        const drawnItems = new L.FeatureGroup();
        const facilityLayer = new L.FeatureGroup();
        const analysisLayer = new L.FeatureGroup();
        
        map.addLayer(drawnItems);
        map.addLayer(facilityLayer);
        map.addLayer(analysisLayer);

        // Add to layer control
        const overlayMaps = {
            "Drawn Items": drawnItems,
            "Facilities": facilityLayer,
            "Analysis": analysisLayer
        };

        // Add layer control to map
        L.control.layers(baseLayers, overlayMaps, {
            position: 'topleft',
            collapsed: false
        }).addTo(map);

        // Initialize drawing controls
        const drawControl = new L.Control.Draw({
            draw: {
                polygon: true,
                polyline: true,
                rectangle: true,
                circle: true,
                marker: true,
                circlemarker: false
            },
            edit: {
                featureGroup: drawnItems,
                remove: true
            }
        });
        map.addControl(drawControl);

        // Handle drawn items
        map.on('draw:created', function(e) {
            const layer = e.layer;
            drawnItems.addLayer(layer);
        });
        
        const osm = L.tileLayer('https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png', {
            maxZoom: 19,
            attribution: '© OpenStreetMap contributors'
        });

        const googleSat = L.tileLayer('https://{s}.google.com/vt/lyrs=s&x={x}&y={y}&z={z}', {
            maxZoom: 20,
            subdomains: ['mt0', 'mt1', 'mt2', 'mt3'],
            attribution: '© Google'
        });

        const googleStreets = L.tileLayer('https://{s}.google.com/vt/lyrs=m&x={x}&y={y}&z={z}', {
            maxZoom: 20,
            subdomains: ['mt0', 'mt1', 'mt2', 'mt3'],
            attribution: '© Google'
        });

        const googleHybrid = L.tileLayer('https://{s}.google.com/vt/lyrs=s,h&x={x}&y={y}&z={z}', {
            maxZoom: 20,
            subdomains: ['mt0', 'mt1', 'mt2', 'mt3'],
            attribution: '© Google'
        });

        const baseLayers = {
            "OpenStreetMap": osm,
            "Google Satellite": googleSat,
            "Google Streets": googleStreets,
            "Google Hybrid": googleHybrid
        };

        osm.addTo(map);
        L.control.layers(baseLayers).addTo(map);

        // Fetch and display facilities
        // Initialize tools
        let measureControl = null;

        document.getElementById('orgSelect').addEventListener('change', function(e) {
            // TODO: Implement updateFacilityTypes
            console.log('Selected organization:', e.target.value);
        });

        document.getElementById('measureDistance').addEventListener('click', function() {
            if (!measureControl) {
                measureControl = L.control.measure({
                    primaryLengthUnit: 'feet',
                    secondaryLengthUnit: 'miles',
                    primaryAreaUnit: 'sqfeet',
                    secondaryAreaUnit: 'acres'
                });
                measureControl.addTo(map);
            }
        });

        document.getElementById('drawArc').addEventListener('click', function() {
            // Toggle existing draw control visibility
            const drawToolbar = document.querySelector('.leaflet-draw');
            if (drawToolbar) {
                drawToolbar.style.display = drawToolbar.style.display === 'none' ? 'block' : 'none';
            }
        });

        document.getElementById('analyzeQD').addEventListener('click', async function() {
            const org = document.getElementById('orgSelect').value;
            const facilityType = document.getElementById('facilityType').value;
            // Implement QD analysis logic here
        });

        // Add resize functionality
        const leftPanel = document.getElementById('leftPanel');
        const resizeHandle = document.getElementById('resizeHandle');
        let isResizing = false;

        resizeHandle.addEventListener('mousedown', function(e) {
            isResizing = true;
            e.preventDefault();
            document.addEventListener('mousemove', handleResize);
            document.addEventListener('mouseup', stopResize);
        });

        function handleResize(e) {
            if (!isResizing) return;
            const newWidth = Math.min(Math.max(e.clientX, 200), 500);
            leftPanel.style.width = newWidth + 'px';
            document.getElementById('map').style.marginLeft = newWidth + 'px';
            document.getElementById('map').style.width = `calc(100% - ${newWidth}px)`;
            map.invalidateSize();
        }

        function stopResize() {
            isResizing = false;
            document.removeEventListener('mousemove', handleResize);
            document.removeEventListener('mouseup', stopResize);
        }

        // Load facilities
        fetch('/reports/facilities')
            .then(response => response.json())
            .then(facilities => {
                facilities.forEach(facility => {
                    L.marker([facility.lat, facility.lng])
                        .bindPopup(facility.name)
                        .addTo(facilityLayer);
                });
            })
            .catch(error => console.error('Error loading facilities:', error));
    </script>
</body>
</html>
