<!DOCTYPE html>
<html>
<head>
    <title>QDPro Site Plan</title>
    <link rel="stylesheet" href="https://unpkg.com/leaflet@1.9.4/dist/leaflet.css" crossorigin=""/>
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/5.15.4/css/all.min.css"/>
    <style>
        .tool-button {
            padding: 5px 10px;
            margin: 0 2px;
            background: #f8f9fa;
            border: 1px solid #dee2e6;
            border-radius: 3px;
            cursor: pointer;
        }
        .tool-button:hover {
            background: #e9ecef;
        }
        .scale-label, .editor-label {
            margin: 0 5px;
        }
        #scaleSelect {
            padding: 3px;
            border: 1px solid #dee2e6;
            border-radius: 3px;
        }
    </style>
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/leaflet.draw/1.0.4/leaflet.draw.css"/>
    <script src="https://unpkg.com/leaflet@1.9.4/dist/leaflet.js" crossorigin=""></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/leaflet.draw/1.0.4/leaflet.draw.js"></script>
    <style>
        #map {
            position: fixed;
            height: calc(100vh - 80px);
            width: 100%;
            margin-top: 80px;
            transition: all 0.3s ease;
        }
        .toolbar {
            position: fixed;
            top: 30px;
            left: 0;
            right: 0;
            height: 50px;
            background: #f8f9fa;
            border-bottom: 1px solid #dee2e6;
            display: flex;
            align-items: center;
            padding: 0 15px;
            z-index: 1002;
            pointer-events: auto;
        }
        .tool-group button {
            padding: 6px 12px;
            margin: 0 4px;
            border: 1px solid #dee2e6;
            border-radius: 4px;
            background: white;
            cursor: pointer;
        }
        .tool-group button:hover {
            background: #e9ecef;
        }
        body {
            margin: 0;
            padding: 0;
            font-family: Arial, sans-serif;
            overflow: hidden;
        }
        .menu-bar {
            position: fixed;
            top: 0;
            left: 0;
            right: 0;
            height: 30px;
            background: #2b2d42;
            color: white;
            display: flex;
            z-index: 1001;
        }
        .menu-item {
            padding: 0 15px;
            line-height: 30px;
            cursor: pointer;
            position: relative;
        }
        .menu-item:hover {
            background: #4a4e69;
        }
        .dropdown {
            display: none;
            position: absolute;
            top: 100%;
            left: 0;
            background: #2b2d42;
            min-width: 200px;
            box-shadow: 0 2px 4px rgba(0,0,0,0.2);
            z-index: 1002;
        }
        .menu-item:hover .dropdown {
            display: block;
        }
        .dropdown-item {
            padding: 8px 15px;
            color: white;
            cursor: pointer;
        }
        .dropdown-item:hover {
            background: #4a4e69;
        }
        .dropdown-item {
            padding: 8px 15px;
            white-space: nowrap;
        }
        .dropdown-item:hover {
            background: #4a4e69;
        }
        .left-panel {
            min-width: 250px;
            width: 250px;
            position: fixed;
            top: 80px;
            left: 0;
            height: calc(100vh - 80px);
            background: white;
            overflow: auto;
            border-right: 1px solid #dee2e6;
            z-index: 1000;
            transform: translateX(-100%);
            transition: transform 0.3s ease;
        }
        .left-panel.visible {
            transform: translateX(0);
        }
        .resize-handle {
            position: absolute;
            right: 0;
            top: 0;
            bottom: 0;
            width: 4px;
            cursor: ew-resize;
            background: #dee2e6;
        }
        .panel-section {
            padding: 10px;
            border-bottom: 1px solid #dee2e6;
        }
        .panel-title {
            font-weight: bold;
            margin-bottom: 10px;
        }
        .toolbar {
            position: fixed;
            top: 30px;
            left: 0;
            right: 0;
            height: 50px;
            background: #f8f9fa;
            border-bottom: 1px solid #dee2e6;
            display: flex;
            align-items: center;
            padding: 0 15px;
            z-index: 1001;
        }
        .tool-group {
            display: flex;
            align-items: center;
            margin-right: 20px;
        }
        .tool-group button {
            padding: 8px 12px;
            margin: 0 5px;
            border: 1px solid #dee2e6;
            border-radius: 4px;
            background: white;
            color: #333;
            cursor: pointer;
        }
        .tool-group button:hover {
            background: #e9ecef;
        }
        .tool-divider {
            width: 1px;
            height: 30px;
            background: #dee2e6;
            margin: 0 15px;
        }
    </style>
</head>
<body>
    <div class="menu-bar">
        <div class="menu-item">File</div>
        <div class="menu-item">Database Builder</div>
        <div class="menu-item">Edit</div>
        <div class="menu-item">Properties</div>
        <div class="menu-item">Reports</div>
        <div class="menu-item">Analysis</div>
        <div class="menu-item">View</div>
        <div class="menu-item">Admin Record</div>
        <div class="menu-item">Tools</div>
        <div class="menu-item">Help</div>
    </div>
    <div class="toolbar">
        <div class="tool-group">
            <button id="measureTool" class="tool-button" title="Measure"><i class="fas fa-ruler"></i></button>
        </div>
        <div class="tool-divider"></div>
        <div class="tool-group">
            <button id="toggleLayersPanel" class="tool-button" title="Toggle Layers Panel"><i class="fas fa-bars"></i></button>
            <button id="addLayerTool" class="tool-button" title="Add Layer"><i class="fas fa-layer-group"></i></button>
            <button id="printTool" class="tool-button" title="Print"><i class="fas fa-print"></i></button>
        </div>
        <div class="tool-group">
            <span class="scale-label">Scale:</span>
            <select id="scaleSelect">
                <option value="1000">1:1000</option>
                <option value="5000">1:5000</option>
                <option value="10000">1:10000</option>
            </select>
        </div>
        <div class="tool-group">
            <span class="editor-label">Editor:</span>
            <button id="editorTool" class="tool-button"><i class="fas fa-edit"></i></button>
        </div>
        <div class="tool-group">
            <button id="markupTool" class="tool-button" title="Markup"><i class="fas fa-pen"></i></button>
            <button id="wizardsTool" class="tool-button" title="Wizards"><i class="fas fa-magic"></i></button>
        </div>
    </div>
    <div class="left-panel" id="leftPanel">
        <div class="resize-handle" id="resizeHandle"></div>
        <div class="panel-section">
            <div class="panel-title" style="padding: 10px; background: #f8f9fa; border-bottom: 1px solid #dee2e6;">Layers Panel</div>
            <div id="layerControl" style="padding: 10px;"></div>
        </div>
    </div>
    <div id="map"></div>
    <script>
        // Initialize map with OpenStreetMap as default
        const map = L.map('map', {
            center: [40.7128, -74.0060],
            zoom: 13
        });

        L.tileLayer('https://tile.openstreetmap.org/{z}/{x}/{y}.png', {
            maxZoom: 19,
            attribution: '© OpenStreetMap contributors'
        }).addTo(map);

        // Force a map refresh
        setTimeout(() => {
            map.invalidateSize();
        }, 100);

        // Initialize drawing layer
        // Initialize feature groups for different layer types
        const drawnItems = new L.FeatureGroup();
        const facilityLayer = new L.FeatureGroup();
        const analysisLayer = new L.FeatureGroup();

        map.addLayer(drawnItems);
        map.addLayer(facilityLayer);
        map.addLayer(analysisLayer);

        // Add to layer control
        const overlayMaps = {
            "Drawn Items": drawnItems,
            "Facilities": facilityLayer,
            "Analysis": analysisLayer
        };

        const osm = L.tileLayer('https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png', {
            maxZoom: 19,
            attribution: '© OpenStreetMap contributors'
        });

        const googleSat = L.tileLayer('https://{s}.google.com/vt/lyrs=s&x={x}&y={y}&z={z}', {
            maxZoom: 20,
            subdomains: ['mt0', 'mt1', 'mt2', 'mt3'],
            attribution: '© Google'
        });

        const googleStreets = L.tileLayer('https://{s}.google.com/vt/lyrs=m&x={x}&y={y}&z={z}', {
            maxZoom: 20,
            subdomains: ['mt0', 'mt1', 'mt2', 'mt3'],
            attribution: '© Google'
        });

        const googleHybrid = L.tileLayer('https://{s}.google.com/vt/lyrs=s,h&x={x}&y={y}&z={z}', {
            maxZoom: 20,
            subdomains: ['mt0', 'mt1', 'mt2', 'mt3'],
            attribution: '© Google'
        });

        const baseLayers = {
            "OpenStreetMap": osm,
            "Google Satellite": googleSat,
            "Google Streets": googleStreets,
            "Google Hybrid": googleHybrid
        };


        // Add layer control to map
        L.control.layers(baseLayers, overlayMaps, {
            position: 'topleft',
            collapsed: false
        }).addTo(map);

        // Initialize drawing controls
        const drawControl = new L.Control.Draw({
            draw: {
                polygon: true,
                polyline: true,
                rectangle: true,
                circle: true,
                marker: true,
                circlemarker: false
            },
            edit: {
                featureGroup: drawnItems,
                remove: true
            }
        });
        map.addControl(drawControl);

        // Handle drawn items
        map.on('draw:created', function(e) {
            const layer = e.layer;
            drawnItems.addLayer(layer);
        });


        osm.addTo(map);

        // Fetch and display facilities
        // Initialize tools
        let measureControl = null;

        document.getElementById('orgSelect').addEventListener('change', function(e) {
            // TODO: Implement updateFacilityTypes
            console.log('Selected organization:', e.target.value);
        });

        document.getElementById('measureDistance').addEventListener('click', function() {
            if (!measureControl) {
                measureControl = L.control.measure({
                    primaryLengthUnit: 'feet',
                    secondaryLengthUnit: 'miles',
                    primaryAreaUnit: 'sqfeet',
                    secondaryAreaUnit: 'acres'
                });
                measureControl.addTo(map);
            }
        });

        document.getElementById('drawArc').addEventListener('click', function() {
            // Toggle existing draw control visibility
            const drawToolbar = document.querySelector('.leaflet-draw');
            if (drawToolbar) {
                drawToolbar.style.display = drawToolbar.style.display === 'none' ? 'block' : 'none';
            }
        });

        document.getElementById('analyzeQD').addEventListener('click', async function() {
            const org = document.getElementById('orgSelect').value;
            const facilityType = document.getElementById('facilityType').value;
            // Implement QD analysis logic here
        });

        // Add resize functionality
        const leftPanel = document.getElementById('leftPanel');
        let isResizing = false;
        let startX;
        let startWidth;

        document.getElementById('resizeHandle').addEventListener('mousedown', function(e) {
            isResizing = true;
            startX = e.pageX;
            startWidth = parseInt(getComputedStyle(leftPanel).width, 10);
            document.addEventListener('mousemove', handleResize);
            document.addEventListener('mouseup', stopResize);
            e.preventDefault();
        });

        function handleResize(e) {
            if (!isResizing) return;
            const difference = e.pageX - startX;
            const newWidth = Math.min(Math.max(startWidth + difference, 200), 500);

            leftPanel.style.width = newWidth + 'px';
            document.getElementById('map').style.marginLeft = newWidth + 'px';
            document.getElementById('map').style.width = `calc(100% - ${newWidth}px)`;
            map.invalidateSize();
        }

        function stopResize() {
            isResizing = false;
            document.removeEventListener('mousemove', handleResize);
            document.removeEventListener('mouseup', stopResize);
        }

        // Add panel toggle functionality
        const toggleLayersBtn = document.getElementById('toggleLayersPanel');
        const panel = document.getElementById('leftPanel');
        const mapElement = document.getElementById('map');

        // Set initial state
        mapElement.style.marginLeft = '250px';
        mapElement.style.width = 'calc(100% - 250px)';
        panel.classList.add('visible');
        toggleLayersBtn.innerHTML = '<i class="fas fa-times"></i>';
        toggleLayersBtn.title = "Close Layers Panel";

        toggleLayersBtn.addEventListener('click', () => {
            const isVisible = panel.classList.contains('visible');
            if (isVisible) {
                panel.classList.remove('visible');
                mapElement.style.marginLeft = '0';
                mapElement.style.width = '100%';
                toggleLayersBtn.innerHTML = '<i class="fas fa-bars"></i>';
                toggleLayersBtn.title = "Show Layers Panel";
            } else {
                panel.classList.add('visible');
                mapElement.style.marginLeft = '250px';
                mapElement.style.width = 'calc(100% - 250px)';
                toggleLayersBtn.innerHTML = '<i class="fas fa-times"></i>';
                toggleLayersBtn.title = "Close Layers Panel";
            }
            setTimeout(() => map.invalidateSize(), 300);
        });

        // Load facilities
        fetch('/reports/facilities')
            .then(response => response.json())
            .then(facilities => {
                facilities.forEach(facility => {
                    L.marker([facility.lat, facility.lng])
                        .bindPopup(facility.name)
                        .addTo(facilityLayer);
                });
            })
            .catch(error => console.error('Error loading facilities:', error));
    </script>
</body>
</html>