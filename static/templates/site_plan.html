<!DOCTYPE html>
<html>
<head>
  <title>QDPro Minimal Working Example</title>
  <!-- Leaflet CSS -->
  <link 
    rel="stylesheet" 
    href="https://unpkg.com/leaflet@1.9.4/dist/leaflet.css" 
    crossorigin="anonymous"
  />
  <!-- Leaflet.draw CSS -->
  <link 
    rel="stylesheet" 
    href="https://cdnjs.cloudflare.com/ajax/libs/leaflet.draw/1.0.4/leaflet.draw.css" 
    crossorigin="anonymous"
  />
  <!-- Font Awesome -->
  <link 
    rel="stylesheet" 
    href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/5.15.4/css/all.min.css" 
    crossorigin="anonymous"
  />
  <!-- Leaflet and Leaflet.draw JS -->
  <script 
    src="https://unpkg.com/leaflet@1.9.4/dist/leaflet.js" 
    crossorigin="anonymous">
  </script>
  <script 
    src="https://cdnjs.cloudflare.com/ajax/libs/leaflet.draw/1.0.4/leaflet.draw.js" 
    crossorigin="anonymous">
  </script>

  <style>
    /* Basic Reset and Body Setup */
    * { margin: 0; padding: 0; box-sizing: border-box; }
    body { font-family: Arial, sans-serif; height: 100vh; overflow: hidden; }

    /* TOP NAVIGATION BAR */
    nav.main-toolbar {
      position: fixed;
      top: 0; left: 0; right: 0;
      height: 40px;
      background: #f1f1f1;
      border-bottom: 1px solid #ccc;
      display: flex;
      align-items: center;
      z-index: 3000;
      padding: 0 10px;
      white-space: nowrap;
    }
    .menu-item {
      padding: 0 15px;
      font-size: 14px;
      display: flex;
      align-items: center;
      cursor: pointer;
      position: relative;
    }
    .menu-item:hover { background: #e9ecef; }
    .menu-dropdown {
      display: none;
      position: fixed;
      background: white;
      min-width: 150px;
      border: 1px solid #ccc;
      border-radius: 4px;
      z-index: 3500;
    }
    .menu-dropdown-item {
      padding: 8px 12px;
      font-size: 14px;
      cursor: pointer;
    }
    .menu-dropdown-item:hover { background: #f0f0f0; }
    #dbStatus { margin-left: auto; }

    /* DRAWING TOOLBAR (Second Row) */
    .toolbar {
      position: fixed;
      top: 40px; left: 0; right: 0;
      height: 40px;
      background: #fff;
      border-bottom: 1px solid #ccc;
      display: flex;
      align-items: center;
      z-index: 2900;
      padding: 0 10px;
    }
    .tool-group {
      display: flex;
      align-items: center;
      margin-right: 10px;
    }
    .tool-button {
      padding: 6px; margin: 0 2px;
      border: 1px solid transparent; border-radius: 3px;
      background: #fff; color: #666;
      cursor: pointer; display: flex; align-items: center;
      justify-content: center; min-width: 32px; height: 32px;
    }
    .tool-button:hover { background: #f0f0f0; border-color: #ccc; }
    .tool-button.active { background: #e6f2ff; border-color: #99ccff; color: #0066cc; }

    /* MAP (Below the 2 Toolbars => top: 80px) */
    #map {
      position: fixed;
      top: 80px; 
      left: 0; right: 0; bottom: 0;
      z-index: 1000;
      background: #eee;
    }

    /* LEFT PANEL (Layer Control) */
    .left-panel {
      position: fixed;
      top: 80px;
      left: 0;
      width: 300px;
      height: calc(100vh - 80px);
      background: white;
      border-right: 1px solid #ccc;
      transform: translateX(-300px);
      transition: transform 0.3s ease;
      z-index: 1500;
      display: flex;
      flex-direction: column;
    }
    .left-panel.visible { transform: translateX(0); }
    .panel-header {
      padding: 15px;
      background: #f8f9fa;
      border-bottom: 1px solid #ccc;
      font-weight: bold;
    }
    .panel-content { padding: 15px; flex-grow: 1; overflow-y: auto; }

    /* BASE LAYER DROPDOWN */
    .base-layer-dropdown {
      position: fixed;
      background: white;
      padding: 10px;
      border: 1px solid #ccc;
      border-radius: 4px;
      box-shadow: 0 2px 4px rgba(0,0,0,0.1);
      z-index: 2800;
      display: none;
    }
  </style>
</head>
<body>
  <!-- TOP NAVIGATION BAR -->
  <nav class="main-toolbar">
    <div class="menu-item" onclick="toggleMenu(this, 'fileMenu')">File
      <div class="menu-dropdown" id="fileMenu">
        <div class="menu-dropdown-item" onclick="alert('New Location modal not implemented');">New Location</div>
        <div class="menu-dropdown-item" onclick="alert('Switch Location modal not implemented');">Switch Location</div>
        <div class="menu-dropdown-item" onclick="alert('Save to DB not implemented');">Save</div>
      </div>
    </div>
    <div class="menu-item" onclick="toggleMenu(this, 'editMenu')">Edit
      <div class="menu-dropdown" id="editMenu">
        <div class="menu-dropdown-item">Cut</div>
        <div class="menu-dropdown-item">Copy</div>
        <div class="menu-dropdown-item">Paste</div>
      </div>
    </div>
    <div class="menu-item" onclick="toggleMenu(this, 'viewMenu')">View
      <div class="menu-dropdown" id="viewMenu">
        <div class="menu-dropdown-item">Layers</div>
        <div class="menu-dropdown-item">Base Maps</div>
      </div>
    </div>
    <div class="menu-item" onclick="toggleMenu(this, 'toolsMenu')">Tools
      <div class="menu-dropdown" id="toolsMenu">
        <div class="menu-dropdown-item">QD Calculator</div>
        <div class="menu-dropdown-item">Measure</div>
      </div>
    </div>
    <div class="menu-item" onclick="toggleMenu(this, 'helpMenu')">Help
      <div class="menu-dropdown" id="helpMenu">
        <div class="menu-dropdown-item">Documentation</div>
        <div class="menu-dropdown-item">About</div>
      </div>
    </div>
    <div id="dbStatus">No location selected</div>
  </nav>

  <!-- SECOND TOOLBAR -->
  <div class="toolbar">
    <div class="tool-group">
      <button id="toggleLayersPanel" class="tool-button" title="Toggle Layers Panel">
        <i class="fas fa-bars"></i>
      </button>
      <button id="baseLayerTool" class="tool-button" title="Base Layers">
        <i class="fas fa-layer-group"></i>
      </button>
    </div>
    <div class="tool-group">
      <button id="selectTool" class="tool-button" title="Select Features">
        <i class="fas fa-mouse-pointer"></i>
      </button>
      <button id="panTool" class="tool-button active" title="Pan Map">
        <i class="fas fa-hand-paper"></i>
      </button>
    </div>
    <div class="tool-group">
      <button id="drawMarker" class="tool-button" title="Add Point">
        <i class="fas fa-map-marker-alt"></i>
      </button>
      <button id="drawPolygon" class="tool-button" title="Draw Polygon">
        <i class="fas fa-draw-polygon"></i>
      </button>
      <button id="drawRectangle" class="tool-button" title="Draw Rectangle">
        <i class="fas fa-square"></i>
      </button>
      <button id="drawCircle" class="tool-button" title="Draw Circle">
        <i class="fas fa-circle"></i>
      </button>
      <button id="drawPolyline" class="tool-button" title="Draw Line">
        <i class="fas fa-minus"></i>
      </button>
    </div>
  </div>

  <!-- LEFT PANEL (Layers) -->
  <div class="left-panel" id="leftPanel">
    <div class="panel-header">Layers Panel</div>
    <div class="panel-content">
      <div class="layer-select-container">
        <label for="drawToLayer"><strong>Draw to Layer:</strong></label>
        <select id="drawToLayer" style="width: 100%; margin-top: 5px; padding: 5px;"></select>
        <button style="margin-top: 10px; width: 100%;" onclick="alert('Add new layer not implemented');">
          Add New Layer
        </button>
      </div>
      <div id="layerControl" style="margin-top: 20px;"></div>
    </div>
  </div>

  <!-- BASE LAYER DROPDOWN -->
  <div id="baseLayerDropdown" class="base-layer-dropdown"></div>

  <!-- MAP CONTAINER -->
  <div id="map"></div>

  <script>
    // Minimal toggleMenu function so top nav menus appear
    window.toggleMenu = function(element, menuId) {
      const dropdown = document.getElementById(menuId);
      if (!dropdown) {
        console.error("Menu dropdown not found:", menuId);
        return;
      }
      // Close other menus
      document.querySelectorAll(".menu-dropdown").forEach(dd => {
        if (dd.id !== menuId) {
          dd.style.display = "none";
          dd.parentElement.classList.remove("active");
        }
      });
      // Toggle this menu
      const isVisible = dropdown.style.display === "block";
      dropdown.style.display = isVisible ? "none" : "block";
      element.classList.toggle("active", !isVisible);
      // Position dropdown
      if (!isVisible) {
        const rect = element.getBoundingClientRect();
        dropdown.style.position = "fixed";
        dropdown.style.top = rect.bottom + "px";
        dropdown.style.left = rect.left + "px";
        dropdown.style.zIndex = "3500";
      }
    };

    // 1) Initialize the Leaflet map
    let map;
    document.addEventListener("DOMContentLoaded", function() {
      console.log("DOM Content Loaded: Starting minimal QDPro example...");

      // Create the map
      map = L.map("map", {
        center: [39.8283, -98.5795],
        zoom: 4
      });
      // Add a default tile layer
      L.tileLayer("https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png", {
        attribution: "Â© OpenStreetMap contributors"
      }).addTo(map);
      console.log("Map initialized:", map);

      // 2) Create a default FeatureGroup for drawings
      const activeLayer = L.featureGroup().addTo(map);
      // Add a dictionary for layers
      const layers = { "Default": activeLayer };

      // 3) Setup Leaflet Draw tools
      const drawingTools = {
        polygon: new L.Draw.Polygon(map, {
          allowIntersection: false,
          showArea: true,
          drawError: { color: "#e1e100", timeout: 1000 },
          shapeOptions: { color: "#3388ff" }
        }),
        polyline: new L.Draw.Polyline(map, { shapeOptions: { color: "#3388ff", weight: 2 } }),
        rectangle: new L.Draw.Rectangle(map, { shapeOptions: { color: "#3388ff" } }),
        circle: new L.Draw.Circle(map, { shapeOptions: { color: "#3388ff" } }),
        marker: new L.Draw.Marker(map)
      };
      let isDrawing = false;

      function deactivateAllDrawingTools() {
        Object.values(drawingTools).forEach(tool => {
          if (tool && typeof tool.disable === "function") { tool.disable(); }
        });
        document.querySelectorAll(".tool-button").forEach(btn => btn.classList.remove("active"));
        document.getElementById("panTool").classList.add("active");
        isDrawing = false;
      }

      function activateDrawingTool(toolName) {
        deactivateAllDrawingTools();
        const tool = drawingTools[toolName];
        if (tool && typeof tool.enable === "function") {
          tool.enable();
          document.getElementById("draw" + toolName.charAt(0).toUpperCase() + toolName.slice(1)).classList.add("active");
          isDrawing = true;
        }
      }

      // 4) Hook up toolbar buttons
      document.getElementById("drawPolygon").addEventListener("click", e => {
        e.preventDefault(); activateDrawingTool("polygon");
      });
      document.getElementById("drawPolyline").addEventListener("click", e => {
        e.preventDefault(); activateDrawingTool("polyline");
      });
      document.getElementById("drawRectangle").addEventListener("click", e => {
        e.preventDefault(); activateDrawingTool("rectangle");
      });
      document.getElementById("drawCircle").addEventListener("click", e => {
        e.preventDefault(); activateDrawingTool("circle");
      });
      document.getElementById("drawMarker").addEventListener("click", e => {
        e.preventDefault(); activateDrawingTool("marker");
      });
      document.getElementById("panTool").addEventListener("click", e => {
        e.preventDefault(); deactivateAllDrawingTools();
      });
      document.getElementById("selectTool").addEventListener("click", e => {
        e.preventDefault(); deactivateAllDrawingTools();
        document.getElementById("selectTool").classList.add("active");
        // Minimal: no select logic here, just a placeholder
      });

      // 5) Left panel toggle
      const leftPanel = document.getElementById("leftPanel");
      const mapElement = document.getElementById("map");
      document.getElementById("toggleLayersPanel").addEventListener("click", () => {
        leftPanel.classList.toggle("visible");
        if (leftPanel.classList.contains("visible")) {
          mapElement.style.left = "300px";
          mapElement.style.width = "calc(100% - 300px)";
        } else {
          mapElement.style.left = "0";
          mapElement.style.width = "100%";
        }
        map.invalidateSize();
        console.log("Left panel toggled. Visible:", leftPanel.classList.contains("visible"));
      });

      // 6) Hook up Leaflet Draw's draw:created event
      map.on("draw:created", e => {
        console.log("draw:created event fired", e);
        const layer = e.layer;

        // For polygons, force closure
        if (e.layerType === "polygon" && layer.getLatLngs) {
          const coords = layer.getLatLngs()[0];
          if (coords.length > 0 && !coords[0].equals(coords[coords.length - 1])) {
            coords.push(coords[0]);
            layer.setLatLngs(coords);
          }
        }

        // Add the drawn shape to our active layer (in this minimal example, "Default")
        activeLayer.addLayer(layer);
        console.log("Shape added to 'Default' layer.");

        // Deactivate the drawing tool
        deactivateAllDrawingTools();
      });

      // 7) "Draw to Layer" dropdown (just a placeholder in this minimal example)
      const drawToLayerSelect = document.getElementById("drawToLayer");
      drawToLayerSelect.innerHTML = `<option value="Default">Default</option>`;
      // In a real scenario, you'd have multiple layers in 'layers' object, then pick one.
      drawToLayerSelect.addEventListener("change", e => {
        console.log("Selected layer:", e.target.value);
        // If you had multiple layers, you'd set activeLayer = layers[e.target.value];
      });

      // 8) Base layer dropdown logic
      const baseLayerTool = document.getElementById("baseLayerTool");
      const baseLayerDropdown = document.getElementById("baseLayerDropdown");
      baseLayerTool.addEventListener("click", () => {
        const rect = baseLayerTool.getBoundingClientRect();
        baseLayerDropdown.style.top = (rect.bottom + 5) + "px";
        baseLayerDropdown.style.left = rect.left + "px";
        baseLayerDropdown.style.display = 
          (baseLayerDropdown.style.display === "none" || baseLayerDropdown.style.display === "") ? "block" : "none";
      });
      document.addEventListener("click", (e) => {
        if (!e.target.closest("#baseLayerTool") && !e.target.closest("#baseLayerDropdown")) {
          baseLayerDropdown.style.display = "none";
        }
      });

      // Minimal example of base layers
      baseLayerDropdown.innerHTML = `
        <div style="padding:8px; border-bottom:1px solid #eee; cursor:pointer;" onclick="alert('Switch to OpenStreetMap base');">OpenStreetMap</div>
        <div style="padding:8px; border-bottom:1px solid #eee; cursor:pointer;" onclick="alert('Switch to Google Satellite');">Google Satellite</div>
      `;

      // 9) Some minimal placeholders for "File" menu
      console.log("Minimal QDPro example loaded. The map should appear below the 2 toolbars.");
    });
  </script>
</body>
</html>
