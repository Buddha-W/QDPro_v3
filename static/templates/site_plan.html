<!DOCTYPE html>
<html>
<head>
    <title>QDPro Site Plan</title>
    <!-- Leaflet CSS -->
    <link rel="stylesheet" href="https://unpkg.com/leaflet@1.9.4/dist/leaflet.css" />
    <!-- Leaflet Draw CSS -->
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/leaflet.draw/1.0.4/leaflet.draw.css"/>
    <!-- Font Awesome for icons -->
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.2/css/all.min.css" />
    <!-- Custom Styles -->
    <link rel="stylesheet" href="/static/css/ui-controls.css" />
    <link rel="stylesheet" href="/static/css/site-plan.css" />

    <!-- Leaflet JS -->
    <script src="https://unpkg.com/leaflet@1.9.4/dist/leaflet.js"></script>
    <!-- Leaflet Draw JS -->
    <script src="https://cdnjs.cloudflare.com/ajax/libs/leaflet.draw/1.0.4/leaflet.draw.js"></script>
    <!-- Custom Scripts -->
    <script src="/static/js/ui-controls.js"></script>
    <script src="/static/js/site-plan.js"></script>
</head>
<body>
    <div class="ui-container">
        <!-- Top Navigation Bar -->
        <nav class="menu-bar">
            <div class="menu-item">File
                <div class="dropdown-content">
                    <a href="#" id="new-project-btn">New Project</a>
                    <a href="#" id="open-project-btn">Open Project</a>
                    <a href="#" id="save-project-btn">Save Project</a>
                    <a href="#" id="export-project-btn">Export</a>
                </div>
            </div>
            <div class="menu-item">Edit
                <div class="dropdown-content">
                    <a href="#" id="undo-btn">Undo</a>
                    <a href="#" id="redo-btn">Redo</a>
                    <a href="#" id="delete-selected-btn">Delete Selected</a>
                </div>
            </div>
            <div class="menu-item">View
                <div class="dropdown-content">
                    <a href="#" id="zoom-in-btn">Zoom In</a>
                    <a href="#" id="zoom-out-btn">Zoom Out</a>
                    <a href="#" id="toggle-layers-btn">Toggle Layers Panel</a>
                </div>
            </div>
            <div class="menu-item">Analysis
                <div class="dropdown-content">
                    <a href="#" id="run-qd-analysis-btn">Run QD Analysis</a>
                    <a href="#" id="generate-report-btn">Generate Report</a>
                </div>
            </div>
        </nav>

        <!-- Toolbar -->
        <div class="toolbar">
            <button id="draw-polygon-btn" class="tool-button"><i class="fas fa-draw-polygon"></i> Polygon</button>
            <button id="draw-rectangle-btn" class="tool-button"><i class="fas fa-square"></i> Rectangle</button>
            <button id="draw-marker-btn" class="tool-button"><i class="fas fa-map-marker-alt"></i> Marker</button>
            <button id="edit-layer-btn" class="tool-button"><i class="fas fa-edit"></i> Edit</button>
            <button id="delete-layer-btn" class="tool-button"><i class="fas fa-trash"></i> Delete</button>
        </div>

        <!-- Content Area -->
        <div class="content-area">
            <!-- Layers Panel -->
            <div id="layers-panel" class="layers-panel">
                <h3>Layers</h3>
                <button id="add-new-layer" class="tool-button"><i class="fas fa-plus"></i> Add Layer</button>
                <ul class="layers-list"></ul>
            </div>

            <!-- Map Container -->
            <div class="map-container">
                <div id="map" style="width: 100%; height: 100%;"></div>
            </div>
        </div>
    </div>

    <!-- Modals for File Operations -->
    <div id="new-project-modal" class="modal">
        <div class="modal-content">
            <span class="close-modal">&times;</span>
            <h2>New Project</h2>
            <form id="new-project-form">
                <div class="form-group">
                    <label for="new-project-name">Project Name:</label>
                    <input type="text" id="new-project-name" required>
                </div>
                <button type="submit" class="btn btn-primary">Create</button>
            </form>
        </div>
    </div>

    <div id="open-project-modal" class="modal">
        <div class="modal-content">
            <span class="close-modal">&times;</span>
            <h2>Open Project</h2>
            <div id="projects-list" class="projects-list">
                <!-- Projects will be loaded here dynamically -->
            </div>
        </div>
    </div>

    <!-- Analysis Modal -->
    <div id="qd-analysis-modal" class="modal">
        <div class="modal-content">
            <span class="close-modal">&times;</span>
            <h2>Quantity Distance Analysis</h2>
            <form id="qd-analysis-form">
                <div class="form-group">
                    <label for="site-type">Site Type:</label>
                    <select id="site-type" required>
                        <option value="DOD">DOD</option>
                        <option value="DOE">DOE</option>
                    </select>
                </div>
                <div class="form-group">
                    <label for="material-type">Material Type:</label>
                    <select id="material-type" required>
                        <option value="General Explosive">General Explosive</option>
                        <option value="High Explosive">High Explosive</option>
                        <option value="Propellant">Propellant</option>
                    </select>
                </div>
                <div class="form-group">
                    <label for="quantity">Quantity (lbs):</label>
                    <input type="number" id="quantity" required min="0">
                </div>
                <button type="submit" class="btn btn-primary">Run Analysis</button>
            </form>
        </div>
    </div>

    <!-- Feature Properties Modal -->
    <div id="feature-properties-modal" class="modal">
        <div class="modal-content">
            <span class="close-modal">&times;</span>
            <h2>Feature Properties</h2>
            <form id="feature-properties-form">
                <div class="form-group">
                    <label for="feature-name">Name:</label>
                    <input type="text" id="feature-name">
                </div>
                <div class="form-group">
                    <label for="feature-type">Type:</label>
                    <select id="feature-type">
                        <option value="PES">Potential Explosion Site (PES)</option>
                        <option value="ES">Exposed Site (ES)</option>
                        <option value="Other">Other</option>
                    </select>
                </div>
                <div class="form-group pes-specific">
                    <label for="feature-quantity">Explosive Quantity (lbs):</label>
                    <input type="number" id="feature-quantity" min="0">
                </div>
                <button type="submit" class="btn btn-primary">Save</button>
            </form>
        </div>
    </div>

    <!-- JavaScript to initialize map and handle events -->
    <script>
        document.addEventListener('DOMContentLoaded', function() {
            // Initialize map
            if (!window.map) {
                window.map = L.map('map', {
                    center: [39.8283, -98.5795],
                    zoom: 4
                });

                // Add tile layer
                L.tileLayer('https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png', {
                    attribution: '&copy; <a href="https://www.openstreetmap.org/copyright">OpenStreetMap</a> contributors'
                }).addTo(window.map);

                // Initialize feature groups for different layer types
                window.featureGroups = {
                    facilities: new L.FeatureGroup().addTo(window.map),
                    safetyArcs: new L.FeatureGroup().addTo(window.map),
                    pesLocations: new L.FeatureGroup().addTo(window.map),
                    esLocations: new L.FeatureGroup().addTo(window.map)
                };

                // Initialize drawnItems for Leaflet.Draw
                window.drawnItems = new L.FeatureGroup();
                window.map.addLayer(window.drawnItems);

                console.log("Map initialized successfully");
            }

            // Menu item event listeners
            document.getElementById('toggle-layers-btn').addEventListener('click', function() {
                document.getElementById('layers-panel').classList.toggle('visible');
            });

            document.getElementById('save-project-btn').addEventListener('click', async function() {
                try {
                    const response = await fetch('/api/save', {
                        method: 'POST',
                        headers: {
                            'Content-Type': 'application/json',
                        },
                        body: JSON.stringify({
                            facilities: getGeoJsonFromFeatureGroup(window.featureGroups.facilities),
                            qdArcs: getGeoJsonFromFeatureGroup(window.featureGroups.safetyArcs),
                            analysis: getGeoJsonFromFeatureGroup(window.featureGroups.pesLocations)
                        }),
                    });

                    if (response.ok) {
                        alert('Project saved successfully');
                    } else {
                        alert('Failed to save project');
                    }
                } catch (error) {
                    console.error('Error saving project:', error);
                    alert('An error occurred while saving the project');
                }
            });

            document.getElementById('open-project-btn').addEventListener('click', async function() {
                try {
                    const response = await fetch('/api/load');
                    const data = await response.json();

                    // Clear existing layers
                    Object.values(window.featureGroups).forEach(group => group.clearLayers());

                    // Load facilities
                    if (data.facilities && data.facilities.features) {
                        addGeoJsonToFeatureGroup(data.facilities, window.featureGroups.facilities);
                    }

                    // Load QD arcs
                    if (data.qdArcs && data.qdArcs.features) {
                        addGeoJsonToFeatureGroup(data.qdArcs, window.featureGroups.safetyArcs);
                    }

                    // Load analysis results
                    if (data.analysis && data.analysis.features) {
                        addGeoJsonToFeatureGroup(data.analysis, window.featureGroups.pesLocations);
                    }

                    alert('Project loaded successfully');
                } catch (error) {
                    console.error('Error loading project:', error);
                    alert('An error occurred while loading the project');
                }
            });

            document.getElementById('run-qd-analysis-btn').addEventListener('click', function() {
                document.getElementById('qd-analysis-modal').style.display = 'block';
            });

            // Close modals when clicking the X
            document.querySelectorAll('.close-modal').forEach(function(closeBtn) {
                closeBtn.addEventListener('click', function() {
                    this.closest('.modal').style.display = 'none';
                });
            });

            // QD Analysis form submission
            document.getElementById('qd-analysis-form').addEventListener('submit', async function(e) {
                e.preventDefault();
                const siteType = document.getElementById('site-type').value;
                const materialType = document.getElementById('material-type').value;
                const quantity = parseFloat(document.getElementById('quantity').value);

                try {
                    const selectedFeatures = getSelectedFeatures();

                    const response = await fetch('/api/analyze_qd', {
                        method: 'POST',
                        headers: {
                            'Content-Type': 'application/json',
                        },
                        body: JSON.stringify({
                            site_type: siteType,
                            features: selectedFeatures,
                            quantity: quantity,
                            material_type: materialType
                        }),
                    });

                    const result = await response.json();

                    // Display analysis results
                    if (result.geojson) {
                        addGeoJsonToFeatureGroup(result.geojson, window.featureGroups.safetyArcs);
                    }

                    document.getElementById('qd-analysis-modal').style.display = 'none';
                } catch (error) {
                    console.error('Error performing QD analysis:', error);
                    alert('An error occurred during analysis');
                }
            });

            // Helper functions
            function getGeoJsonFromFeatureGroup(featureGroup) {
                const geoJson = {
                    type: 'FeatureCollection',
                    features: []
                };

                featureGroup.eachLayer(function(layer) {
                    if (layer.toGeoJSON) {
                        const feature = layer.toGeoJSON();
                        if (layer.options) {
                            feature.properties = { ...feature.properties, ...layer.options };
                        }
                        geoJson.features.push(feature);
                    }
                });

                return geoJson;
            }

            function addGeoJsonToFeatureGroup(geoJson, featureGroup) {
                if (geoJson.features) {
                    geoJson.features.forEach(function(feature) {
                        const layer = L.geoJSON(feature);
                        layer.eachLayer(function(l) {
                            if (feature.properties) {
                                l.options = { ...l.options, ...feature.properties };
                            }
                            featureGroup.addLayer(l);
                        });
                    });
                }
            }

            function getSelectedFeatures() {
                const selectedFeatures = [];
                Object.values(window.featureGroups).forEach(group => {
                    group.eachLayer(function(layer) {
                        if (layer.options && layer.options.selected && layer.toGeoJSON) {
                            selectedFeatures.push(layer.toGeoJSON());
                        }
                    });
                });
                return selectedFeatures;
            }

            // Map event handling for drawing features
            window.map.on('draw:created', function(e) {
                const layer = e.layer;
                window.drawnItems.addLayer(layer);

                // Open properties modal for the new feature
                openFeaturePropertiesModal(layer);
            });

            function openFeaturePropertiesModal(layer) {
                const modal = document.getElementById('feature-properties-modal');
                const form = document.getElementById('feature-properties-form');

                modal.style.display = 'block';

                // Reset form
                form.reset();

                // Store reference to the current layer
                form.dataset.layerId = window.drawnItems.getLayerId(layer);

                // Handle form submission
                form.onsubmit = function(e) {
                    e.preventDefault();

                    const name = document.getElementById('feature-name').value;
                    const type = document.getElementById('feature-type').value;
                    const quantity = document.getElementById('feature-quantity').value;

                    // Set properties on the layer
                    layer.options = {
                        ...layer.options,
                        name: name,
                        type: type,
                        quantity: quantity
                    };

                    // Move the layer to the appropriate feature group
                    window.drawnItems.removeLayer(layer);

                    if (type === 'PES') {
                        window.featureGroups.pesLocations.addLayer(layer);
                    } else if (type === 'ES') {
                        window.featureGroups.esLocations.addLayer(layer);
                    } else {
                        window.featureGroups.facilities.addLayer(layer);
                    }

                    modal.style.display = 'none';
                };
            }

            // Show/hide explosive quantity field based on feature type
            document.getElementById('feature-type').addEventListener('change', function() {
                const pesSpecificFields = document.querySelectorAll('.pes-specific');
                if (this.value === 'PES') {
                    pesSpecificFields.forEach(field => field.style.display = 'block');
                } else {
                    pesSpecificFields.forEach(field => field.style.display = 'none');
                }
            });
        });
    </script>
</body>
</html>