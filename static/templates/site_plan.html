<!DOCTYPE html>
<html>
<head>
    <title>QDPro Site Plan</title>
    <link rel="stylesheet" href="https://unpkg.com/leaflet@1.9.4/dist/leaflet.css" />
    <link rel="stylesheet" href="https://unpkg.com/leaflet-draw@1.0.4/dist/leaflet.draw.css" />
    <style>
        #map { height: 600px; }
        .layers-control { margin: 10px; }
        body { margin: 0; padding: 0; }
        .analysis-panel {
            position: absolute;
            right: 10px;
            top: 10px; /*Adjusted top position*/
            background: white;
            padding: 10px;
            border-radius: 4px;
            box-shadow: 0 0 10px rgba(0,0,0,0.1);
            z-index: 1000;
        }
    </style>
</head>
<body>

    <div id="map"></div>
    <div id="analysis-panel" class="analysis-panel">
        <h3>QD Analysis</h3>
        <button id="analyzeBtn">Analyze</button> <div id="analysis-results"></div>
    </div>

    <script src="https://unpkg.com/leaflet@1.9.4/dist/leaflet.js"></script>
    <script src="https://unpkg.com/leaflet-draw@1.0.4/dist/leaflet.draw.js"></script>
    <script>
        const QDPro = {
            map: null,
            drawnItems: null,
            drawControl: null,

            init() {
                if (!this.map) {
                    console.log("Initializing map...");
                    this.map = L.map('map').setView([39.8283, -98.5795], 4);

                    L.tileLayer('https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png', {
                        attribution: 'Â© OpenStreetMap contributors'
                    }).addTo(this.map);

                    this.drawnItems = new L.FeatureGroup();
                    this.map.addLayer(this.drawnItems);

                    this.initDrawControls();
                    this.loadSavedLayers();
                    this.setupEventHandlers();
                }
            },

            initDrawControls() {
                this.drawControl = new L.Control.Draw({
                    draw: {
                        polygon: true,
                        circle: true,
                        marker: true,
                        rectangle: true
                    },
                    edit: {
                        featureGroup: this.drawnItems
                    }
                });
                this.map.addControl(this.drawControl);
            },

            async loadSavedLayers() {
                try {
                    const response = await fetch('/api/load-layers');
                    const data = await response.json();

                    if (data.layers && typeof data.layers === 'object') {
                        Object.entries(data.layers).forEach(([name, layerData]) => {
                            try {
                                if (this.isValidGeoJSON(layerData)) {
                                    const layer = L.geoJSON(layerData);
                                    this.drawnItems.addLayer(layer);
                                }
                            } catch (err) {
                                console.error(`Error loading layer ${name}:`, err);
                            }
                        });
                    }
                } catch (err) {
                    console.error("Error loading layers:", err);
                }
            },

            isValidGeoJSON(data) {
                return data && 
                       (data.type === 'Feature' || data.type === 'FeatureCollection') &&
                       data.features &&
                       Array.isArray(data.features);
            },

            setupEventHandlers() {
                this.map.on('draw:created', (e) => {
                    const layer = e.layer;
                    this.drawnItems.addLayer(layer);
                    this.saveLayer(layer);
                });

                document.getElementById('analyzeBtn')?.addEventListener('click', () => {
                    this.performAnalysis();
                });
            },

            async performAnalysis() {
                try {
                    const layers = this.drawnItems.toGeoJSON();
                    const response = await fetch('/api/analyze_qd', {
                        method: 'POST',
                        headers: {
                            'Content-Type': 'application/json'
                        },
                        body: JSON.stringify(layers)
                    });
                    const results = await response.json();
                    this.displayAnalysisResults(results);
                } catch (err) {
                    console.error("Analysis error:", err);
                }
            },

            displayAnalysisResults(results) {
                const resultsDiv = document.getElementById('analysis-results');
                if (resultsDiv) {
                    resultsDiv.innerHTML = `
                        <h3>Analysis Results</h3>
                        <pre>${JSON.stringify(results, null, 2)}</pre>
                    `;
                }
            },

            async saveLayer(layer) {
                try {
                    await fetch('/api/save-layers', {
                        method: 'POST',
                        headers: {
                            'Content-Type': 'application/json'
                        },
                        body: JSON.stringify({
                            layers: {
                                [Date.now()]: layer.toGeoJSON()
                            }
                        })
                    });
                } catch (err) {
                    console.error("Error saving layer:", err);
                }
            }
        };

        // Initialize map when DOM is ready
        document.addEventListener('DOMContentLoaded', () => QDPro.init());
    </script>
</body>
</html>