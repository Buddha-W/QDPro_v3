<!DOCTYPE html>
<html>
<head>
    <title>QDPro Site Plan</title>
    <link rel="stylesheet" href="https://unpkg.com/leaflet@1.9.4/dist/leaflet.css"/>
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/leaflet.draw/1.0.4/leaflet.draw.css"/>
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/5.15.4/css/all.min.css"/>
    <script src="https://unpkg.com/leaflet@1.9.4/dist/leaflet.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/leaflet.draw/1.0.4/leaflet.draw.js"></script>
    <style>
        body {
            margin: 0;
            padding: 0;
            font-family: Arial, sans-serif;
            overflow: hidden;
        }
        .menu-bar {
            position: fixed;
            top: 0;
            left: 0;
            right: 0;
            height: 30px;
            background: #2b2d42;
            color: white;
            display: flex;
            z-index: 1001;
        }
        .toolbar {
            position: fixed;
            top: 30px;
            left: 0;
            right: 0;
            height: 50px;
            background: #f8f9fa;
            border-bottom: 1px solid #dee2e6;
            display: flex;
            align-items: center;
            padding: 0 15px;
            z-index: 1001;
        }
        .tool-group {
            display: flex;
            align-items: center;
            margin-right: 20px;
        }
        .tool-button {
            padding: 8px 12px;
            margin: 0 5px;
            border: 1px solid #dee2e6;
            border-radius: 4px;
            background: white;
            color: #333;
            cursor: pointer;
        }
        .tool-button:hover {
            background: #e9ecef;
        }
        .left-panel {
            position: fixed;
            top: 80px;
            left: 0;
            width: 300px;
            height: calc(100vh - 80px);
            background: white;
            border-right: 1px solid #dee2e6;
            transform: translateX(-300px);
            transition: transform 0.3s ease;
            z-index: 1000;
        }
        .left-panel.visible {
            transform: translateX(0);
        }
        .panel-header {
            padding: 15px;
            background: #f8f9fa;
            border-bottom: 1px solid #dee2e6;
            font-weight: bold;
        }
        .panel-content {
            padding: 15px;
        }
        #map {
            position: fixed;
            height: calc(100vh - 80px);
            width: 100%;
            margin-top: 80px;
            transition: margin-left 0.3s ease;
        }
        .base-layer-dropdown {
            position: absolute;
            background: white;
            padding: 10px;
            border: 1px solid #dee2e6;
            border-radius: 4px;
            box-shadow: 0 2px 4px rgba(0,0,0,0.1);
            z-index: 1002;
            display: none;
        }
        .base-layer-option {
            padding: 8px;
            display: flex;
            align-items: center;
            gap: 8px;
            cursor: pointer;
        }
        .base-layer-option:hover {
            background: #f8f9fa;
        }
        .layer-control-item {
            padding: 8px 0;
            display: flex;
            align-items: center;
            gap: 8px;
        }
    </style>
</head>
<body>
    <div class="menu-bar">
        <div class="menu-item">File</div>
        <div class="menu-item">Edit</div>
        <div class="menu-item">View</div>
        <div class="menu-item">Tools</div>
        <div class="menu-item">Help</div>
    </div>

    <div class="toolbar">
        <div class="tool-group">
            <button id="toggleLayersPanel" class="tool-button" title="Toggle Layers Panel">
                <i class="fas fa-bars"></i>
            </button>
            <button id="baseLayerTool" class="tool-button" title="Base Layers">
                <i class="fas fa-layer-group"></i>
            </button>
        </div>
        <div class="tool-group">
            <button id="drawPolygon" class="tool-button" title="Draw Polygon">
                <i class="fas fa-draw-polygon"></i>
            </button>
            <button id="drawPolyline" class="tool-button" title="Draw Line">
                <i class="fas fa-minus"></i>
            </button>
            <button id="drawRectangle" class="tool-button" title="Draw Rectangle">
                <i class="fas fa-square"></i>
            </button>
            <button id="drawCircle" class="tool-button" title="Draw Circle">
                <i class="fas fa-circle"></i>
            </button>
            <button id="drawMarker" class="tool-button" title="Add Marker">
                <i class="fas fa-map-marker-alt"></i>
            </button>
        </div>
    </div>

    <div id="leftPanel" class="left-panel">
        <div class="panel-header">Layers Panel</div>
        <div class="panel-content" id="layerControl"></div>
    </div>

    <div id="baseLayerDropdown" class="base-layer-dropdown"></div>
    <div id="map"></div>

    <script>
        document.addEventListener('DOMContentLoaded', function() {
            // Initialize map
            const map = L.map('map', {
                center: [40.7128, -74.0060],
                zoom: 13,
                zoomControl: true
            });

            // Base layers
            const baseLayers = {
                'OpenStreetMap': L.tileLayer('https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png'),
                'Google Satellite': L.tileLayer('https://mt1.google.com/vt/lyrs=s&x={x}&y={y}&z={z}'),
                'Google Streets': L.tileLayer('https://mt1.google.com/vt/lyrs=m&x={x}&y={y}&z={z}'),
                'Google Hybrid': L.tileLayer('https://mt1.google.com/vt/lyrs=y&x={x}&y={y}&z={z}')
            };

            // Set default base layer
            baseLayers['OpenStreetMap'].addTo(map);

            // Initialize feature groups
            const drawnItems = new L.FeatureGroup();
            const facilityLayer = new L.FeatureGroup();
            const analysisLayer = new L.FeatureGroup();

            map.addLayer(drawnItems);
            map.addLayer(facilityLayer);
            map.addLayer(analysisLayer);

            // Drawing tools setup
            const drawingTools = {
                polygon: new L.Draw.Polygon(map),
                polyline: new L.Draw.Polyline(map),
                rectangle: new L.Draw.Rectangle(map),
                circle: new L.Draw.Circle(map),
                marker: new L.Draw.Marker(map)
            };

            // Drawing tool button handlers
            document.getElementById('drawPolygon').onclick = () => {
                Object.values(drawingTools).forEach(tool => tool.disable());
                drawingTools.polygon.enable();
            };
            document.getElementById('drawPolyline').onclick = () => {
                Object.values(drawingTools).forEach(tool => tool.disable());
                drawingTools.polyline.enable();
            };
            document.getElementById('drawRectangle').onclick = () => {
                Object.values(drawingTools).forEach(tool => tool.disable());
                drawingTools.rectangle.enable();
            };
            document.getElementById('drawCircle').onclick = () => {
                Object.values(drawingTools).forEach(tool => tool.disable());
                drawingTools.circle.enable();
            };
            document.getElementById('drawMarker').onclick = () => {
                Object.values(drawingTools).forEach(tool => tool.disable());
                drawingTools.marker.enable();
            };

            // Handle drawing events
            map.on('draw:created', function(e) {
                drawnItems.addLayer(e.layer);
            });

            // Base layer dropdown
            const baseLayerTool = document.getElementById('baseLayerTool');
            const baseLayerDropdown = document.getElementById('baseLayerDropdown');

            baseLayerTool.addEventListener('click', (e) => {
                const buttonRect = baseLayerTool.getBoundingClientRect();
                baseLayerDropdown.style.top = (buttonRect.bottom + 5) + 'px';
                baseLayerDropdown.style.left = buttonRect.left + 'px';
                baseLayerDropdown.style.display = baseLayerDropdown.style.display === 'none' ? 'block' : 'none';
            });

            // Create base layer options
            Object.entries(baseLayers).forEach(([name, layer]) => {
                const option = document.createElement('div');
                option.className = 'base-layer-option';
                option.innerHTML = `
                    <input type="radio" name="baseLayer" id="base-${name}" 
                           ${map.hasLayer(layer) ? 'checked' : ''}>
                    <label for="base-${name}">${name}</label>
                `;
                option.onclick = () => {
                    Object.values(baseLayers).forEach(l => map.removeLayer(l));
                    map.addLayer(layer);
                    baseLayerDropdown.style.display = 'none';
                };
                baseLayerDropdown.appendChild(option);
            });

            // Close dropdown when clicking outside
            document.addEventListener('click', (e) => {
                if (!baseLayerTool.contains(e.target) && 
                    !baseLayerDropdown.contains(e.target)) {
                    baseLayerDropdown.style.display = 'none';
                }
            });

            // Left panel toggle
            const toggleLayersPanel = document.getElementById('toggleLayersPanel');
            const leftPanel = document.getElementById('leftPanel');
            const mapElement = document.getElementById('map');

            toggleLayersPanel.addEventListener('click', () => {
                leftPanel.classList.toggle('visible');
                mapElement.style.marginLeft = leftPanel.classList.contains('visible') ? '300px' : '0';
                map.invalidateSize();
            });

            // Update layer control
            function updateLayerControl() {
                const layerControl = document.getElementById('layerControl');
                layerControl.innerHTML = '';

                const layers = {
                    'Drawn Items': drawnItems,
                    'Facilities': facilityLayer,
                    'Analysis': analysisLayer
                };

                Object.entries(layers).forEach(([name, layer]) => {
                    const item = document.createElement('div');
                    item.className = 'layer-control-item';
                    item.innerHTML = `
                        <input type="checkbox" id="layer-${name}" 
                               ${map.hasLayer(layer) ? 'checked' : ''}>
                        <label for="layer-${name}">${name}</label>
                    `;
                    item.querySelector('input').onchange = (e) => {
                        if (e.target.checked) {
                            map.addLayer(layer);
                        } else {
                            map.removeLayer(layer);
                        }
                    };
                    layerControl.appendChild(item);
                });
            }

            updateLayerControl();


            // Storage utilities (from original)
            const storageUtils = {
                saveLayer: (layer) => {
                    const layers = JSON.parse(localStorage.getItem('mapLayers') || '[]');
                    layers.push(layer);
                    localStorage.setItem('mapLayers', JSON.stringify(layers));
                },
                loadLayers: () => {
                    return JSON.parse(localStorage.getItem('mapLayers') || '[]');
                },
                saveBookmark: (bookmark) => {
                    const bookmarks = JSON.parse(localStorage.getItem('mapBookmarks') || '[]');
                    bookmarks.push(bookmark);
                    localStorage.setItem('mapBookmarks', JSON.stringify(bookmarks));
                },
                loadBookmarks: () => {
                    return JSON.parse(localStorage.getItem('mapBookmarks') || '[]');
                }
            };

            //Bookmarking functionality (from original)
            document.getElementById('bookmarkTool').addEventListener('click', (e) => {
                const dropdown = document.getElementById('bookmarkDropdown'); //this id is missing in edited code, but needed from original
                dropdown.style.display = dropdown.style.display === 'none' ? 'block' : 'none';
                dropdown.style.top = '90px';
                dropdown.style.right = '10px';
            });

            document.getElementById('addBookmark').addEventListener('click', () => {
                const name = prompt('Enter bookmark name:');
                if (name) {
                    const bookmark = {
                        name,
                        center: map.getCenter(),
                        zoom: map.getZoom()
                    };
                    storageUtils.saveBookmark(bookmark);
                    updateBookmarkList();
                }
            });

            function updateBookmarkList() {
                const list = document.getElementById('bookmarkList');
                list.innerHTML = '';
                storageUtils.loadBookmarks().forEach(bookmark => {
                    const item = document.createElement('div');
                    item.style.padding = '5px';
                    item.style.cursor = 'pointer';
                    item.innerText = bookmark.name;
                    item.addEventListener('click', () => {
                        map.setView([bookmark.center.lat, bookmark.center.lng], bookmark.zoom);
                    });
                    list.appendChild(item);
                });
            }

             // Fetch and display facilities (from original)
            fetch('/reports/facilities')
                .then(response => response.json())
                .then(facilities => {
                    facilities.forEach(facility => {
                        L.marker([facility.lat, facility.lng])
                            .bindPopup(facility.name)
                            .addTo(facilityLayer);
                    });
                })
                .catch(error => console.error('Error loading facilities:', error));


        });
    </script>
</body>
</html>