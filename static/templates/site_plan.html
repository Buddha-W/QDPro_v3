<!DOCTYPE html>
<html>
<head>
    <title>QDPro - Explosive Site Planning</title>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">

    <!-- Leaflet CSS -->
    <link rel="stylesheet" href="https://unpkg.com/leaflet@1.9.4/dist/leaflet.css"
          integrity="sha256-p4NxAoJBhIIN+hmNHrzRCf9tD/miZyoHS5obTRR9BMY="
          crossorigin="anonymous" />

    <!-- Leaflet JS -->
    <script src="https://unpkg.com/leaflet@1.9.4/dist/leaflet.js"
            integrity="sha256-20nQCchB9co0qIjJZRGuk2/Z9VM+kNiyxNV1lvTlZBo="
            crossorigin="anonymous"></script>

    <!-- Leaflet Draw CSS -->
    <link rel="stylesheet" href="https://unpkg.com/leaflet-draw@1.0.4/dist/leaflet.draw.css" />

    <!-- Leaflet Draw JS -->
    <script src="https://unpkg.com/leaflet-draw@1.0.4/dist/leaflet.draw.js"></script>

    <link rel="stylesheet" href="/static/css/modal.css">
    <style>
        body {
            font-family: Arial, sans-serif;
            margin: 0;
            padding: 0;
            display: flex;
            flex-direction: column;
            height: 100vh;
        }
        #header {
            background-color: #333;
            color: white;
            padding: 10px;
            display: flex;
            justify-content: space-between;
            align-items: center;
        }
        #map {
            flex-grow: 1;
            width: 100%;
        }
        .menu-bar {
            display: flex;
            gap: 10px;
        }
        .menu-item {
            cursor: pointer;
            padding: 5px 10px;
        }
        .menu-item:hover {
            background-color: #555;
        }
        .modal {
            display: none;
            position: fixed;
            z-index: 1000;
            left: 0;
            top: 0;
            width: 100%;
            height: 100%;
            background-color: rgba(0,0,0,0.4);
        }
        .modal-content {
            background-color: white;
            margin: 15% auto;
            padding: 20px;
            border: 1px solid #888;
            width: 50%;
            border-radius: 5px;
        }
        .close-button {
            color: #aaa;
            float: right;
            font-size: 28px;
            font-weight: bold;
            cursor: pointer;
        }
        .feature-properties-form {
            display: flex;
            flex-direction: column;
            gap: 10px;
        }
        .form-group {
            display: flex;
            flex-direction: column;
        }
        .form-group label {
            margin-bottom: 5px;
        }
        .form-group input, .form-group select, .form-group textarea {
            padding: 8px;
            border: 1px solid #ddd;
            border-radius: 4px;
        }
        .button-group {
            display: flex;
            justify-content: flex-end;
            gap: 10px;
            margin-top: 15px;
        }
        .button {
            padding: 8px 16px;
            border: none;
            border-radius: 4px;
            cursor: pointer;
        }
        .primary-button {
            background-color: #4CAF50;
            color: white;
        }
        .secondary-button {
            background-color: #f44336;
            color: white;
        }
    </style>
</head>
<body>
    <div id="header">
        <h1>QDPro</h1>
        <div class="menu-bar">
            <div class="menu-item" id="fileMenuButton">File</div>
            <div class="menu-item" id="editMenuButton">Edit</div>
            <div class="menu-item" id="viewMenuButton">View</div>
            <div class="menu-item" id="helpMenuButton">Help</div>
            <button id="testButton">Test Feature Editor</button>
        </div>
    </div>

    <div id="map"></div>

    <!-- File Modal -->
    <div id="fileModal" class="modal">
        <div class="modal-content">
            <span class="close-button" id="closeFileModal">&times;</span>
            <h2>File Operations</h2>
            <div class="button-group">
                <button class="button primary-button" id="newProjectButton">New Project</button>
                <button class="button primary-button" id="saveProjectButton">Save Project</button>
                <button class="button primary-button" id="loadProjectButton">Load Project</button>
            </div>
        </div>
    </div>

    <!-- Feature Properties Modal -->
    <div id="featurePropertiesModal" class="modal">
        <div class="modal-content">
            <span class="close-button" id="closeFeaturePropertiesModal">&times;</span>
            <h2>Feature Properties</h2>
            <form id="featurePropertiesForm" class="feature-properties-form">
                <div class="form-group">
                    <label for="featureName">Name</label>
                    <input type="text" id="featureName" name="name" required>
                </div>
                <div class="form-group">
                    <label for="featureType">Type</label>
                    <select id="featureType" name="type">
                        <option value="Polygon">Polygon</option>
                        <option value="Point">Point</option>
                        <option value="LineString">Line</option>
                    </select>
                </div>
                <div class="form-group">
                    <label for="featureDescription">Description</label>
                    <textarea id="featureDescription" name="description" rows="4"></textarea>
                </div>
                <div class="button-group">
                    <button type="submit" class="button primary-button">Save</button>
                    <button type="button" id="deleteFeatureButton" class="button secondary-button">Delete</button>
                </div>
            </form>
        </div>
    </div>

    <script src="/static/js/error-detector.js"></script>
    <script src="/static/js/map-initialize.js"></script>
    <script src="/static/js/feature-editor-initialize.js"></script>
    <script src="/static/js/ui-controls.js"></script>

    <script>
        //Preserving original Javascript functions and adding event listeners for the new modals
        window.toggleMenu = function(element, menuId) {
          const dropdown = document.getElementById(menuId);
          document.querySelectorAll(".menu-dropdown").forEach(dd => {
            if (dd.id !== menuId) { dd.style.display = "none"; dd.parentElement.classList.remove("active"); }
          });
          const isVisible = dropdown.style.display === "block";
          dropdown.style.display = isVisible ? "none" : "block";
          element.classList.toggle("active", !isVisible);
          if (!isVisible) {
            const rect = element.getBoundingClientRect();
            dropdown.style.top = rect.bottom + "px";
            dropdown.style.left = rect.left + "px";
          }
        };

        const QDPro = { /* ... rest of QDPro object from original code ... */ };

        function setStatusMessage(message, type) { /* ... setStatusMessage function from original code ... */ }

        function clearAllLayers() { /* ... clearAllLayers function from original code ... */ }


        function showNewLocationModal() { QDPro.showNewLocationModal(); }
        function closeNewLocationModal() { QDPro.closeNewLocationModal(); }
        function createNewLocation() { QDPro.createNewLocation(); }
        function showSwitchLocationModal() { QDPro.showSwitchLocationModal(); }
        function closeSwitchLocationModal() { QDPro.closeSwitchLocationModal(); }
        function showAddLayerModal() { QDPro.showAddLayerModal(); }
        function closeAddLayerModal() { QDPro.closeAddLayerModal(); }
        function createNewLayer() { QDPro.createNewLayer(); }
        function saveProject() { QDPro.saveProject(); }
        function loadProject() { QDPro.loadProject(); }

        function showLayerEditModal(layerName) { QDPro.showLayerEditModal(layerName); }
        function closeLayerEditModal() { QDPro.closeLayerEditModal(); }
        function saveLayerEdits() { QDPro.saveLayerEdits(); }

        // Initialize status display
        document.getElementById('dbStatus').textContent = "No location loaded";

        // Load last used location if available
        (async function loadLastLocation() {
          const lastLocationId = localStorage.getItem('lastLocationId');
          if (lastLocationId) {
            try {
              console.log("Loading last used location:", lastLocationId);
              await QDPro.switchToLocation(parseInt(lastLocationId, 10));
              console.log("Last location loaded successfully");
            } catch (error) {
              console.error("Failed to load last location:", error);
              document.getElementById('dbStatus').textContent = "No location loaded";
            }
          }
        })();

        // Add database connection status check
        async function checkDatabaseConnection() {
          try {
            const response = await fetch('/api/db_status');
            if (response.ok) {
              // Only update if no location is currently displayed
              const currentStatus = document.getElementById('dbStatus').textContent;
              if (!currentStatus.includes("Location:")) {
                document.getElementById('dbStatus').textContent = "Database connection successful";
              }
            } else {
              document.getElementById('dbStatus').textContent = "Database connection failed";
            }
          } catch (e) {
            document.getElementById('dbStatus').textContent = "Database connection error";
          }
        }

        // Check database connection on page load
        document.addEventListener('DOMContentLoaded', function() {
          setTimeout(checkDatabaseConnection, 1000);
        });

        //Helper function to update location display
        function updateLocationDisplay(locationName) {
          document.getElementById('dbStatus').textContent = `Location: ${locationName}`;
        }

        function closeFeaturePropertiesModal() {
          document.getElementById('featurePropertiesModal').style.display = 'none';
        }

        document.addEventListener("DOMContentLoaded", () => QDPro.init());


        //Adding event listeners to new modals
        document.getElementById('fileMenuButton').addEventListener('click', () => {
            document.getElementById('fileModal').style.display = 'block';
        });
        document.getElementById('closeFileModal').addEventListener('click', () => {
            document.getElementById('fileModal').style.display = 'none';
        });
        document.getElementById('closeFeaturePropertiesModal').addEventListener('click', closeFeaturePropertiesModal);

        // Create a sample project to test with
        document.addEventListener('DOMContentLoaded', function() {
          // Wait for map to be initialized
          const waitForMap = setInterval(function() {
            if (window.map) {
              clearInterval(waitForMap);

              // Create a sample polygon
              const coords = [
                [51.509, -0.08],
                [51.503, -0.06],
                [51.51, -0.047]
              ];

              const polygon = L.polygon(coords).addTo(window.map);
              polygon.feature = {
                type: 'Feature',
                properties: {
                  name: 'Test Polygon'
                }
              };

              // Add click handler
              if (typeof window.addLayerClickHandlers === 'function') {
                window.addLayerClickHandlers(polygon);
              } else {
                console.error('addLayerClickHandlers function not available');
                // Fallback
                polygon.on('click', function() {
                  window.openFeatureEditor(polygon.feature.properties);
                });
              }

              // Center the map on the polygon
              window.map.fitBounds(polygon.getBounds());

              // Test button
              document.getElementById('testButton').addEventListener('click', function() {
                window.openFeatureEditor(polygon.feature.properties);
              });

              // Save to localStorage for testing load
              const sampleProject = {
                layers: [
                  {
                    name: 'Test Polygon',
                    coordinates: coords
                  }
                ]
              };
              localStorage.setItem('savedProject', JSON.stringify(sampleProject));

              console.log('Test setup complete');
            }
          }, 100);
        });
    </script>
    <script src="/static/js/custom-modal.js"></script>
    <script src="https://kit.fontawesome.com/a076d05399.js"></script>
    
</body>
</html>