<!DOCTYPE html>
<html>
<head>
  <title>QDPro Site Plan</title>
  <!-- Leaflet CSS -->
  <link rel="stylesheet" href="https://unpkg.com/leaflet@1.9.4/dist/leaflet.css" crossorigin="anonymous"/>
  <!-- Leaflet.draw CSS -->
  <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/leaflet.draw/1.0.4/leaflet.draw.css" crossorigin="anonymous"/>
  <!-- Font Awesome -->
  <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/5.15.4/css/all.min.css" crossorigin="anonymous"/>
  <!-- Leaflet and Leaflet.draw JS -->
  <script src="https://unpkg.com/leaflet@1.9.4/dist/leaflet.js" crossorigin="anonymous"></script>
  <script src="https://cdnjs.cloudflare.com/ajax/libs/leaflet.draw/1.0.4/leaflet.draw.js" crossorigin="anonymous"></script>
  <style>
    /* RESET */
    * { margin: 0; padding: 0; box-sizing: border-box; }
    body { font-family: Arial, sans-serif; }

    /* TOP NAVIGATION BAR (File, Edit, View, Tools, Help) */
    nav.main-toolbar {
      position: fixed;
      top: 0; left: 0; right: 0;
      height: 40px;
      background: #f1f1f1;
      border-bottom: 1px solid #ccc;
      display: flex;
      align-items: center;
      z-index: 3000;
      padding: 0 10px;
      white-space: nowrap;
    }
    nav.main-toolbar .menu-item {
      padding: 0 15px;
      font-size: 14px;
      display: flex;
      align-items: center;
      cursor: pointer;
      position: relative;
    }
    nav.main-toolbar .menu-item:hover { background: #e9ecef; }
    nav.main-toolbar .menu-dropdown {
      display: none;
      position: fixed;
      background: white;
      min-width: 150px;
      border: 1px solid #ccc;
      border-radius: 4px;
      z-index: 3500;
    }
    nav.main-toolbar .menu-dropdown .menu-dropdown-item {
      padding: 8px 12px;
      font-size: 14px;
      cursor: pointer;
      white-space: nowrap;
    }
    nav.main-toolbar .menu-dropdown .menu-dropdown-item:hover { background: #f0f0f0; }
    #dbStatus { margin-left: auto; }

    /* DRAWING TOOLBAR (Second Row) */
    .toolbar {
      position: fixed;
      top: 40px; left: 0; right: 0;
      height: 40px;
      background: #fff;
      border-bottom: 1px solid #ccc;
      display: flex;
      align-items: center;
      z-index: 2900;
      padding: 0 10px;
    }
    .toolbar .tool-group {
      display: flex;
      align-items: center;
      margin-right: 10px;
    }
    .toolbar .tool-button {
      padding: 6px;
      margin: 0 2px;
      border: 1px solid transparent;
      border-radius: 3px;
      background: #fff;
      color: #666;
      cursor: pointer;
      display: flex;
      align-items: center;
      justify-content: center;
      min-width: 32px;
      height: 32px;
    }
    .toolbar .tool-button:hover { background: #f0f0f0; border-color: #ccc; }
    .toolbar .tool-button.active { background: #e6f2ff; border-color: #99ccff; color: #0066cc; }
    .toolbar .tool-button i { font-size: 16px; }

    /* MAP CONTAINER (Below Toolbars) */
    #map {
      position: fixed;
      top: 80px; /* 40px nav + 40px toolbar */
      left: 0;
      right: 0;
      bottom: 0;
      z-index: 1000;
    }

    /* LEFT PANEL (Layer Control) */
    .left-panel {
      position: fixed;
      top: 80px;
      left: 0;
      width: 300px;
      height: calc(100vh - 80px);
      background: white;
      border-right: 1px solid #ccc;
      transform: translateX(-300px);
      transition: transform 0.3s ease;
      z-index: 1500;
      display: flex;
      flex-direction: column;
    }
    .left-panel.visible { transform: translateX(0); }
    .panel-header { padding: 15px; background: #f8f9fa; border-bottom: 1px solid #ccc; font-weight: bold; }
    .panel-content { padding: 15px; flex-grow: 1; overflow-y: auto; }

    /* BASE LAYER DROPDOWN */
    .base-layer-dropdown {
      position: fixed;
      background: white;
      padding: 10px;
      border: 1px solid #ccc;
      border-radius: 4px;
      box-shadow: 0 2px 4px rgba(0,0,0,0.1);
      z-index: 2800;
      display: none;
    }
  </style>
</head>
<body>
  <!-- TOP NAVIGATION BAR -->
  <nav class="main-toolbar">
    <div class="menu-item" onclick="toggleMenu(this, 'fileMenu')">File
      <div class="menu-dropdown" id="fileMenu">
        <div class="menu-dropdown-item" onclick="showNewLocationModal()">New Location</div>
        <div class="menu-dropdown-item" onclick="showSwitchLocationModal()">Switch Location</div>
        <div class="menu-dropdown-item" onclick="saveToDatabase()">Save</div>
      </div>
    </div>
    <div class="menu-item" onclick="toggleMenu(this, 'editMenu')">Edit
      <div class="menu-dropdown" id="editMenu">
        <div class="menu-dropdown-item">Cut</div>
        <div class="menu-dropdown-item">Copy</div>
        <div class="menu-dropdown-item">Paste</div>
      </div>
    </div>
    <div class="menu-item" onclick="toggleMenu(this, 'viewMenu')">View
      <div class="menu-dropdown" id="viewMenu">
        <div class="menu-dropdown-item">Layers</div>
        <div class="menu-dropdown-item">Base Maps</div>
      </div>
    </div>
    <div class="menu-item" onclick="toggleMenu(this, 'toolsMenu')">Tools
      <div class="menu-dropdown" id="toolsMenu">
        <div class="menu-dropdown-item">QD Calculator</div>
        <div class="menu-dropdown-item">Measure</div>
      </div>
    </div>
    <div class="menu-item" onclick="toggleMenu(this, 'helpMenu')">Help
      <div class="menu-dropdown" id="helpMenu">
        <div class="menu-dropdown-item">Documentation</div>
        <div class="menu-dropdown-item">About</div>
      </div>
    </div>
    <div id="dbStatus">No location selected</div>
  </nav>

  <!-- DRAWING TOOLBAR -->
  <div class="toolbar">
    <div class="tool-group">
      <button id="toggleLayersPanel" class="tool-button" title="Toggle Layers Panel">
        <i class="fas fa-bars"></i>
      </button>
      <button id="baseLayerTool" class="tool-button" title="Base Layers">
        <i class="fas fa-layer-group"></i>
      </button>
    </div>
    <div class="tool-group">
      <button id="selectTool" class="tool-button" title="Select Features">
        <i class="fas fa-mouse-pointer"></i>
      </button>
      <button id="panTool" class="tool-button active" title="Pan Map">
        <i class="fas fa-hand-paper"></i>
      </button>
    </div>
    <div class="tool-group">
      <button id="drawMarker" class="tool-button" title="Add Point">
        <i class="fas fa-map-marker-alt"></i>
      </button>
      <button id="drawPolygon" class="tool-button" title="Draw Polygon">
        <i class="fas fa-draw-polygon"></i>
      </button>
      <button id="drawRectangle" class="tool-button" title="Draw Rectangle">
        <i class="fas fa-square"></i>
      </button>
      <button id="drawCircle" class="tool-button" title="Draw Circle">
        <i class="fas fa-circle"></i>
      </button>
      <button id="drawPolyline" class="tool-button" title="Draw Line">
        <i class="fas fa-minus"></i>
      </button>
    </div>
  </div>

  <!-- LEFT PANEL (Layer Controls) -->
  <div class="left-panel" id="leftPanel">
    <div class="panel-header">Layers Panel</div>
    <div class="panel-content">
      <div class="layer-select-container">
        <label for="drawToLayer"><strong>Draw to Layer:</strong></label>
        <select id="drawToLayer" style="width: 100%; margin-top: 5px; padding: 5px;"></select>
        <button onclick="showAddLayerModal()" style="margin-top: 10px; width: 100%;">Add New Layer</button>
      </div>
      <div id="layerControl"></div>
    </div>
  </div>

  <!-- BASE LAYER DROPDOWN -->
  <div id="baseLayerDropdown" class="base-layer-dropdown"></div>

  <!-- MAP CONTAINER -->
  <div id="map"></div>

  <script>
    // Expose toggleMenu globally so onclick attributes can call it
    window.toggleMenu = function(element, menuId) {
      const dropdown = document.getElementById(menuId);
      if (!dropdown) {
        console.error("Menu dropdown not found:", menuId);
        return;
      }
      document.querySelectorAll(".menu-dropdown").forEach(dd => {
        if (dd.id !== menuId) {
          dd.style.display = "none";
          dd.parentElement.classList.remove("active");
        }
      });
      const isVisible = dropdown.style.display === "block";
      dropdown.style.display = isVisible ? "none" : "block";
      element.classList.toggle("active", !isVisible);
      if (!isVisible) {
        const rect = element.getBoundingClientRect();
        dropdown.style.position = "fixed";
        dropdown.style.top = rect.bottom + "px";
        dropdown.style.left = rect.left + "px";
        dropdown.style.zIndex = "3500";
      }
    };

    // Placeholder modal functions
    function showNewLocationModal() { alert("New Location modal not implemented yet."); }
    function showSwitchLocationModal() { alert("Switch Location modal not implemented yet."); }
    function showAddLayerModal() { alert("Add Layer modal not implemented yet."); }

    // QDPro main object for managing state and functionality
    const QDPro = {
      map: null,
      layers: {},
      activeLayer: null,
      drawingTools: {},
      currentLocation: null,
      baseLayers: {
        "OpenStreetMap": L.tileLayer("https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png", { attribution: "Â© OpenStreetMap contributors" }),
        "Google Satellite": L.tileLayer("https://mt1.google.com/vt/lyrs=s&x={x}&y={y}&z={z}"),
        "Google Streets": L.tileLayer("https://mt1.google.com/vt/lyrs=m&x={x}&y={y}&z={z}"),
        "Google Hybrid": L.tileLayer("https://mt1.google.com/vt/lyrs=y&x={x}&y={y}&z={z}"),
        "None": L.tileLayer("")
      },
      init: function() {
        console.log("Initializing QDPro application...");
        this.initMap();
        this.initDrawingTools();
        this.initUIComponents();
        this.initEventHandlers();
        this.loadFromDatabase();
      },
      initMap: function() {
        // Use the existing map instance (assumed to be created externally)
        this.map = window.map;
        if (!this.map) {
          console.error("Map instance not found!");
          return;
        }
        // Create a default layer group for drawings
        this.activeLayer = L.featureGroup().addTo(this.map);
        this.layers["Default"] = this.activeLayer;
        setTimeout(() => this.map.invalidateSize(), 100);
      },
      initDrawingTools: function() {
        this.drawingTools = {
          polygon: new L.Draw.Polygon(this.map, {
            allowIntersection: false,
            showArea: true,
            drawError: { color: "#e1e100", timeout: 1000 },
            shapeOptions: { color: "#3388ff" }
          }),
          polyline: new L.Draw.Polyline(this.map, { shapeOptions: { color: "#3388ff", weight: 2 } }),
          rectangle: new L.Draw.Rectangle(this.map, { shapeOptions: { color: "#3388ff" } }),
          circle: new L.Draw.Circle(this.map, { shapeOptions: { color: "#3388ff" } }),
          marker: new L.Draw.Marker(this.map)
        };
      },
      initUIComponents: function() {
        this.initToolbar();
        this.initLayersPanel();
        this.initBaseLayerDropdown();
      },
      initToolbar: function() {
        document.getElementById("drawPolygon").addEventListener("click", e => {
          e.preventDefault();
          this.activateDrawingTool("polygon");
        });
        document.getElementById("drawPolyline").addEventListener("click", e => {
          e.preventDefault();
          this.activateDrawingTool("polyline");
        });
        document.getElementById("drawRectangle").addEventListener("click", e => {
          e.preventDefault();
          this.activateDrawingTool("rectangle");
        });
        document.getElementById("drawCircle").addEventListener("click", e => {
          e.preventDefault();
          this.activateDrawingTool("circle");
        });
        document.getElementById("drawMarker").addEventListener("click", e => {
          e.preventDefault();
          this.activateDrawingTool("marker");
        });
        document.getElementById("panTool").addEventListener("click", e => {
          e.preventDefault();
          this.deactivateAllDrawingTools();
          document.getElementById("panTool").classList.add("active");
        });
        document.getElementById("selectTool").addEventListener("click", e => {
          e.preventDefault();
          this.deactivateAllDrawingTools();
          document.getElementById("selectTool").classList.add("active");
          this.enableSelectMode();
        });
        document.getElementById("toggleLayersPanel").addEventListener("click", () => {
          const leftPanel = document.getElementById("leftPanel");
          const mapElement = document.getElementById("map");
          leftPanel.classList.toggle("visible");
          if (leftPanel.classList.contains("visible")) {
            mapElement.style.left = "300px";
            mapElement.style.width = "calc(100% - 300px)";
          } else {
            mapElement.style.left = "0";
            mapElement.style.width = "100%";
          }
          this.map.invalidateSize();
          console.log("Left panel toggled. Visible:", leftPanel.classList.contains("visible"));
        });
      },
      initLayersPanel: function() {
        const drawToLayerSelect = document.getElementById("drawToLayer");
        drawToLayerSelect.addEventListener("change", e => {
          const selectedLayer = e.target.value;
          if (this.layers[selectedLayer]) {
            this.activeLayer = this.layers[selectedLayer];
            console.log("Active layer changed to:", selectedLayer);
          }
        });
        this.updateDrawToLayerSelect();
      },
      initBaseLayerDropdown: function() {
        const baseLayerTool = document.getElementById("baseLayerTool");
        const baseLayerDropdown = document.getElementById("baseLayerDropdown");
        baseLayerTool.addEventListener("click", e => {
          const rect = baseLayerTool.getBoundingClientRect();
          baseLayerDropdown.style.top = (rect.bottom + 5) + "px";
          baseLayerDropdown.style.left = rect.left + "px";
          baseLayerDropdown.style.display = 
            (baseLayerDropdown.style.display === "none" || baseLayerDropdown.style.display === "") ? "block" : "none";
        });
        baseLayerDropdown.innerHTML = "";
        Object.entries(this.baseLayers).forEach(([name, layer]) => {
          const option = document.createElement("div");
          option.className = "base-layer-option";
          option.style.padding = "8px";
          option.style.cursor = "pointer";
          option.style.borderBottom = "1px solid #eee";
          const isActive = this.map.hasLayer(layer);
          option.innerHTML = `
            <input type="radio" name="baseLayer" id="base-${name}" ${isActive ? "checked" : ""}>
            <label for="base-${name}" style="margin-left: 5px;">${name}</label>
          `;
          option.addEventListener("click", () => {
            Object.values(this.baseLayers).forEach(l => {
              if (this.map.hasLayer(l)) this.map.removeLayer(l);
            });
            if (name !== "None") { this.map.addLayer(layer); }
            baseLayerDropdown.style.display = "none";
          });
          baseLayerDropdown.appendChild(option);
        });
        document.addEventListener("click", (e) => {
          if (!e.target.closest("#baseLayerTool") && !e.target.closest("#baseLayerDropdown")) {
            baseLayerDropdown.style.display = "none";
          }
        });
      },
      initEventHandlers: function() {
        this.map.on("draw:created", e => {
          console.log("Draw created event fired:", e);
          const layer = e.layer;
          if (!this.activeLayer) {
            alert("Please select a layer to draw on");
            return;
          }
          if (e.layerType === "polygon" && layer.getLatLngs) {
            const coords = layer.getLatLngs()[0];
            if (coords.length > 0 && !coords[0].equals(coords[coords.length - 1])) {
              coords.push(coords[0]);
              layer.setLatLngs(coords);
            }
          }
          this.activeLayer.addLayer(layer);
          layer.feature = {
            type: "Feature",
            properties: {},
            geometry: layer.toGeoJSON().geometry
          };
          this.openEditPopup(layer);
          this.deactivateAllDrawingTools();
          this.saveToDatabase();
        });
        this.map.on("click", e => {
          if (!this.isDrawing) {
            console.log("Map clicked at:", e.latlng);
          }
        });
        const menuItems = document.querySelectorAll(".menu-item");
        menuItems.forEach(item => {
          item.addEventListener("click", e => { e.stopPropagation(); });
        });
        document.addEventListener("click", e => {
          if (!e.target.closest(".menu-item")) {
            document.querySelectorAll(".menu-dropdown").forEach(dd => { dd.style.display = "none"; });
          }
        });
        document.querySelector("#fileMenu .menu-dropdown-item:nth-child(1)")
          .addEventListener("click", () => this.createNewLocation());
        document.querySelector("#fileMenu .menu-dropdown-item:nth-child(2)")
          .addEventListener("click", () => this.showSwitchLocationModal());
        document.querySelector("#fileMenu .menu-dropdown-item:nth-child(3)")
          .addEventListener("click", () => this.saveToDatabase());
      },
      createNewLocation: async function() {
        const modalHtml = `
          <div id="newLocationModal" style="position: fixed; z-index: 4000; left: 0; top: 0; width: 100%; height: 100%; background: rgba(0,0,0,0.4); display: flex; align-items: center; justify-content: center;">
            <div style="background: #fff; padding: 20px; border: 1px solid #888; width: 80%; max-width: 500px;">
              <h2>Create New Location</h2>
              <input type="text" id="newLocationName" style="width: 100%; padding: 5px; margin: 10px 0;" placeholder="Enter location name">
              <div style="text-align: right; margin-top: 20px;">
                <button onclick="document.getElementById('newLocationModal').remove()" style="margin-right: 10px; padding: 5px 10px;">Cancel</button>
                <button id="createLocationBtn" style="padding: 5px 10px;">Create</button>
              </div>
            </div>
          </div>
        `;
        document.body.insertAdjacentHTML('beforeend', modalHtml);
        document.getElementById('createLocationBtn').onclick = async () => {
          const locationName = document.getElementById('newLocationName').value.trim();
          if (!locationName) return;
          try {
            const response = await fetch("/api/create_location", {
              method: "POST",
              headers: { "Content-Type": "application/json" },
              body: JSON.stringify({ location_name: locationName })
            });
            if (!response.ok) throw new Error("Failed to create location");
            const data = await response.json();
            this.currentLocation = data.id;
            document.getElementById("dbStatus").textContent = `Location: ${locationName}`;
            Object.values(this.layers).forEach(layer => {
              if (this.map.hasLayer(layer)) { this.map.removeLayer(layer); }
            });
            this.layers = {};
            this.layers["Default"] = L.featureGroup().addTo(this.map);
            this.activeLayer = this.layers["Default"];
            this.updateDrawToLayerSelect();
            this.updateLayerControl();
            document.getElementById('newLocationModal').remove();
          } catch (error) {
            console.error("Error creating location:", error);
            alert("Failed to create location");
            document.getElementById('newLocationModal').remove();
          }
        };
      },
      activateDrawingTool: function(toolName) {
        this.deactivateAllDrawingTools();
        if (this.drawingTools[toolName] && typeof this.drawingTools[toolName].enable === "function") {
          this.drawingTools[toolName].enable();
          document.getElementById(`draw${toolName.charAt(0).toUpperCase() + toolName.slice(1)}`)
            .classList.add("active");
          this.isDrawing = true;
        }
      },
      deactivateAllDrawingTools: function() {
        Object.values(this.drawingTools).forEach(tool => {
          if (tool && typeof tool.disable === "function") { tool.disable(); }
        });
        document.querySelectorAll(".tool-button").forEach(button => button.classList.remove("active"));
        document.getElementById("panTool").classList.add("active");
        this.isDrawing = false;
        this.map.off("mousemove");
        this.map.getContainer().style.cursor = "";
      },
      enableSelectMode: function() {
        this.map.getContainer().style.cursor = "pointer";
        Object.values(this.layers).forEach(layer => {
          layer.eachLayer(l => {
            l.on("click", e => {
              L.DomEvent.stopPropagation(e);
              this.openEditPopup(l);
            });
          });
        });
      },
      openEditPopup: function(layer) {
        const props = layer.feature?.properties || {};
        const formHtml = `
          <div style="min-width: 200px;">
            <div class="form-group" style="margin-bottom: 10px;">
              <label for="facilityName">Facility Name:</label>
              <input id="facilityName" type="text" value="${props.name || ''}" style="width: 100%; padding: 5px;" />
            </div>
            <div class="form-group" style="margin-bottom: 10px;">
              <label for="facilityTypeCode">Type Code (PES/ES):</label>
              <input id="facilityTypeCode" type="text" value="${props.typeCode || ''}" style="width: 100%; padding: 5px;" placeholder="Enter PES or ES designator" />
            </div>
            <div class="form-group" style="margin-bottom: 10px;">
              <label for="facilityDescription">Description:</label>
              <textarea id="facilityDescription" style="width: 100%; height: 60px; padding: 5px;">${props.description || ''}</textarea>
            </div>
            <button id="facilitySaveButton" style="width: 100%; padding: 5px; margin-top: 5px; cursor: pointer;">Save</button>
          </div>
        `;
        layer.bindPopup(formHtml).openPopup();
        setTimeout(() => {
          const saveBtn = document.getElementById("facilitySaveButton");
          if (saveBtn) {
            saveBtn.addEventListener("click", () => {
              const newName = document.getElementById("facilityName").value;
              const newTypeCode = document.getElementById("facilityTypeCode").value;
              const newDescription = document.getElementById("facilityDescription").value;
              layer.feature = layer.feature || {};
              layer.feature.properties = { name: newName, typeCode: newTypeCode, description: newDescription };
              if (newTypeCode) {
                if (newTypeCode.toUpperCase().includes("PES")) {
                  layer.setStyle({ color: "#ff0000", fillColor: "#ff6666", weight: 2, fillOpacity: 0.5 });
                } else if (newTypeCode.toUpperCase().includes("ES")) {
                  layer.setStyle({ color: "#00cc00", fillColor: "#66ff66", weight: 2, fillOpacity: 0.5 });
                }
              }
              layer.bindTooltip(newName + "<br>" + newTypeCode, { permanent: false });
              this.saveToDatabase();
              layer.closePopup();
            });
          }
        }, 100);
      },
      updateDrawToLayerSelect: function() {
        const select = document.getElementById("drawToLayer");
        if (!select) return;
        select.innerHTML = "";
        Object.keys(this.layers).forEach(name => {
          const option = document.createElement("option");
          option.value = name;
          option.textContent = name;
          select.appendChild(option);
        });
        if (select.options.length > 0 && !this.activeLayer) {
          select.selectedIndex = 0;
          this.activeLayer = this.layers[select.options[0].value];
        }
      },
      updateLayerControl: function() {
        const layerControl = document.getElementById("layerControl");
        if (!layerControl) {
          console.log("Layer control element not found");
          return;
        }
        layerControl.innerHTML = "";
        Object.entries(this.layers).forEach(([name, layer]) => {
          const item = document.createElement("div");
          item.style.padding = "8px 0";
          item.style.borderBottom = "1px solid #eee";
          item.innerHTML = `
            <div style="display: flex; justify-content: space-between; align-items: center;">
              <div>
                <input type="checkbox" id="layer-${name}" ${this.map.hasLayer(layer) ? "checked" : ""}>
                <label for="layer-${name}" style="margin-left: 5px;">${name}</label>
              </div>
              <div>
                <button class="edit-layer-btn" data-layer="${name}" style="background: none; border: none; cursor: pointer;">
                  <i class="fas fa-edit"></i>
                </button>
              </div>
            </div>
          `;
          layerControl.appendChild(item);
          const checkbox = item.querySelector(`#layer-${name}`);
          if (checkbox) {
            checkbox.addEventListener("change", e => {
              if (e.target.checked) {
                this.map.addLayer(layer);
              } else {
                this.map.removeLayer(layer);
              }
            });
          }
          const editBtn = item.querySelector(".edit-layer-btn");
          if (editBtn) {
            editBtn.addEventListener("click", () => { this.editLayer(name); });
          }
        });
      },
      showSwitchLocationModal: async function() {
        document.getElementById("switchLocationModal").style.display = "block";
        try {
          const response = await fetch("/api/locations");
          const data = await response.json();
          const locationList = document.getElementById("locationList");
          locationList.innerHTML = "";
          if (data.locations && data.locations.length > 0) {
            data.locations.forEach(location => {
              const div = document.createElement("div");
              div.style.padding = "10px";
              div.style.borderBottom = "1px solid #eee";
              div.style.cursor = "pointer";
              div.innerHTML = `${location.name} (Created: ${location.created_at})`;
              div.addEventListener("click", () => { this.switchToLocation(location.id); });
              locationList.appendChild(div);
            });
          } else {
            locationList.innerHTML = "<p>No locations found</p>";
          }
        } catch (error) {
          console.error("Error loading locations:", error);
          document.getElementById("locationList").innerHTML = "<p>Failed to load locations. Please try again.</p>";
        }
      },
      closeSwitchLocationModal: function() {
        document.getElementById("switchLocationModal").style.display = "none";
      },
      switchToLocation: async function(locationId) {
        try {
          const response = await fetch(`/api/load-layers?location=${locationId}`);
          if (!response.ok) throw new Error("Failed to load location");
          const data = await response.json();
          Object.values(this.layers).forEach(layer => {
            if (this.map.hasLayer(layer)) { this.map.removeLayer(layer); }
          });
          this.layers = {};
          if (data.layers) {
            Object.entries(data.layers).forEach(([name, layerData]) => {
              const layer = L.featureGroup().addTo(this.map);
              layer.properties = layerData.properties || {};
              if (layerData.features && layerData.features.length > 0) {
                layerData.features.forEach(feature => {
                  const featureLayer = L.geoJSON(feature);
                  featureLayer.feature = feature;
                  if (feature.properties && feature.properties.name) {
                    featureLayer.bindTooltip(feature.properties.name + (feature.properties.typeCode ? `<br>${feature.properties.typeCode}` : ""), { permanent: false });
                  }
                  layer.addLayer(featureLayer);
                });
              }
              this.layers[name] = layer;
            });
          }
          if (Object.keys(this.layers).length === 0) {
            this.layers["Default"] = L.featureGroup().addTo(this.map);
          }
          this.activeLayer = Object.values(this.layers)[0];
          this.updateDrawToLayerSelect();
          this.updateLayerControl();
          this.currentLocation = locationId;
          document.getElementById("dbStatus").textContent = `Location ID: ${locationId}`;
          this.closeSwitchLocationModal();
        } catch (error) {
          console.error("Error switching location:", error);
          alert("Failed to switch location. Please try again.");
        }
      },
      loadFromDatabase: async function() {
        try {
          const response = await fetch("/api/load-layers");
          if (!response.ok) throw new Error("Failed to load layers");
          const data = await response.json();
          console.log("Loaded layer data:", JSON.stringify(data, null, 2));
          Object.values(this.layers).forEach(layer => {
            if (this.map.hasLayer(layer)) { this.map.removeLayer(layer); }
          });
          this.layers = {};
          if (data.layers && Object.keys(data.layers).length > 0) {
            Object.entries(data.layers).forEach(([name, layerData]) => {
              const layer = L.featureGroup().addTo(this.map);
              layer.properties = layerData.properties || {};
              if (layerData.features && layerData.features.length > 0) {
                layerData.features.forEach(feature => {
                  try {
                    const featureLayer = L.geoJSON(feature);
                    featureLayer.feature = feature;
                    if (feature.properties && feature.properties.name) {
                      featureLayer.bindTooltip(feature.properties.name + (feature.properties.typeCode ? `<br>${feature.properties.typeCode}` : ""), { permanent: false });
                    }
                    layer.addLayer(featureLayer);
                  } catch (err) {
                    console.error("Error adding feature to layer:", err);
                  }
                });
              }
              this.layers[name] = layer;
            });
          } else {
            this.layers["Default"] = L.featureGroup().addTo(this.map);
          }
          this.activeLayer = Object.values(this.layers)[0];
          this.updateDrawToLayerSelect();
          this.updateLayerControl();
          console.log("Layers loaded successfully");
        } catch (error) {
          console.error("Error loading layers:", error);
          this.layers = { "Default": L.featureGroup().addTo(this.map) };
          this.activeLayer = this.layers["Default"];
          this.updateDrawToLayerSelect();
          this.updateLayerControl();
        }
      },
      saveToDatabase: async function() {
        try {
          const layerData = { layers: {} };
          Object.entries(this.layers).forEach(([name, layer]) => {
            if (!layer) return;
            const features = [];
            layer.eachLayer(sublayer => {
              if (sublayer.toGeoJSON) {
                const feature = sublayer.toGeoJSON();
                if (sublayer.feature && sublayer.feature.properties) {
                  feature.properties = { ...sublayer.feature.properties };
                }
                const style = {};
                if (sublayer.options) {
                  style.color = sublayer.options.color;
                  style.fillColor = sublayer.options.fillColor;
                  style.weight = sublayer.options.weight;
                  style.fillOpacity = sublayer.options.fillOpacity;
                }
                feature.properties = {
                  ...feature.properties,
                  style,
                  layerName: name,
                  type: layer.layerType || "default"
                };
                features.push(feature);
              }
            });
            layerData.layers[name] = {
              properties: {
                type: layer.layerType || "default",
                isActive: this.map.hasLayer(layer),
                visible: this.map.hasLayer(layer),
                ...layer.properties
              },
              features: features
            };
          });
          console.log("Saving layer data:", JSON.stringify(layerData, null, 2));
          const response = await fetch("/api/save-layers", {
            method: "POST",
            headers: { "Content-Type": "application/json" },
            body: JSON.stringify(layerData)
          });
          if (!response.ok) {
            const errorText = await response.text();
            throw new Error(`Save failed: ${errorText}`);
          }
          console.log("Layers saved successfully");
          document.getElementById("dbStatus").textContent =
            this.currentLocation ? `Location ID: ${this.currentLocation} (Saved)` : "Saved";
          setTimeout(() => {
            if (this.currentLocation) {
              document.getElementById("dbStatus").textContent = `Location ID: ${this.currentLocation}`;
            } else {
              document.getElementById("dbStatus").textContent = "No location selected";
            }
          }, 2000);
        } catch (error) {
          console.error("Error saving layers:", error);
          alert("Failed to save layers: " + error.message);
        }
      }
    };

    document.addEventListener("DOMContentLoaded", function() {
      console.log("DOM Content Loaded");
      QDPro.init();
      window.toggleMenu = function(element, menuId) {
        const dropdown = document.getElementById(menuId);
        if (!dropdown) {
          console.error(`Menu dropdown with id ${menuId} not found`);
          return;
        }
        document.querySelectorAll(".menu-dropdown").forEach(dd => {
          if (dd.id !== menuId) {
            dd.style.display = "none";
            dd.parentElement.classList.remove("active");
          }
        });
        const isVisible = dropdown.style.display === "block";
        dropdown.style.display = isVisible ? "none" : "block";
        element.classList.toggle("active", !isVisible);
        if (!isVisible) {
          const rect = element.getBoundingClientRect();
          dropdown.style.position = "fixed";
          dropdown.style.top = rect.bottom + "px";
          dropdown.style.left = rect.left + "px";
          dropdown.style.zIndex = "3500";
        }
      };

      // Expose modal functions for global use
      window.showNewLocationModal = function() { QDPro.showNewLocationModal(); };
      window.showSwitchLocationModal = function() { QDPro.showSwitchLocationModal(); };
      window.showAddLayerModal = function() { QDPro.showAddLayerModal(); };
      window.closeAddLayerModal = function() { QDPro.closeAddLayerModal(); };
      window.createNewLayer = function() { QDPro.createNewLayer(); };
      window.switchToLocation = function(locationId) { QDPro.switchToLocation(locationId); };
      window.saveToDatabase = function() { QDPro.saveToDatabase(); };
      window.editLayer = function(layerName) { QDPro.editLayer(layerName); };
    });
  </script>
</body>
</html>
