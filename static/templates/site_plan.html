<!DOCTYPE html>
<html>
<head>
    <title>QDPro Site Plan</title>
    <link rel="stylesheet" href="https://unpkg.com/leaflet@1.9.4/dist/leaflet.css" integrity="sha256-p4NxAoJBhIIN+hmNHrzRCf9tD/miZyoHS5obTRR9BMY=" crossorigin=""/>
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/leaflet.draw/1.0.4/leaflet.draw.css"/>
    <script src="https://unpkg.com/leaflet@1.9.4/dist/leaflet.js" integrity="sha256-20nQCchB9co0qIjJZRGuk2/Z9VM+kNiyxNV1lvTlZBo=" crossorigin=""></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/leaflet.draw/1.0.4/leaflet.draw.js"></script>
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/5.15.4/css/all.min.css"/>
    <style>
        .base-layer-option {
            padding: 8px;
            display: flex;
            align-items: center;
            gap: 8px;
        }
        .base-layer-option input[type="radio"] {
            margin: 0;
        }
        .base-layer-option label {
            cursor: pointer;
        }
        .panel-header {
            padding: 15px;
            background: #f8f9fa;
            border-bottom: 1px solid #dee2e6;
        }
        .panel-header h3 {
            margin: 0;
            font-size: 16px;
            font-weight: 600;
        }
        .panel-content {
            padding: 15px;
        }
        .layer-select-container {
            margin-bottom: 15px;
        }
        .layer-select-container select {
            width: 100%;
            padding: 8px;
            border: 1px solid #dee2e6;
            border-radius: 4px;
        }
        .layer-control-container {
            border-top: 1px solid #dee2e6;
            padding-top: 15px;
        }
        #baseLayerDropdown {
            position: absolute;
            background: white;
            border: 1px solid #dee2e6;
            border-radius: 4px;
            box-shadow: 0 2px 8px rgba(0,0,0,0.1);
            padding: 10px;
            min-width: 200px;
            z-index: 1000;
        }
        .tool-button {
            padding: 5px 10px;
            margin: 0 2px;
            background: #f8f9fa;
            border: 1px solid #dee2e6;
            border-radius: 3px;
            cursor: pointer;
        }
        .tool-button:hover {
            background: #e9ecef;
        }
        .scale-label, .editor-label {
            margin: 0 5px;
        }
        #scaleSelect {
            padding: 3px;
            border: 1px solid #dee2e6;
            border-radius: 3px;
        }
        .layer-control-item {
            padding: 5px 0;
            margin: 2px 0;
        }

        .layer-control-item label {
            display: flex;
            align-items: center;
            gap: 5px;
            cursor: pointer;
        }

        .layer-control-item input[type="checkbox"] {
            margin: 0;
        }

        #map {
            position: fixed;
            height: calc(100vh - 80px);
            width: 100%;
            margin-top: 80px;
            transition: all 0.3s ease;
        }
        .toolbar {
            position: fixed;
            top: 30px;
            left: 0;
            right: 0;
            height: 50px;
            background: #f8f9fa;
            border-bottom: 1px solid #dee2e6;
            display: flex;
            align-items: center;
            padding: 0 15px;
            z-index: 1002;
            pointer-events: auto;
        }
        .tool-group button {
            padding: 6px 12px;
            margin: 0 4px;
            border: 1px solid #dee2e6;
            border-radius: 4px;
            background: white;
            cursor: pointer;
        }
        .tool-group button:hover {
            background: #e9ecef;
        }
        body {
            margin: 0;
            padding: 0;
            font-family: Arial, sans-serif;
            overflow: hidden;
        }
        .menu-bar {
            position: fixed;
            top: 0;
            left: 0;
            right: 0;
            height: 30px;
            background: #2b2d42;
            color: white;
            display: flex;
            z-index: 1001;
        }
        .menu-item {
            padding: 0 15px;
            line-height: 30px;
            cursor: pointer;
            position: relative;
        }
        .menu-item:hover {
            background: #4a4e69;
        }
        .dropdown {
            display: none;
            position: absolute;
            top: 100%;
            left: 0;
            background: #2b2d42;
            min-width: 200px;
            box-shadow: 0 2px 4px rgba(0,0,0,0.2);
            z-index: 1002;
        }
        .menu-item:hover .dropdown {
            display: block;
        }
        .dropdown-item {
            padding: 8px 15px;
            color: white;
            cursor: pointer;
        }
        .dropdown-item:hover {
            background: #4a4e69;
        }
        .dropdown-item {
            padding: 8px 15px;
            white-space: nowrap;
        }
        .dropdown-item:hover {
            background: #4a4e69;
        }
        .left-panel {
            min-width: 250px;
            width: 250px;
            position: fixed;
            top: 80px;
            left: 0;
            height: calc(100vh - 80px);
            background: white;
            overflow: auto;
            border-right: 1px solid #dee2e6;
            z-index: 1000;
            transition: transform 0.3s ease;
            transform: translateX(-100%);
        }
        .left-panel.visible {
            transform: translateX(0);
        }
        .resize-handle {
            position: absolute;
            right: 0;
            top: 0;
            bottom: 0;
            width: 4px;
            cursor: ew-resize;
            background: #dee2e6;
        }
        .panel-section {
            padding: 10px;
            border-bottom: 1px solid #dee2e6;
        }
        .panel-title {
            font-weight: bold;
            margin-bottom: 10px;
        }
        .toolbar {
            position: fixed;
            top: 30px;
            left: 0;
            right: 0;
            height: 50px;
            background: #f8f9fa;
            border-bottom: 1px solid #dee2e6;
            display: flex;
            align-items: center;
            padding: 0 15px;
            z-index: 1001;
        }
        .tool-group {
            display: flex;
            align-items: center;
            margin-right: 20px;
        }
        .tool-group button {
            padding: 8px 12px;
            margin: 0 5px;
            border: 1px solid #dee2e6;
            border-radius: 4px;
            background: white;
            color: #333;
            cursor: pointer;
        }
        .tool-group button:hover {
            background: #e9ecef;
        }
        .tool-divider {
            width: 1px;
            height: 30px;
            background: #dee2e6;
            margin: 0 15px;
        }
        /* Modal styles */
        .modal {
            display: none;
            position: fixed;
            z-index: 1;
            left: 0;
            top: 0;
            width: 100%;
            height: 100%;
            overflow: auto;
            background-color: rgba(0,0,0,0.4);
        }
        .modal-content {
            background-color: #fefefe;
            margin: 15% auto;
            padding: 20px;
            border: 1px solid #888;
            width: 300px;
        }
        .close {
            color: #aaa;
            float: right;
            font-size: 28px;
            font-weight: bold;
        }
        .close:hover,
        .close:focus {
            color: black;
            text-decoration: none;
            cursor: pointer;
        }
        .modal-form input[type="text"],
        .modal-form input[type="url"],
        .modal-form select {
            width: 100%;
            padding: 10px;
            margin-bottom: 10px;
            border: 1px solid #ccc;
            border-radius: 4px;
            box-sizing: border-box;
        }
        .modal-form button[type="submit"] {
            background-color: #4CAF50;
            color: white;
            padding: 10px 15px;
            border: none;
            border-radius: 4px;
            cursor: pointer;
        }
    </style>
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/leaflet.draw/1.0.4/leaflet.draw.css"/>
    <script src="https://unpkg.com/leaflet@1.9.4/dist/leaflet.js" crossorigin=""></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/leaflet.draw/1.0.4/leaflet.draw.js"></script>
    
</head>
<body>
    <div class="menu-bar">
        <div class="menu-item">File</div>
        <div class="menu-item">Database Builder</div>
        <div class="menu-item">Edit</div>
        <div class="menu-item">Properties</div>
        <div class="menu-item">Reports</div>
        <div class="menu-item">Analysis</div>
        <div class="menu-item">View</div>
        <div class="menu-item">Admin Record</div>
        <div class="menu-item">Tools</div>
        <div class="menu-item">Help</div>
    </div>
    <div class="toolbar">
        <div class="tool-group">
            <button id="measureTool" class="tool-button" title="Measure"><i class="fas fa-ruler"></i></button>
        </div>
        <div class="tool-divider"></div>
        <div class="tool-group">
            <button id="toggleLayersPanel" class="tool-button" title="Toggle Layers Panel"><i class="fas fa-bars"></i></button>
            <button id="addLayerTool" class="tool-button" title="Add Layer"><i class="fas fa-layer-group"></i></button>
            <button id="printTool" class="tool-button" title="Print"><i class="fas fa-print"></i></button>
        </div>
        <div class="tool-group">
            <span class="scale-label">Scale:</span>
            <select id="scaleSelect">
                <option value="1000">1:1000</option>
                <option value="5000">1:5000</option>
                <option value="10000">1:10000</option>
            </select>
        </div>
        <div class="tool-group">
            <span class="editor-label">Editor:</span>
            <button id="editorTool" class="tool-button"><i class="fas fa-edit"></i></button>
        </div>
        <div class="tool-group">
            <button id="markupTool" class="tool-button" title="Markup"><i class="fas fa-pen"></i></button>
            <button id="wizardsTool" class="tool-button" title="Wizards"><i class="fas fa-magic"></i></button>
            <button id="baseLayerTool" class="tool-button" title="Base Layers"><i class="fas fa-layer-group"></i></button>
            <button id="bookmarkTool" class="tool-button" title="Bookmarks"><i class="fas fa-bookmark"></i></button>
        </div>
    </div>
    <div id="baseLayerDropdown" class="dropdown-menu" style="display: none; position: absolute; z-index: 1000; background: white; padding: 10px; border: 1px solid #ccc;"></div>
    <div id="bookmarkDropdown" class="dropdown-menu" style="display: none; position: absolute; z-index: 1000; background: white; padding: 10px; border: 1px solid #ccc;">
        <div id="bookmarkList"></div>
        <hr>
        <button id="addBookmark" class="btn btn-sm btn-primary">Add Current View</button>
    </div>
    <div class="left-panel" id="leftPanel">
        <div class="resize-handle" id="resizeHandle"></div>
        <div class="panel-section">
            <div class="panel-title" style="padding: 10px; background: #f8f9fa; border-bottom: 1px solid #dee2e6;">Layers Panel</div>
            <div id="layerControl" style="padding: 10px;"></div>
        </div>
    </div>
    <div id="map" style="height: calc(100vh - 80px); margin-top: 80px;"></div>

    <!-- Add Layer Modal -->
    <div id="addLayerModal" class="modal">
        <div class="modal-content">
            <span class="close">&times;</span>
            <h2>Add New Layer</h2>
            <form id="addLayerForm" class="modal-form">
                <input type="text" id="layerName" placeholder="Layer Name" required>
                <input type="text" id="layerDescription" placeholder="Layer Description">
                <select id="layerType" required>
                    <option value="">Select Layer Type</option>
                    <option value="polygon">Polygon</option>
                    <option value="circle">Circle</option>
                    <option value="rectangle">Rectangle</option>
                    <option value="marker">Marker</option>
                </select>
                <button type="submit">Add Layer</button>
            </form>
        </div>
    </div>

    <script>
        // Initialize map with OpenStreetMap as default
        // Map initialization is handled in the previous script block

        // Force a map refresh
        setTimeout(() => {
            map.invalidateSize();
        }, 100);

        // Initialize drawing layer
        // Initialize feature groups for different layer types
        const drawnItems = new L.FeatureGroup();
        const facilityLayer = new L.FeatureGroup();
        const analysisLayer = new L.FeatureGroup();

        map.addLayer(drawnItems);
        map.addLayer(facilityLayer);
        map.addLayer(analysisLayer);

        // Storage utilities
        const storageUtils = {
            saveLayer: (layer) => {
                const layers = JSON.parse(localStorage.getItem('mapLayers') || '[]');
                layers.push(layer);
                localStorage.setItem('mapLayers', JSON.stringify(layers));
            },
            loadLayers: () => {
                return JSON.parse(localStorage.getItem('mapLayers') || '[]');
            },
            saveBookmark: (bookmark) => {
                const bookmarks = JSON.parse(localStorage.getItem('mapBookmarks') || '[]');
                bookmarks.push(bookmark);
                localStorage.setItem('mapBookmarks', JSON.stringify(bookmarks));
            },
            loadBookmarks: () => {
                return JSON.parse(localStorage.getItem('mapBookmarks') || '[]');
            }
        };

        // Create overlay management object
        const overlayMaps = {
            "Drawn Items": drawnItems,
            "Facilities": facilityLayer,
            "Analysis": analysisLayer
        };

        // Track active layer for drawing
        let activeDrawingLayer = drawnItems;

        // Function to update left panel overlay controls
        function updateOverlayControls() {
            const layerControl = document.getElementById('layerControl');
            layerControl.innerHTML = '';

            // Add layer selector dropdown
            const selectDiv = document.createElement('div');
            selectDiv.className = 'layer-select-container';
            const layerSelect = document.createElement('select');
            layerSelect.id = 'activeLayerSelect';
            layerSelect.style.width = '100%';
            layerSelect.style.marginBottom = '10px';

            Object.keys(overlayMaps).forEach(name => {
                const option = document.createElement('option');
                option.value = name;
                option.textContent = `Draw to: ${name}`;
                layerSelect.appendChild(option);
            });

            layerSelect.addEventListener('change', (e) => {
                activeDrawingLayer = overlayMaps[e.target.value];
            });

            selectDiv.appendChild(layerSelect);
            layerControl.appendChild(selectDiv);


            const layerControlContainer = document.createElement('div');
            layerControlContainer.className = 'layer-control-container';
            Object.entries(overlayMaps).forEach(([name, layer]) => {
                const div = document.createElement('div');
                div.className = 'layer-control-item';

                const checkbox = document.createElement('input');
                checkbox.type = 'checkbox';
                checkbox.checked = map.hasLayer(layer);
                checkbox.addEventListener('change', () => {
                    if (checkbox.checked) {
                        map.addLayer(layer);
                    } else {
                        map.removeLayer(layer);
                    }
                });

                const label = document.createElement('label');
                label.appendChild(checkbox);
                label.appendChild(document.createTextNode(` ${name}`));

                div.appendChild(label);
                layerControlContainer.appendChild(div);
            });
            layerControl.appendChild(layerControlContainer);
        }

        const osm = L.tileLayer('https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png', {
            maxZoom: 19,
            attribution: '© OpenStreetMap contributors'
        });

        const googleSat = L.tileLayer('https://{s}.google.com/vt/lyrs=s&x={x}&y={y}&z={z}', {
            maxZoom: 20,
            subdomains: ['mt0', 'mt1', 'mt2', 'mt3'],
            attribution: '© Google'
        });

        const googleStreets = L.tileLayer('https://{s}.google.com/vt/lyrs=m&x={x}&y={y}&z={z}', {
            maxZoom: 20,
            subdomains: ['mt0', 'mt1', 'mt2', 'mt3'],
            attribution: '© Google'
        });

        const googleHybrid = L.tileLayer('https://{s}.google.com/vt/lyrs=s,h&x={x}&y={y}&z={z}', {
            maxZoom: 20,
            subdomains: ['mt0', 'mt1', 'mt2', 'mt3'],
            attribution: '© Google'
        });

        const baseLayers = {
            "OpenStreetMap": osm,
            "Google Satellite": googleSat,
            "Google Streets": googleStreets,
            "Google Hybrid": googleHybrid
        };


        // Create base layer dropdown content
        const baseLayerDropdown = document.getElementById('baseLayerDropdown');
        Object.entries(baseLayers).forEach(([name, layer]) => {
            const item = document.createElement('div');
            item.style.padding = '5px';
            item.style.cursor = 'pointer';
            item.innerText = name;
            item.addEventListener('click', () => {
                Object.values(baseLayers).forEach(l => map.removeLayer(l));
                map.addLayer(layer);
                baseLayerDropdown.style.display = 'none';
            });
            baseLayerDropdown.appendChild(item);
        });

        // Setup base layer toggle
        document.getElementById('baseLayerTool').addEventListener('click', (e) => {
            baseLayerDropdown.style.display = baseLayerDropdown.style.display === 'none' ? 'block' : 'none';
            baseLayerDropdown.style.top = '90px';
            baseLayerDropdown.style.right = '10px';
        });

        // Setup bookmarks
        document.getElementById('bookmarkTool').addEventListener('click', (e) => {
            const dropdown = document.getElementById('bookmarkDropdown');
            dropdown.style.display = dropdown.style.display === 'none' ? 'block' : 'none';
            dropdown.style.top = '90px';
            dropdown.style.right = '10px';
        });

        document.getElementById('addBookmark').addEventListener('click', () => {
            const name = prompt('Enter bookmark name:');
            if (name) {
                const bookmark = {
                    name,
                    center: map.getCenter(),
                    zoom: map.getZoom()
                };
                storageUtils.saveBookmark(bookmark);
                updateBookmarkList();
            }
        });

        function updateBookmarkList() {
            const list = document.getElementById('bookmarkList');
            list.innerHTML = '';
            storageUtils.loadBookmarks().forEach(bookmark => {
                const item = document.createElement('div');
                item.style.padding = '5px';
                item.style.cursor = 'pointer';
                item.innerText = bookmark.name;
                item.addEventListener('click', () => {
                    map.setView([bookmark.center.lat, bookmark.center.lng], bookmark.zoom);
                });
                list.appendChild(item);
            });
        }

        // Initialize overlay controls in left panel
        updateOverlayControls();

        // Initialize drawing controls
        const drawControl = new L.Control.Draw({
            draw: {
                polygon: true,
                polyline: true,
                rectangle: true,
                circle: true,
                marker: true,
                circlemarker: false
            },
            edit: {
                featureGroup: drawnItems,
                remove: true
            }
        });
        map.addControl(drawControl);

        // Handle drawn items
        map.on('draw:created', function(e) {
            const layer = e.layer;
            activeDrawingLayer.addLayer(layer);
        });


        osm.addTo(map);

        // Fetch and display facilities
        // Initialize tools
        let measureControl = null;

        // Guard all event listener attachments
        const orgSelect = document.getElementById('orgSelect');
        if (orgSelect) {
            orgSelect.addEventListener('change', function(e) {
                console.log('Selected organization:', e.target.value);
            });
        }

        const measureDistanceBtn = document.getElementById('measureDistance');
        if (measureDistanceBtn) {
            measureDistanceBtn.addEventListener('click', function() {
                if (!measureControl) {
                    measureControl = L.control.measure({
                        primaryLengthUnit: 'feet',
                        secondaryLengthUnit: 'miles',
                        primaryAreaUnit: 'sqfeet',
                        secondaryAreaUnit: 'acres'
                    });
                    measureControl.addTo(map);
                }
            });
        }

        const drawArcBtn = document.getElementById('drawArc');
        if (drawArcBtn) {
            drawArcBtn.addEventListener('click', function() {
                const drawToolbar = document.querySelector('.leaflet-draw');
                if (drawToolbar) {
                    drawToolbar.style.display = drawToolbar.style.display === 'none' ? 'block' : 'none';
                }
            });
        }

        const analyzeQDBtn = document.getElementById('analyzeQD');
        if (analyzeQDBtn) {
            analyzeQDBtn.addEventListener('click', async function() {
                const org = orgSelect?.value;
                const facilityType = document.getElementById('facilityType')?.value;
                // Implement QD analysis logic here
            });
        }

        // Add resize functionality
        const leftPanel = document.getElementById('leftPanel');
        let isResizing = false;
        let startX;
        let startWidth;

        document.getElementById('resizeHandle').addEventListener('mousedown', function(e) {
            isResizing = true;
            startX = e.pageX;
            startWidth = parseInt(getComputedStyle(leftPanel).width, 10);
            document.addEventListener('mousemove', handleResize);
            document.addEventListener('mouseup', stopResize);
            e.preventDefault();
        });

        function handleResize(e) {
            if (!isResizing) return;
            const difference = e.pageX - startX;
            const newWidth = Math.min(Math.max(startWidth + difference, 200), 500);

            leftPanel.style.width = newWidth + 'px';
            document.getElementById('map').style.marginLeft = newWidth + 'px';
            document.getElementById('map').style.width = `calc(100% - ${newWidth}px)`;
            map.invalidateSize();
        }

        function stopResize() {
            isResizing = false;
            document.removeEventListener('mousemove', handleResize);
            document.removeEventListener('mouseup', stopResize);
        }

        // Add panel toggle functionality
        const toggleLayersBtn = document.getElementById('toggleLayersPanel');
        const panel = document.getElementById('leftPanel');
        const mapElement = document.getElementById('map');

        // Initialize panel state
        panel.classList.add('visible');
        mapElement.style.marginLeft = '250px';
        mapElement.style.width = 'calc(100% - 250px)';
        toggleLayersBtn.innerHTML = '<i class="fas fa-times"></i>';
        toggleLayersBtn.title = "Close Layers Panel";

        // Panel toggle handler
        toggleLayersBtn.onclick = function() {
            panel.classList.toggle('visible');
            const isVisible = panel.classList.contains('visible');

            // Use transition for smooth map resizing
            mapElement.style.transition = 'margin-left 0.3s ease, width 0.3s ease';
            mapElement.style.marginLeft = isVisible ? '250px' : '0';
            mapElement.style.width = isVisible ? 'calc(100% - 250px)' : '100%';

            toggleLayersBtn.innerHTML = isVisible ? '<i class="fas fa-times"></i>' : '<i class="fas fa-bars"></i>';
            toggleLayersBtn.title = isVisible ? "Close Layers Panel" : "Show Layers Panel";

            // Force map recalculation after transition
            setTimeout(() => {
                map.invalidateSize();
                mapElement.style.transition = '';  // Remove transition after completion
            }, 300);
        };

        // Load facilities
        fetch('/reports/facilities')
            .then(response => response.json())
            .then(facilities => {
                facilities.forEach(facility => {
                    L.marker([facility.lat, facility.lng])
                        .bindPopup(facility.name)
                        .addTo(facilityLayer);
                });
            })
            .catch(error => console.error('Error loading facilities:', error));


        // Add Layer Modal Functionality
        const addLayerModal = document.getElementById('addLayerModal');
        const addLayerBtn = document.getElementById('addLayerTool');
        const closeModal = document.querySelector('.close');
        const addLayerForm = document.getElementById('addLayerForm');

        addLayerBtn.addEventListener('click', () => {
            addLayerModal.style.display = "block";
        });

        closeModal.addEventListener('click', () => {
            addLayerModal.style.display = "none";
        });

        window.addEventListener('click', (event) => {
            if (event.target === addLayerModal) {
                addLayerModal.style.display = "none";
            }
        });

        // Initialize layer control once
        let layerControl = L.control.layers(baseLayers, overlayMaps).addTo(map);

        addLayerForm.addEventListener('submit', (event) => {
            event.preventDefault();
            const layerName = document.getElementById('layerName').value;
            const layerDescription = document.getElementById('layerDescription').value;
            const layerType = document.getElementById('layerType').value;

            // Create a new feature group for the layer
            let newLayer = new L.FeatureGroup();

            // Enable drawing mode based on selected type
            let drawHandler;
            if (layerType === 'polygon') {
                drawHandler = new L.Draw.Polygon(map);
            } else if (layerType === 'circle') {
                drawHandler = new L.Draw.Circle(map);
            } else if (layerType === 'rectangle') {
                drawHandler = new L.Draw.Rectangle(map);
            } else if (layerType === 'marker') {
                drawHandler = new L.Draw.Marker(map);
            } else {
                alert("Invalid layer type");
                return;
            }

            // Add the new layer to the map
            newLayer.addTo(map);

            // Save layer to storage
            storageUtils.saveLayer({
                name: layerName,
                type: layerType,
                description: layerDescription
            });

            // Update overlayMaps and refresh overlay controls
            overlayMaps[layerName] = newLayer;
            updateOverlayControls();

            // Update layer selector with new layer
            const layerSelect = document.getElementById('activeLayerSelect');
            const option = document.createElement('option');
            option.value = layerName;
            option.textContent = `Draw to: ${layerName}`;
            layerSelect.appendChild(option);

            // Hide modal and start drawing
            addLayerModal.style.display = "none";
            drawHandler.enable();

            // Handle the drawing completion
            map.once('draw:created', function(e) {
                const layer = e.layer;
                newLayer.addLayer(layer);
            });
        });

        // Set initial base layer
        baseLayers['OpenStreetMap'].addTo(map);

        // Initialize drawing controls
        const drawingTools = {
            polygon: new L.Draw.Polygon(map),
            polyline: new L.Draw.Polyline(map),
            rectangle: new L.Draw.Rectangle(map),
            circle: new L.Draw.Circle(map),
            marker: new L.Draw.Marker(map)
        };

        // Drawing tool event handlers
        document.getElementById('drawPolygon').onclick = () => drawingTools.polygon.enable();
        document.getElementById('drawPolyline').onclick = () => drawingTools.polyline.enable();
        document.getElementById('drawRectangle').onclick = () => drawingTools.rectangle.enable();
        document.getElementById('drawCircle').onclick = () => drawingTools.circle.enable();
        document.getElementById('drawMarker').onclick = () => drawingTools.marker.enable();

        // Handle draw:created events
        map.on('draw:created', function(e) {
            const layer = e.layer;
            const selectedLayer = document.getElementById('drawingLayer').value;
            const targetLayer = {
                'drawnItems': drawnItems,
                'facilityLayer': facilityLayer,
                'analysisLayer': analysisLayer
            }[selectedLayer];

            if (targetLayer) {
                targetLayer.addLayer(layer);
            }
        });

        // Base layer selector event handler
        document.getElementById('baseLayerTool').addEventListener('click', function(e) {
            const menu = document.getElementById('baseLayerDropdown');
            menu.innerHTML = '';
            Object.entries(baseLayers).forEach(([name, layer]) => {
                const label = document.createElement('label');
                label.style.display = 'block';
                label.style.padding = '5px';
                const radio = document.createElement('input');
                radio.type = 'radio';
                radio.name = 'baseLayer';
                radio.value = name;
                radio.checked = map.hasLayer(layer);
                radio.onchange = () => {
                    Object.values(baseLayers).forEach(l => map.removeLayer(l));
                    map.addLayer(layer);
                    menu.style.display = 'none';
                };
                label.appendChild(radio);
                label.appendChild(document.createTextNode(' ' + name));
                menu.appendChild(label);
            });
            menu.style.display = menu.style.display === 'none' ? 'block' : 'none';
        });

        // Initialize overlay controls in left panel
        updateOverlayControls();
    </script>
</body>
</html>