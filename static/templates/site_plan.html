<!DOCTYPE html>
<html>
<head>
    <title>QDPro Site Plan</title>
    <link rel="stylesheet" href="https://unpkg.com/leaflet@1.9.4/dist/leaflet.css" />
    <link rel="stylesheet" href="https://unpkg.com/leaflet-draw@1.0.4/dist/leaflet.draw.css" />
    <style>
        body { margin: 0; padding: 0; font-family: Arial, sans-serif; }
        #map { position: absolute; top: 160px; /* Increased top margin to accommodate toolbars */ bottom: 0; width: 100%; }
        .menu-bar {
            background: #f8f9fa;
            padding: 10px;
            border-bottom: 1px solid #dee2e6;
            position: fixed;
            top: 0;
            left: 0;
            right: 0;
            z-index: 1000;
        }
        .dropdown {
            position: relative;
            display: inline-block;
            margin-right: 15px;
        }
        .dropdown-content {
            display: none;
            position: absolute;
            background: white;
            min-width: 160px;
            box-shadow: 0 2px 5px rgba(0,0,0,0.2);
            z-index: 1001;
            border-radius: 4px;
        }
        .dropdown-content a {
            padding: 8px 12px;
            display: block;
            text-decoration: none;
            color: black;
            cursor: pointer;
        }
        .dropdown-content a:hover { background-color: #f1f1f1; }
        .dropdown:hover .dropdown-content { display: block; }
        .tools-toolbar {
            position: fixed;
            top: 40px;
            left: 0;
            right: 0;
            background: #f8f9fa;
            padding: 10px;
            z-index: 1000;
            border-bottom: 1px solid #dee2e6;
        }
        .tools-toolbar button {
            margin: 0 5px;
            padding: 5px 10px;
            border: 1px solid #dee2e6;
            background: white;
            cursor: pointer;
            border-radius: 4px;
        }
        .tools-toolbar button:hover {
            background: #e9ecef;
        }
        .layer-panel {
            position: fixed;
            left: 10px;
            top: 80px; /* Adjusted top position */
            background: white;
            padding: 10px;
            border-radius: 4px;
            box-shadow: 0 2px 5px rgba(0,0,0,0.2);
            z-index: 1000;
            max-width: 250px;
            max-height: 70%;
            overflow-y: auto;
        }
        .modal {
            display: none;
            position: fixed;
            z-index: 1002;
            left: 0;
            top: 0;
            width: 100%;
            height: 100%;
            overflow: auto;
            background-color: rgba(0,0,0,0.4);
        }
        .modal-content {
            background-color: #fefefe;
            margin: 10% auto;
            padding: 20px;
            border: 1px solid #888;
            width: 50%;
            border-radius: 5px;
        }
        .close-btn {
            color: #aaa;
            float: right;
            font-size: 28px;
            font-weight: bold;
            cursor: pointer;
        }
        .close-btn:hover {
            color: black;
        }
        .form-group {
            margin-bottom: 15px;
        }
        label {
            display: block;
            margin-bottom: 5px;
            font-weight: bold;
        }
        input[type="text"], select {
            width: 100%;
            padding: 8px;
            border: 1px solid #ddd;
            border-radius: 4px;
        }
        .btn {
            padding: 8px 16px;
            background-color: #4CAF50;
            color: white;
            border: none;
            border-radius: 4px;
            cursor: pointer;
        }
        .btn:hover {
            background-color: #45a049;
        }
    </style>
</head>
<body>
    <div class="menu-bar">
        <div class="dropdown">
            <span>File</span>
            <div class="dropdown-content">
                <a id="new-project">New Project</a>
                <a id="open-project">Open Project</a>
                <a id="save-project">Save Project</a>
                <a id="export-project">Export</a>
            </div>
        </div>
        <div class="dropdown">
            <span>Edit</span>
            <div class="dropdown-content">
                <a id="undo">Undo</a>
                <a id="redo">Redo</a>
                <a id="delete-selected">Delete Selected</a>
            </div>
        </div>
        <div class="dropdown">
            <span>View</span>
            <div class="dropdown-content">
                <a id="toggle-grid">Toggle Grid</a>
                <a id="toggle-layers">Toggle Layers Panel</a>
                <a id="toggle-measurements">Toggle Measurements</a>
            </div>
        </div>
        <div class="dropdown">
            <span>Tools</span>
            <div class="dropdown-content">
                <a id="run-analysis">Run Analysis</a>
                <a id="generate-report">Generate Report</a>
                <a id="settings">Settings</a>
            </div>
        </div>
        <div class="dropdown">
            <span>Help</span>
            <div class="dropdown-content">
                <a id="documentation">Documentation</a>
                <a id="about">About</a>
            </div>
        </div>
    </div>

    <div class="tools-toolbar">
        <button id="toggle-layers-btn" title="Toggle Layers Panel">
            <i class="fa fa-layers"></i> Layers
        </button>
        <button id="tool-select">Select</button>
        <button id="tool-draw-point">Draw Point</button>
        <button id="tool-draw-polygon">Draw Polygon</button>
        <button id="tool-draw-line">Draw Line</button>
        <button id="tool-measure">Measure</button>
        <button id="tool-clear">Clear All</button>
    </div>

    <div id="layer-panel" class="layer-panel">
        <h3>Layers</h3>
        <div id="layers-list"></div>
    </div>

    <div id="map"></div>

    <!-- Modal dialogs -->
    <div id="new-project-modal" class="modal">
        <div class="modal-content">
            <span class="close-btn">&times;</span>
            <h2>New Project</h2>
            <form id="new-project-form">
                <div class="form-group">
                    <label for="project-name">Project Name:</label>
                    <input type="text" id="project-name" required>
                </div>
                <div class="form-group">
                    <label for="project-location">Location:</label>
                    <input type="text" id="project-location">
                </div>
                <button type="submit" class="btn">Create Project</button>
            </form>
        </div>
    </div>

    <div id="open-project-modal" class="modal">
        <div class="modal-content">
            <span class="close-btn">&times;</span>
            <h2>Open Project</h2>
            <div id="project-list">
                <!-- Project list will be populated dynamically -->
            </div>
        </div>
    </div>

    <div id="edit-properties-modal" class="modal">
        <div class="modal-content">
            <span class="close-btn">&times;</span>
            <h2>Edit Properties</h2>
            <form id="edit-properties-form">
                <div class="form-group">
                    <label for="facility-name">Facility Name:</label>
                    <input type="text" id="facility-name" required>
                </div>
                <div class="form-group">
                    <label for="facility-type">Facility Type:</label>
                    <select id="facility-type">
                        <option value="magazine">Magazine</option>
                        <option value="operating">Operating Building</option>
                        <option value="admin">Administration</option>
                        <option value="storage">Storage</option>
                    </select>
                </div>
                <div class="form-group">
                    <label for="explosive-amount">Explosive Amount (lbs):</label>
                    <input type="text" id="explosive-amount">
                </div>
                <button type="submit" class="btn">Save Properties</button>
            </form>
        </div>
    </div>

    <!-- Scripts -->
    <script src="https://unpkg.com/leaflet@1.9.4/dist/leaflet.js"></script>
    <script src="https://unpkg.com/leaflet-draw@1.0.4/dist/leaflet.draw.js"></script>
    <script>
        document.addEventListener('DOMContentLoaded', function() {
            // Initialize map
            const map = L.map('map').setView([39.8283, -98.5795], 5);

            // Add base layers
            const osmLayer = L.tileLayer('https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png', {
                attribution: '&copy; OpenStreetMap contributors'
            }).addTo(map);

            const satelliteLayer = L.tileLayer('https://server.arcgisonline.com/ArcGIS/rest/services/World_Imagery/MapServer/tile/{z}/{y}/{x}', {
                attribution: 'Tiles &copy; Esri &mdash; Source: Esri, i-cubed, USDA, USGS, AEX, GeoEye, Getmapping, Aerogrid, IGN, IGP, UPR-EGP, and the GIS User Community'
            });

            const baseLayers = {
                "OpenStreetMap": osmLayer,
                "Satellite": satelliteLayer
            };

            // Create layer groups
            const facilitiesLayer = L.layerGroup().addTo(map);
            const boundariesLayer = L.layerGroup().addTo(map);
            const qdzoneLayer = L.layerGroup().addTo(map);

            const overlays = {
                "Facilities": facilitiesLayer,
                "Boundaries": boundariesLayer,
                "QD Zones": qdzoneLayer
            };

            // Initialize draw control
            const drawnItems = new L.FeatureGroup();
            map.addLayer(drawnItems);

            const drawControl = new L.Control.Draw({
                draw: {
                    polygon: {
                        allowIntersection: false,
                        showArea: true
                    },
                    polyline: true,
                    rectangle: true,
                    circle: true,
                    marker: true,
                    circlemarker: false
                },
                edit: {
                    featureGroup: drawnItems
                }
            });

            // Setup modal handling
            const modals = document.querySelectorAll('.modal');
            const closeBtns = document.querySelectorAll('.close-btn');

            closeBtns.forEach(btn => {
                btn.addEventListener('click', function() {
                    modals.forEach(modal => {
                        modal.style.display = "none";
                    });
                });
            });

            window.addEventListener('click', function(event) {
                modals.forEach(modal => {
                    if (event.target == modal) {
                        modal.style.display = "none";
                    }
                });
            });

            // Setup menu item handlers
            document.getElementById('new-project').addEventListener('click', function() {
                document.getElementById('new-project-modal').style.display = "block";
            });

            document.getElementById('open-project').addEventListener('click', function() {
                // Fetch and display projects
                fetch('/api/projects')
                    .then(response => response.json())
                    .then(data => {
                        const projectList = document.getElementById('project-list');
                        projectList.innerHTML = '';

                        if(data.projects && data.projects.length > 0) {
                            data.projects.forEach(project => {
                                const projectItem = document.createElement('div');
                                projectItem.textContent = project.name;
                                projectItem.classList.add('project-item');
                                projectItem.addEventListener('click', function() {
                                    loadProject(project.id);
                                    document.getElementById('open-project-modal').style.display = "none";
                                });
                                projectList.appendChild(projectItem);
                            });
                        } else {
                            projectList.innerHTML = '<p>No projects found</p>';
                        }
                    })
                    .catch(error => {
                        console.error('Error fetching projects:', error);
                        alert('Error loading projects');
                    });

                document.getElementById('open-project-modal').style.display = "block";
            });

            document.getElementById('save-project').addEventListener('click', function() {
                saveProject();
            });

            // Draw control event handlers
            map.on('draw:created', function(e) {
                const layer = e.layer;
                drawnItems.addLayer(layer);

                // Open edit properties modal
                document.getElementById('edit-properties-modal').style.display = "block";

                // Store reference to current layer being edited
                window.currentEditLayer = layer;
            });

            document.getElementById('edit-properties-form').addEventListener('submit', function(e) {
                e.preventDefault();

                if(window.currentEditLayer) {
                    const facilityName = document.getElementById('facility-name').value;
                    const facilityType = document.getElementById('facility-type').value;
                    const explosiveAmount = document.getElementById('explosive-amount').value;

                    // Store properties with the layer
                    window.currentEditLayer.properties = {
                        name: facilityName,
                        type: facilityType,
                        explosiveAmount: explosiveAmount
                    };

                    // Add a popup to the layer
                    window.currentEditLayer.bindPopup(
                        `<b>${facilityName}</b><br>
                        Type: ${facilityType}<br>
                        Explosive Amount: ${explosiveAmount} lbs`
                    );

                    // Close the modal
                    document.getElementById('edit-properties-modal').style.display = "none";
                }
            });

            // Add event listener for layers toggle button
            const toggleLayersBtn = document.getElementById('toggle-layers-btn');
            const layerPanel = document.getElementById('layer-panel');
            toggleLayersBtn.addEventListener('click', () => {
                layerPanel.style.display = layerPanel.style.display === 'none' ? 'block' : 'none';
            });


            // Initialize the UI
            console.log("Map initialized successfully");
        });

        function saveProject() {
            // Get all layers and their properties
            const layerData = {
                facilities: [],
                boundaries: [],
                qdzones: []
            };

            // TODO: Implement gathering layer data from the map

            fetch('/api/save_project', {
                method: 'POST',
                headers: {
                    'Content-Type': 'application/json'
                },
                body: JSON.stringify(layerData)
            })
            .then(response => response.json())
            .then(data => {
                if(data.success) {
                    alert('Project saved successfully');
                } else {
                    alert('Error saving project: ' + data.error);
                }
            })
            .catch(error => {
                console.error('Error saving project:', error);
                alert('Error saving project');
            });
        }

        function loadProject(projectId) {
            fetch(`/api/load_project/${projectId}`)
                .then(response => response.json())
                .then(data => {
                    if(data.success) {
                        // Clear existing layers
                        // TODO: Implement clearing and loading project data

                        alert('Project loaded successfully');
                    } else {
                        alert('Error loading project: ' + data.error);
                    }
                })
                .catch(error => {
                    console.error('Error loading project:', error);
                    alert('Error loading project');
                });
        }
    </script>
</body>
</html>